{% extends "layouts/base_doctor.html" %}

{% block content %}
<div class="fixed inset-0 top-16 flex bg-slate-100 overflow-hidden">
    
    <aside class="w-64 flex flex-col bg-white border-r border-slate-200 z-10">
        <ul id="patient-list-container" class="flex-1 overflow-y-auto divide-y divide-slate-50">
            {% include "web_doctor/partials/patient_list.html" %}
        </ul>
    </aside>

    <main id="main-content" class="flex-1 flex flex-col min-w-0 bg-white relative z-100">
        <div class="flex-1 flex flex-col items-center justify-center text-center px-6 text-slate-600">
            <p class="text-2xl font-semibold text-slate-800 mb-3">
                感谢奋斗在一线的医护人员 {{ workspace_display_name }}
            </p>
            <p class="text-slate-600 leading-relaxed max-w-3xl">
                我们将持续为您提供更高效的工作台与管理工具，让守护生命的每一刻都更从容。
            </p>
            <p class="mt-6 text-slate-400 text-sm">
                请先从左侧患者列表中选择一位患者，进入详细管理页面。
            </p>
        </div>
    </main>

    <aside class="w-80 flex flex-col border-l border-slate-200 bg-white shrink-0 z-10">
        {% include "web_doctor/partials/todo_list_sidebar.html" %}

        <div class="h-1/2 flex flex-col">
            <div class="px-4 py-3 border-b border-slate-50 bg-slate-50/50">
                <h3 class="font-semibold text-slate-700 text-sm">医患沟通</h3>
            </div>
            <div class="flex-1 flex items-center justify-center text-slate-300 text-sm">
                聊天模块占位
            </div>
        </div>
    </aside>

</div>

<!-- 确保页面中有 CSRF Token 供 JS 使用 -->
{% csrf_token %}

<!-- 引入 jQuery (必需，且必须在组件之前引入) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- 引入待办事项弹框组件 -->
{% include "components/todo_modal.html" %}

<script>
    // 监听跨页面消息，当待办事项更新时自动刷新首页数据
    (function() {
        // 1. 监听 BroadcastChannel (用于多标签页)
        const channel = new BroadcastChannel('app-events');
        channel.onmessage = function(event) {
            if (event.data && event.data.type === 'todo-updated') {
                console.log('收到待办更新通知，正在刷新页面...');
                window.location.reload();
            }
        };

        // 2. 监听 pageshow 事件 (用于处理浏览器后退/缓存恢复)
        window.addEventListener('pageshow', function(event) {
            // 检查是否有未处理的刷新标记
            if (sessionStorage.getItem('todo_needs_refresh') === 'true') {
                console.log('检测到数据变更标记，正在刷新页面...');
                sessionStorage.removeItem('todo_needs_refresh');
                window.location.reload();
            }
        });
    })();
</script>

{% endblock %}
