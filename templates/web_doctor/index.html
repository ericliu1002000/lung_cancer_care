{% extends "layouts/base_doctor.html" %}

{% block content %}
<div class="fixed inset-0 top-16 flex bg-slate-100 overflow-hidden">
    
    <aside class="w-64 flex flex-col bg-white border-r border-slate-200 z-10">
        <div class="px-3 py-3 border-b border-slate-200 bg-white">
            <div class="flex items-center gap-2">
                <input
                    id="patient-search-input"
                    type="text"
                    class="w-full h-9 px-3 text-sm border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-200 focus:border-indigo-300"
                    placeholder="患者姓名/手机号"
                    autocomplete="off"
                />
               
            </div>
            <div class="flex items-center justify-end mt-2 ">
                 <button
                    id="patient-search-btn"
                    type="button"
                    class="mr-2 h-9 px-3 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition"
                >
                    搜索
                </button>
                <button
                    id="patient-search-reset"
                    type="button"
                    class="h-9 px-3 text-sm bg-white text-slate-600 border border-slate-200 rounded-md hover:bg-slate-50 transition"
                >
                    重置
                </button>
            </div>
        </div>
        <ul id="patient-list-container" class="flex-1 overflow-y-auto divide-y divide-slate-50">
            {% include "web_doctor/partials/patient_list.html" %}
        </ul>
    </aside>

    <main id="main-content" class="flex-1 flex flex-col min-w-0 bg-white relative z-100">
        <div class="flex-1 flex flex-col items-center justify-center text-center px-6 text-slate-600">
            <p class="text-2xl font-semibold text-slate-800 mb-3">
                感谢奋斗在一线的医护人员 {{ workspace_display_name }}
            </p>
            <p class="text-slate-600 leading-relaxed max-w-3xl">
                我们将持续为您提供更高效的工作台与管理工具，让守护生命的每一刻都更从容。
            </p>
            <p class="mt-6 text-slate-400 text-sm">
                请先从左侧患者列表中选择一位患者，进入详细管理页面。
            </p>
        </div>
    </main>

    <aside class="w-80 flex flex-col border-l border-slate-200 bg-white shrink-0 z-10">
        <div class="flex flex-col h-full min-h-0">
            {% include "web_doctor/partials/todo_list_sidebar.html" %}

            <div class="flex-1 min-h-0">
                {% include "web_doctor/partials/chat.html" %}
            </div>
        </div>
    </aside>

</div>

<!-- 确保页面中有 CSRF Token 供 JS 使用 -->
{% csrf_token %}

<!-- 引入 jQuery (必需，且必须在组件之前引入) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- 引入待办事项弹框组件 -->
{% include "components/todo_modal.html" %}

<script>
    // 监听跨页面消息，当待办事项更新时自动刷新首页数据
    (function() {
        // 1. 监听 BroadcastChannel (用于多标签页)
        const channel = new BroadcastChannel('app-events');
        channel.onmessage = function(event) {
            if (event.data && event.data.type === 'todo-updated') {
                console.log('收到待办更新通知，正在刷新页面...');
                window.location.reload();
            }
        };

        // 2. 监听 pageshow 事件 (用于处理浏览器后退/缓存恢复)
        window.addEventListener('pageshow', function(event) {
            // 处理从待办列表页回退后的“跳转到指标”意图
            try {
                const pendingJumpRaw = sessionStorage.getItem('todo_pending_jump');
                if (pendingJumpRaw) {
                    sessionStorage.removeItem('todo_pending_jump');
                    sessionStorage.removeItem('todo_needs_refresh');
                    const pendingJump = JSON.parse(pendingJumpRaw);
                    if (pendingJump && pendingJump.action === 'indicators' && window.goToPatientIndicators) {
                        window.goToPatientIndicators({ patientId: pendingJump.patientId, query: pendingJump.query });
                        return;
                    }
                }
            } catch (e) {}

            // 检查是否有未处理的刷新标记
            if (sessionStorage.getItem('todo_needs_refresh') === 'true') {
                console.log('检测到数据变更标记，正在刷新页面...');
                sessionStorage.removeItem('todo_needs_refresh');
                window.location.reload();
            }
        });
    })();
</script>

{% endblock %}
