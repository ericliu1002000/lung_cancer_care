<div x-data="{
    isOpen: false,
    isSaving: false,
    formData: {
        record_type: '',
        report_date: '',
        hospital: '',
        remarks: ''
    },
    files: [], // Array of {file, preview, category, subcategory}
    errors: {},
    isDragging: false,
    
    // Constants
    categories: ['门诊', '住院', '复查'],
    subcategories: [
        '血常规', '血生化', '胸部CT', '骨扫描', '头颅MR', 
        '心脏彩超', '心电图', '凝血功能', '甲状腺功能', 
        '肿瘤评估', '肿瘤标志物', '其他'
    ],
    searchQuery: '', // For secondary select filtering

    init() {
        const today = new Date().toISOString().split('T')[0];
        this.formData.report_date = today;
    },

    openModal(type) {
        this.isOpen = true;
        this.resetForm();
        if (type) {
            this.formData.record_type = type;
        }
        const today = new Date().toISOString().split('T')[0];
        this.formData.report_date = today;
    },

    resetForm() {
        this.formData = {
            record_type: '',
            report_date: '',
            hospital: '',
            remarks: ''
        };
        this.files = [];
        this.errors = {};
        this.isSaving = false;
        this.isDragging = false;
    },

    handleFileSelect(event) {
        const selectedFiles = Array.from(event.target.files);
        this.processFiles(selectedFiles);
        event.target.value = ''; // Reset input
    },

    handleDrop(event) {
        this.isDragging = false;
        const droppedFiles = Array.from(event.dataTransfer.files);
        this.processFiles(droppedFiles);
    },

    processFiles(newFiles) {
        // Validate file types and sizes immediately
        const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        const maxSize = 10 * 1024 * 1024; // 10MB

        newFiles.forEach(file => {
            if (!validImageTypes.includes(file.type)) {
                alert(`文件 ${file.name} 不是有效的图片格式`);
                return;
            }
            if (file.size > maxSize) {
                alert(`文件 ${file.name} 超过10MB限制`);
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                this.files.push({
                    file: file,
                    preview: e.target.result,
                    category: '',
                    subcategory: '',
                    searchOpen: false, // For custom select
                    searchText: ''     // For custom select
                });
            };
            reader.readAsDataURL(file);
        });
        
        if (this.errors.images) {
            delete this.errors.images;
        }
    },

    removeFile(index) {
        if (confirm('确认删除这张图片吗？')) {
            this.files.splice(index, 1);
        }
    },

    validate() {
        this.errors = {};
        let isValid = true;

        // 1. Record Type
        if (!this.formData.record_type) {
            this.errors.record_type = '必须选择记录类型';
            isValid = false;
        }

        // 2. Report Date
        if (!this.formData.report_date) {
            this.errors.report_date = '必须选择报告日期';
            isValid = false;
        }

        // 3. Remarks (Required + Length Limit)
        if (!this.formData.remarks || !this.formData.remarks.trim()) {
            this.errors.remarks = '内容不能为空';
            isValid = false;
        } else if (this.formData.remarks.length > 500) {
            this.errors.remarks = '备注内容不能超过500字符';
            isValid = false;
        }

        // 4. Images
        if (this.files.length === 0) {
            this.errors.images = '至少上传一张图片';
            isValid = false;
        } else {
            // Check image categories
            let missingCategories = false;
            let missingSubcategories = false;

            for (let i = 0; i < this.files.length; i++) {
                const f = this.files[i];
                if (!f.category) {
                    missingCategories = true;
                    break;
                }
                if (f.category === '复查' && !f.subcategory) {
                    missingSubcategories = true;
                    break;
                }
            }

            if (missingCategories) {
                this.errors.images = '请为所有图片选择类目';
                isValid = false;
            } else if (missingSubcategories) {
                this.errors.images = '复查类目必须选择二级分类';
                isValid = false;
            }
        }

        return isValid;
    },

    save() {
        if (!this.validate()) return;

        this.isSaving = true;

        setTimeout(() => {
            const submissionData = {
                ...this.formData,
                images: this.files.map(f => ({
                    name: f.file.name,
                    category: f.category,
                    subcategory: f.subcategory
                }))
            };
            
            console.log('=== 模拟保存接口调用 ===');
            console.log('表单数据:', submissionData);
            
            // Show success message (optional, or just close)
            // alert('保存成功！');
            
            this.isOpen = false;
            this.isSaving = false;
        }, 1000);
    }
}" 
     x-show="isOpen" 
     @open-record-modal.window="openModal($event.detail.type)"
     class="relative z-50" 
     aria-labelledby="modal-title" 
     role="dialog" 
     aria-modal="true"
     style="display: none;">
    
    <!-- Background backdrop -->
    <div x-show="isOpen" 
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <!-- Modal panel -->
            <div x-show="isOpen"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-5xl">
                
                <!-- Header -->
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-0 border-b border-transparent">
                    <h3 class="text-xl font-bold leading-6 text-slate-800 text-center mb-4" id="modal-title">新增记录</h3>
                    <div class="border-b border-slate-200 w-full"></div>
                </div>

                <!-- Body -->
                <div class="bg-white px-4 py-6 sm:p-6">
                    
                    <!-- Top Row: Type, Date, Hospital -->
                    <div class="flex flex-wrap gap-x-6 gap-y-4 items-start mb-6 border-b border-slate-100 pb-6">
                        <!-- Record Type -->
                        <div class="flex items-center gap-2">
                            <label for="record_type" class="text-sm font-bold text-slate-700 whitespace-nowrap relative">
                                记录类型
                                <span class="text-red-500 absolute -top-1 -right-2">*</span>
                            </label>
                            <div class="relative ml-2">
                                <select id="record_type" x-model="formData.record_type" 
                                        :class="{'border-red-500': errors.record_type}"
                                        class="block w-32 rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-1.5 px-3 border bg-white">
                                    <option value="">请选择</option>
                                    <template x-for="cat in categories" :key="cat">
                                        <option :value="cat" x-text="cat"></option>
                                    </template>
                                </select>
                                <p x-show="errors.record_type" class="absolute left-0 -bottom-5 text-xs text-red-500 whitespace-nowrap" x-text="errors.record_type"></p>
                            </div>
                        </div>

                        <!-- Report Date -->
                        <div class="flex items-center gap-2">
                            <label for="report_date" class="text-sm font-bold text-slate-700 whitespace-nowrap relative">
                                报告日期
                                <span class="text-red-500 absolute -top-1 -right-2">*</span>
                            </label>
                            <div class="relative ml-2">
                                <input type="date" id="report_date" x-model="formData.report_date"
                                       :class="{'border-red-500': errors.report_date}"
                                       class="block w-40 rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-1.5 px-3 border">
                                <p x-show="errors.report_date" class="absolute left-0 -bottom-5 text-xs text-red-500 whitespace-nowrap" x-text="errors.report_date"></p>
                            </div>
                        </div>

                        <!-- Hospital -->
                        <div class="flex items-center gap-2 flex-grow">
                            <label for="hospital" class="text-sm font-bold text-slate-700 whitespace-nowrap">医院</label>
                            <div class="relative w-full ml-1">
                                <input type="text" id="hospital" x-model="formData.hospital"
                                       :class="{'border-red-500': errors.hospital}"
                                       class="block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-1.5 px-3 border">
                                <p x-show="errors.hospital" class="absolute left-0 -bottom-5 text-xs text-red-500 whitespace-nowrap" x-text="errors.hospital"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Images Upload Area -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-slate-700 mb-2 relative w-fit">
                            报告图片
                            <span class="text-red-500 absolute -top-1 -right-2">*</span>
                        </label>
                        
                        <!-- Drag & Drop Zone -->
                        <div 
                            @dragover.prevent="isDragging = true"
                            @dragleave.prevent="isDragging = false"
                            @drop.prevent="handleDrop($event)"
                            class="relative border-2 border-dashed rounded-lg p-6 flex flex-col items-center justify-center transition-colors cursor-pointer mb-4"
                            :class="isDragging ? 'border-indigo-500 bg-indigo-50' : 'border-slate-300 hover:bg-slate-50'"
                            @click="$refs.fileInput.click()"
                        >
                            <input type="file" x-ref="fileInput" @change="handleFileSelect" multiple accept="image/*" class="hidden">
                            
                            <svg class="w-10 h-10 text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="text-sm text-slate-600">点击上传或拖拽图片到此处</p>
                            <p class="text-xs text-slate-400 mt-1">支持多张图片同时上传 (单张不超过10MB)</p>
                            
                            <span x-show="errors.images" class="text-xs text-red-500 mt-2 font-bold" x-text="errors.images"></span>
                        </div>

                        <!-- Image List -->
                        <div class="flex flex-col gap-4 max-h-[400px] overflow-y-auto pr-2" x-show="files.length > 0">
                            <template x-for="(file, index) in files" :key="index">
                                <div class="flex flex-col sm:flex-row gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200 relative group transition-all duration-200"
                                     :class="{'border-red-300 bg-red-50': errors.images && (!file.category || (file.category === '复查' && !file.subcategory))}">
                                    
                                    <!-- Delete Button (Absolute Top Right) -->
                                    <button 
                                        @click.stop="removeFile(index)" 
                                        type="button" 
                                        title="删除"
                                        class="absolute top-2 right-2 p-1 bg-white rounded-full shadow hover:bg-red-50 transition-colors z-10"
                                    >
                                        <svg class="w-6 h-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>

                                    <!-- Image Preview -->
                                    <div class="w-full sm:w-32 h-32 flex-shrink-0 bg-white rounded border border-slate-200 overflow-hidden">
                                        <img :src="file.preview" class="w-full h-full object-cover">
                                    </div>

                                    <!-- File Info & Categories -->
                                    <div class="flex-grow flex flex-col justify-center gap-3">
                                        <div class="text-sm font-medium text-slate-800 truncate" x-text="file.file.name"></div>
                                        
                                        <!-- Category Selection Row -->
                                        <div class="flex flex-wrap items-center gap-3">
                                            <!-- Primary Category -->
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm font-bold text-slate-600">类目:</span>
                                                <select x-model="file.category" class="block w-32 rounded border-slate-300 text-sm py-1.5 pl-2 pr-8 focus:ring-indigo-500 focus:border-indigo-500 border ">
                                                    <option value="">请选择</option>
                                                    <template x-for="cat in categories" :key="cat">
                                                        <option :value="cat" x-text="cat"></option>
                                                    </template>
                                                </select>
                                            </div>

                                            <!-- Secondary Category (Searchable) - Only show if '复查' (Checkup) -->
                                            <div x-show="file.category === '复查'" class="flex items-center gap-2 relative" @click.outside="file.searchOpen = false">
                                                <!-- Custom Select Trigger/Input -->
                                                <div class="relative w-48">
                                                    <input 
                                                        type="text" 
                                                        placeholder="选择检查项目..."
                                                        x-model="file.subcategory"
                                                        @focus="file.searchOpen = true; file.searchText = ''"
                                                        @input="file.searchOpen = true; file.searchText = $event.target.value"
                                                        class="block w-full rounded border-slate-300 text-sm py-1.5 pl-2 pr-8 focus:ring-indigo-500 focus:border-indigo-500 cursor-pointer"
                                                        :class="{'border-red-300 ring-1 ring-red-300': errors.images && !file.subcategory}"
                                                    >
                                                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                                        <svg class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                                        </svg>
                                                    </div>
                                                </div>

                                                <!-- Dropdown Options -->
                                                <ul 
                                                    x-show="file.searchOpen" 
                                                    class="absolute z-20 mt-1 w-48 bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm top-full left-0"
                                                    style="display: none;"
                                                >
                                                    <template x-for="sub in subcategories.filter(s => s.toLowerCase().includes((file.searchText || '').toLowerCase()))" :key="sub">
                                                        <li 
                                                            @click="file.subcategory = sub; file.searchOpen = false"
                                                            class="text-slate-900 cursor-default select-none relative py-2 pl-3 pr-9 hover:bg-indigo-50 cursor-pointer"
                                                        >
                                                            <span x-text="sub" class="block truncate" :class="file.subcategory === sub ? 'font-semibold' : 'font-normal'"></span>
                                                            <span x-show="file.subcategory === sub" class="text-indigo-600 absolute inset-y-0 right-0 flex items-center pr-4">
                                                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                                </svg>
                                                            </span>
                                                        </li>
                                                    </template>
                                                    <li x-show="subcategories.filter(s => s.toLowerCase().includes((file.searchText || '').toLowerCase())).length === 0" class="text-slate-500 cursor-default select-none relative py-2 pl-3 pr-9 italic">
                                                        无匹配项
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Remarks -->
                    <div class="mb-2">
                        <label for="remarks" class="block text-sm font-bold text-slate-700 mb-2 relative w-fit">
                            备注
                            <span class="text-red-500 absolute -top-1 -right-2">*</span>
                        </label>
                        <div class="relative">
                            <textarea id="remarks" rows="4" x-model="formData.remarks"
                                      :class="{'border-red-500': errors.remarks}"
                                      class="block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2 px-3 border bg-slate-50 resize-none"></textarea>
                            <p x-show="errors.remarks" class="absolute left-0 -bottom-5 text-xs text-red-500" x-text="errors.remarks"></p>
                            <div class="text-right text-xs text-slate-400 mt-1" :class="{'text-red-500': (formData.remarks || '').length > 500}">
                                <span x-text="(formData.remarks || '').length"></span>/500
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-white px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-slate-100 gap-3">
                    <button type="button" @click="save" 
                            :disabled="isSaving || !formData.record_type"
                            :class="(!formData.record_type) ? 'opacity-50 cursor-not-allowed text-white bg-indigo-600 ' : 'text-white bg-indigo-600 hover:bg-indigo-700 border-transparent ring-1 ring-inset ring-slate-300'"
                            class="inline-flex w-full justify-center rounded px-6 py-1.5 text-sm font-medium shadow-sm sm:w-auto transition-colors">
                        <span x-show="!isSaving">保存</span>
                        <span x-show="isSaving">保存中...</span>
                    </button>
                    <button type="button" @click="isOpen = false" 
                            class="mt-3 inline-flex w-full justify-center rounded border border-slate-300 bg-white px-6 py-1.5 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 sm:mt-0 sm:w-auto transition-colors">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
