<div id="indicators-container" class="bg-white rounded-t-xl shadow-sm border border-slate-200 overflow-hidden p-4">
        <div class="flex items-center justify-between mb-6 relative">
        <h3 class="text-base font-bold text-slate-800 border-l-4 border-indigo-500 pl-3">常规监测指标</h3>
        
        <!-- 筛选表单区域 -->
        <form id="routine-filter-form" 
              class="flex items-center gap-4 text-sm relative" 
              onsubmit="return false;"
              x-data="{ 
                  filterType: '{{ current_filter_type|default:'cycle' }}',
                  updateDatesFromCycle(event) {
                      const select = event.target;
                      const option = select.options[select.selectedIndex];
                      const start = option.getAttribute('data-start') || '';
                      const end = option.getAttribute('data-end') || '';
                      
                      const startInput = document.getElementById('routine_start_date');
                      const endInput = document.getElementById('routine_end_date');
                      
                      if (startInput) startInput.value = start;
                      if (endInput) endInput.value = end;
                  }
              }"
        >
            <!-- 筛选条件选择 --> 
            <div class="flex items-center gap-2">
                <input type="hidden" name="filter_type" x-model="filterType">
                <span class="text-slate-600">筛选条件:</span>
                <select x-model="filterType" class="border border-slate-300 rounded px-2 py-1 text-slate-700 focus:outline-none focus:border-indigo-500">
                    <option value="cycle">按疗程选择</option>
                    <option value="date">按日期查看</option>
                </select>
            </div>

            <!-- 按疗程选择 -->
            <div class="flex items-center gap-2" x-show="filterType === 'cycle'" x-cloak>
                <select name="cycle_id" 
                        :disabled="filterType !== 'cycle'"
                        @change="updateDatesFromCycle($event)"
                        class="border border-slate-300 rounded px-2 py-1 text-slate-700 focus:outline-none focus:border-indigo-500 min-w-[300px]">
                    {% for cycle in treatment_cycles %}
                    <option value="{{ cycle.id }}" 
                            data-start="{{ cycle.start_date|date:'Y-m-d' }}" 
                            data-end="{% if cycle.end_date %}{{ cycle.end_date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}"
                            {% if cycle.id == current_cycle_id %}selected{% endif %}>
                        {{ cycle.name }} ({{ cycle.start_date|date:"Y/m/d" }} - {{ cycle.end_date|date:"Y/m/d"|default:"至今" }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- 按日期查看 -->
            <div class="flex items-center gap-2" x-show="filterType === 'date'" x-cloak>
                <div class="flex items-center border border-slate-300 rounded px-2 py-1 bg-white">
                                        <input placeholder="开始日期" type="date" name="start_date" id="routine_start_date" value="{{ current_start_date }}" class="focus:outline-none text-slate-700 date-input">
                    <span class="text-slate-400 mx-1">-</span>
                                        <input placeholder="结束日期" type="date" name="end_date" id="routine_end_date" value="{{ current_end_date }}" class="focus:outline-none text-slate-700 date-input">

                </div>
            </div>

            <!-- 按钮组 -->
            <div class="flex items-center gap-2" x-show="filterType !== ''" x-cloak>
                <button 
                    hx-get="{% url 'web_doctor:patient_workspace_section' patient.id 'indicators' %}"
                    hx-target="#indicators-wrapper"
                    hx-swap="outerHTML"
                    hx-include="#routine-filter-form"
                    class="ml-3 px-4 lg:px-6 py-1.5 bg-indigo-600 text-white text-sm rounded-[4px] hover:bg-indigo-700 shadow-sm transition-colors cursor-pointer">
                    搜索
                </button>
            </div>
             {% if is_default_view %}
        <div class="absolute top-0 right-4 mt-14 text-indigo-600 font-medium hover:text-indigo-800" x-show="filterType === ''">
            最近30天
        </div>
        {% endif %}
        </form>
    </div>

    <!-- Medication Record -->
    <div class="bg-white p-4 rounded-lg shadow-sm ">
        <div class="flex items-center gap-2 mb-4">
             <svg
                t="1765679457106"
                class="icon w-5 h-5"
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="22091"
                width="32"
                height="32"
              >
                <path
                  d="M902.4 121.6c-51.2-51.2-121.6-76.8-192-76.8s-140.8 25.6-192 76.8L121.6 512c-108.8 108.8-108.8 281.6 0 384 51.2 51.2 121.6 76.8 192 76.8s140.8-25.6 192-76.8l396.8-384c51.2-51.2 76.8-121.6 76.8-192 0-76.8-25.6-147.2-76.8-198.4zM480 870.4c-44.8 44.8-102.4 70.4-166.4 70.4s-121.6-25.6-166.4-70.4C57.6 780.8 57.6 633.6 147.2 537.6l179.2-179.2 332.8 332.8-179.2 179.2z m364.8-665.6c-6.4 6.4-19.2 6.4-25.6 0-32-32-70.4-44.8-108.8-44.8-44.8 0-83.2 19.2-108.8 44.8l-121.6 128c-12.8 0-19.2 6.4-19.2 6.4-6.4 0-12.8 0-12.8-6.4-6.4-6.4-6.4-19.2 0-25.6l128-128c38.4-38.4 83.2-57.6 140.8-57.6 51.2 0 102.4 19.2 140.8 57.6-6.4 6.4-6.4 19.2-12.8 25.6z"
                  fill="#1684FC"
                  p-id="22092"
                ></path>
              </svg>
            <div class="font-medium text-black ">服药记录 ({{ medication_stats.count }}次) 
                <span class="font-medium text-black ml-3">依从性：{{ medication_stats.compliance }}%</span>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-center border-collapse">
                <tbody>
                    <tr>
                        <td class="p-2 border border-slate-200 bg-slate-50 font-medium min-w-20">是否服药</td>
                        {% for record in medication_data %}
                        <td class="p-1 border border-slate-200 min-w-[30px]">
                            {% if record.date > current_date %}
                            <div class="w-6 h-6 bg-transparent rounded-full mx-auto"></div>
                            {% elif record.taken %}
                            <div class="w-6 h-6 bg-green-500 rounded-full text-white flex items-center justify-center mx-auto">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                            {% else %}
                            <div class="w-6 h-6 bg-red-500 rounded-full text-white flex items-center justify-center mx-auto">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td class="p-2 border border-slate-200 bg-slate-50 font-medium">日期</td>
                        {% for record in medication_data %}
                        <td class="p-1 border border-slate-200 text-xs text-slate-500">
                            {{ record.display_date }}
                        </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="space-y-6">
        {% include "web_doctor/partials/indicators/chart.html" with chart=charts.spo2 %}
        {% include "web_doctor/partials/indicators/chart.html" with chart=charts.bp %}
        {% include "web_doctor/partials/indicators/chart.html" with chart=charts.hr %}
        {% include "web_doctor/partials/indicators/chart.html" with chart=charts.weight %}
        {% include "web_doctor/partials/indicators/chart.html" with chart=charts.temp %}
        {% include "web_doctor/partials/indicators/chart.html" with chart=charts.steps %}
    </div>
</div> 
