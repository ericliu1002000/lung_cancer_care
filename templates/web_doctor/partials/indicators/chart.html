<!-- Chart Component -->
<div class="bg-white p-4 rounded-lg shadow-sm ">
    <div class="flex items-center gap-2 mb-4">
        <!-- Icon placeholder -->
        <h3 class="font-medium text-slate-800">{{ chart.title }}</h3>
        <span class="text-sm text-slate-500 font-medium">{{ chart.subtitle }}</span>
    </div>
    
    <div id="{{ chart.id }}" style="width: 100%; height: 250px;"></div>
</div>

<script>
    (function() {
        var chartId = '{{ chart.id }}';
        var chartData = {{ chart.dates|safe }};
        var seriesData = [
            {% for s in chart.series %}
            {
                name: '{{ s.name }}',
                type: 'line',
                smooth: true,
                symbol: 'circle',
                symbolSize: 6,
                itemStyle: {
                    color: '{{ s.color }}'
                },
                data: {{ s.data|safe }}
            },
            {% endfor %}
        ];
        var yMin = {{ chart.y_min }};
        var yMax = {{ chart.y_max }};

        // Retry mechanism to ensure ECharts is loaded
        var maxRetries = 20; // 2 seconds max
        var retryCount = 0;

        function initChart() {
            if (typeof echarts === 'undefined') {
                if (retryCount < maxRetries) {
                    retryCount++;
                    setTimeout(initChart, 100);
                } else {
                    console.error('ECharts library not loaded.');
                }
                return;
            }

            var chartDom = document.getElementById(chartId);
            if (!chartDom) return;

            var myChart = echarts.init(chartDom);
            var option = {
                tooltip: {
                    trigger: 'axis'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: chartData,
                    axisLine: {
                        lineStyle: {
                            color: '#94a3b8'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    min: yMin,
                    max: yMax,
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f1f5f9'
                        }
                    }
                },
                series: seriesData
            };

            myChart.setOption(option);
            
            // Resize chart on window resize
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }

        // Start initialization
        initChart();
    })();
</script>