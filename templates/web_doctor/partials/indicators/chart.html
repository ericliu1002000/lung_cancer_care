<!-- Chart Component -->
<div class="bg-white p-4 rounded-lg shadow-sm ">
    <div class="flex items-center gap-2 mb-4">
        {% if chart.id == "chart-spo2" %}
               <svg
                class="w-5 h-5 text-cyan-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
                />
              </svg>
          {% elif chart.id == "chart-bp" %}
               <svg
                class="w-5 h-5 text-purple-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                />
              </svg>
             {% elif chart.id == "chart-hr" %}
             <svg
                t="1765679809370"
                class="icon w-6 h-6"
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="30291"
                width="48"
                height="48"
              >
                <path
                  d="M540.8 185.6c-3.2-12.8-16-25.6-28.8-25.6-16 0-32 12.8-32 32V435.2c-6.4 35.2-44.8 60.8-102.4 60.8-16 0-32 12.8-32 32s12.8 32 32 32h32c41.6-6.4 80-22.4 102.4-51.2l3.2-3.2 3.2 3.2c28.8 32 76.8 48 131.2 48 16 0 32-12.8 32-32s-12.8-32-32-32c-60.8 0-102.4-28.8-102.4-67.2V192l-6.4-6.4zM611.2 288c12.8-9.6 25.6-12.8 41.6-9.6h9.6l9.6 3.2c76.8 22.4 160 105.6 192 284.8 25.6 134.4 22.4 220.8-9.6 268.8-12.8 19.2-28.8 28.8-48 32h-9.6c-16 0-35.2-6.4-44.8-12.8-35.2 3.2-70.4 3.2-105.6-3.2-51.2-12.8-86.4-38.4-92.8-80-6.4-41.6-9.6-89.6-6.4-166.4 0-19.2 16-32 32-32s28.8 16 28.8 35.2v38.4c0 51.2 0 86.4 6.4 115.2 6.4 28.8 73.6 41.6 137.6 32 6.4 0 12.8 0 19.2 3.2 9.6 6.4 22.4 9.6 28.8 9.6 3.2 0 3.2-3.2 6.4-6.4 19.2-25.6 22.4-92.8 0-217.6-16-89.6-48-153.6-89.6-195.2-25.6-25.6-48-38.4-64-41.6h-3.2l-3.2 3.2c-6.4 6.4-12.8 28.8-19.2 67.2-3.2 16-19.2 28.8-35.2 25.6-16-3.2-28.8-19.2-25.6-38.4 6.4-67.2 19.2-99.2 44.8-115.2z m-249.6-9.6c19.2-3.2 38.4 0 51.2 9.6 22.4 16 38.4 48 48 108.8 3.2 16-9.6 35.2-25.6 38.4-16 3.2-32-9.6-35.2-25.6-6.4-38.4-12.8-60.8-19.2-67.2l-3.2-3.2h-3.2c-16 3.2-38.4 16-64 41.6-41.6 41.6-73.6 105.6-89.6 195.2-22.4 124.8-19.2 192 0 217.6l6.4 6.4c6.4 0 19.2-3.2 28.8-9.6 6.4-3.2 12.8-6.4 19.2-3.2 64 9.6 134.4-3.2 137.6-32 6.4-35.2 9.6-80 6.4-153.6 0-19.2 12.8-32 28.8-32s32 12.8 32 32c3.2 80 0 128-6.4 166.4-9.6 44.8-41.6 70.4-92.8 80-35.2 6.4-70.4 6.4-102.4 3.2-16 6.4-32 12.8-51.2 12.8h-9.6c-19.2-3.2-35.2-12.8-48-32-32-44.8-35.2-134.4-9.6-268.8 35.2-185.6 124.8-265.6 201.6-284.8z"
                  fill="#0b988f"
                  p-id="30292"
                ></path>
              </svg>
             {% elif chart.id == "chart-weight" %}
              <svg
                class="w-5 h-5 text-emerald-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"
                />
              </svg>
             {% elif chart.id == "chart-temp" %}
               <svg
                t="1765679517010"
                class="icon w-6 h-6"
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="24205"
                width="32"
                height="32"
              >
                <path
                  d="M846.611917 85.510536c-59.643402-39.140439-139.895167-22.38994-178.919972 37.309744L341.052606 622.593817c-7.867178 12.038174-11.592013 31.724539-8.668427 45.816488l20.085454 96.674806L266.953981 895.961882c-12.363585 18.891256-7.082302 44.254923 11.799744 56.646138 18.885116 12.390191 44.193525 7.113001 56.561204-11.778254l84.470857-129.270179 99.121532-20.745487c14.048971-2.960425 30.577413-14.245446 38.444591-26.282596l326.637292-499.773538C923.014005 205.057259 906.247132 124.651998 846.611917 85.510536zM866.518293 253.290797 539.881001 753.064334c-4.828982 7.399527-16.636912 15.46932-25.25929 17.267269L390.907061 796.223297c-2.734274 0.569982-5.499248 0.047072-7.839549-1.474584-2.320858-1.542122-3.921309-3.879354-4.489244-6.603395l-25.749454-123.968429c-1.805112-8.654101 0.867764-22.718421 5.689582-30.116925l326.643432-499.774561c32.712029-50.059116 100.024088-64.095807 150.015665-31.28247C885.185444 135.813199 899.246695 203.243961 866.518293 253.290797zM774.693957 194.285938c-38.542828-25.302269-90.436732-14.480806-115.656113 24.118304l-14.263865 21.825075 37.60241 24.663726c7.603165 4.997827 9.743922 15.259542 4.780887 22.892383-4.999874 7.610328-15.249309 9.748015-22.858614 4.76656l-37.59013-24.681122-51.584865 78.9317 37.601386 24.662703c7.615445 5.01113 9.751085 15.258519 4.770653 22.87908-4.980431 7.621585-15.216563 9.756201-22.817682 4.774747l-37.615713-24.692379-51.577702 78.929654 37.589107 24.681122c3.704368 2.425236 6.230911 6.134721 7.123234 10.45205 0.902556 4.330632 0.069585 8.741082-2.351558 12.42703-4.981455 7.621585-15.232936 9.759271-22.838148 4.761444l-37.59627-24.679076-51.577702 78.929654 37.594223 24.664749c3.697205 2.426259 6.235005 6.149047 7.126304 10.467399 0.900509 4.316306 0.069585 8.741082-2.344395 12.426007-4.983501 7.606235-15.226796 9.741875-22.839171 4.747117L417.768849 587.568093l-10.570753 16.173354c-3.721765 5.705955-5.783727 16.544815-4.384867 23.214724l19.85214 95.576799c0.440022 2.113127 1.674129 3.919263 3.461845 5.105275 1.799996 1.167592 3.935636 1.572822 6.043646 1.1328l95.385441-19.953448c6.650467-1.38658 15.748682-7.614421 19.470447-13.319353l251.835655-385.320832C824.095088 271.575232 813.253158 219.583091 774.693957 194.285938z"
                  fill="#01B695"
                  p-id="24206"
                ></path>
                <path
                  d="M176.23277 179.806155c18.10024-1.804089 28.052916-11.755742 29.877471-29.877471-1.824555-17.188474-11.777231-26.694989-29.877471-28.519544-17.20894 1.824555-26.715455 11.33107-28.519544 28.519544C149.517315 168.050414 159.02383 178.002067 176.23277 179.806155L176.23277 179.806155zM176.23277 94.247524c34.397415 3.628644 53.410444 22.195511 57.039087 55.68116-3.628644 34.418904-22.641673 53.431933-57.039087 57.039087-33.506115-3.607154-52.072983-22.620184-55.68116-57.039087C124.159788 116.444059 142.727679 97.876168 176.23277 94.247524L176.23277 94.247524zM345.991082 110.544699c47.977711 2.715855 72.868611 15.405875 74.694189 38.026058-0.912789 14.493086-8.148587 22.195511-21.728884 23.086811-3.628644 0-9.060353-1.357927-16.297175-4.074805-12.688997-4.519943-24.912389-6.79066-36.668131-6.79066-41.654702 1.824555-63.383586 28.073382-65.186651 78.767971 2.715855 47.999201 24.444738 73.335239 65.186651 76.052117 11.755742 0 24.445762-3.162016 38.026058-9.506515 7.235798-3.607154 13.113669-5.432733 17.655102-5.432733 12.668531 0.912789 20.370956 9.061376 23.086811 24.444738-0.912789 24.445762-27.161616 37.113269-78.767971 38.026058-74.248028-4.519943-114.077152-46.174646-119.509884-124.942617C231.91393 158.543899 271.743054 115.976408 345.991082 110.544699L345.991082 110.544699z"
                  fill="#01B695"
                  p-id="24207"
                ></path>
              </svg>
              {% elif chart.id == "chart-steps" %}
              <svg t="1766760496612" class="icon w-6 h-6" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5336" width="48" height="48"><path d="M742.4 992h-12.8c-25.6 0-51.2-12.8-64-32l-281.6-307.2-6.4-6.4c-6.4-19.2-12.8-25.6-12.8-38.4 0-12.8 0-25.6 6.4-38.4l12.8-51.2-38.4 12.8c0 6.4 6.4 19.2 6.4 32s-6.4 19.2-6.4 32l-25.6 25.6c-12.8 12.8-19.2 12.8-32 19.2-19.2 6.4-44.8 6.4-64-6.4-12.8 0-19.2-12.8-32-19.2-6.4-6.4-12.8-19.2-12.8-32l-25.6-83.2c-6.4-19.2-6.4-38.4 6.4-57.6 6.4-19.2 19.2-32 38.4-44.8l12.8-6.4c19.2-6.4 134.4-57.6 236.8-102.4 32-12.8 51.2-25.6 51.2-25.6-6.4-6.4-12.8-19.2-19.2-25.6-19.2-25.6-25.6-44.8-25.6-70.4 0-38.4 19.2-70.4 44.8-96 25.6-25.6 57.6-38.4 96-38.4 25.6 0 51.2 12.8 70.4 25.6 19.2 12.8 38.4 38.4 44.8 57.6 6.4 25.6 6.4 51.2 6.4 76.8-6.4 25.6-19.2 44.8-38.4 64-19.2 19.2-32 25.6-51.2 32 12.8 6.4 19.2 19.2 25.6 38.4 6.4 19.2 12.8 44.8 6.4 64l-38.4 243.2 198.4 204.8c6.4 12.8 12.8 19.2 19.2 32 6.4 12.8 6.4 25.6 6.4 38.4 0 12.8-6.4 25.6-12.8 38.4-6.4 12.8-12.8 19.2-25.6 25.6-19.2 12.8-44.8 19.2-64 19.2zM435.2 428.8c6.4 0 12.8 0 19.2 6.4 6.4 12.8 12.8 25.6 12.8 32l-38.4 121.6V608l281.6 307.2c6.4 6.4 12.8 12.8 25.6 12.8s19.2 0 25.6-6.4c6.4 0 6.4-6.4 6.4-6.4 0-6.4 0-6.4 6.4-12.8v-12.8c0-6.4 0-6.4-6.4-12.8l-204.8-217.6c-6.4-6.4-12.8-19.2-6.4-25.6l44.8-262.4v-25.6c-12.8 0-12.8-6.4-25.6-12.8-6.4 0-6.4-6.4-6.4-6.4-6.4 0-12.8-6.4-19.2-6.4h-25.6s-19.2 6.4-51.2 19.2C403.2 377.6 256 441.6 243.2 448l-19.2 6.4c0 6.4-6.4 6.4-6.4 12.8v12.8l19.2 89.6 6.4 6.4h32l6.4-6.4v-6.4-6.4l-6.4-38.4c-6.4-12.8 6.4-25.6 19.2-32l128-51.2c0-6.4 6.4-6.4 12.8-6.4z m153.6-332.8c-19.2 0-32 6.4-44.8 19.2-12.8 12.8-25.6 32-25.6 51.2 0 12.8 6.4 25.6 12.8 38.4 6.4 12.8 19.2 19.2 32 25.6 12.8 6.4 25.6 6.4 38.4 6.4 12.8 0 25.6-6.4 32-19.2l19.2-38.4v-38.4c-6.4-12.8-12.8-19.2-25.6-32-12.8-6.4-19.2-12.8-38.4-12.8z" fill="#3662EC" p-id="5337"></path><path d="M307.2 921.6h-12.8l-140.8-44.8c-25.6-6.4-38.4-25.6-51.2-44.8-6.4-19.2-6.4-44.8 0-64 0-6.4 6.4-19.2 12.8-25.6s12.8-19.2 25.6-25.6c6.4-6.4 19.2-12.8 25.6-12.8h32l51.2 19.2 19.2-32c6.4-12.8 19.2-19.2 32-25.6 12.8-6.4 25.6 0 38.4 6.4 6.4 0 12.8 6.4 12.8 12.8l57.6 64c6.4 12.8 12.8 19.2 12.8 32s0 25.6-12.8 32l-32 51.2c6.4 19.2-6.4 32-25.6 44.8-12.8 6.4-25.6 12.8-44.8 12.8z m-121.6-160c-6.4 0-12.8 0-12.8 6.4l-6.4 6.4s0 6.4-6.4 6.4v19.2c0 6.4 6.4 6.4 12.8 12.8l134.4 44.8s6.4 0 12.8-6.4c6.4 0 6.4-6.4 12.8-12.8l32-51.2-44.8-51.2-32 57.6-102.4-32zM800 595.2c-12.8 0-25.6 0-38.4-6.4l-64-32S672 544 672 512l12.8-89.6c6.4-19.2 12.8-25.6 25.6-32 6.4-6.4 19.2-6.4 32 0l12.8 6.4 89.6 38.4c6.4 0 12.8 6.4 19.2 12.8 6.4 6.4 12.8 19.2 19.2 32 6.4 12.8 6.4 25.6 6.4 32 0 12.8 0 25.6-6.4 32-6.4 12.8-12.8 19.2-19.2 25.6-6.4 6.4-19.2 12.8-32 19.2-12.8 6.4-19.2 6.4-32 6.4z m-64-89.6l57.6 25.6h19.2c6.4 0 6.4 0 6.4-6.4s6.4-6.4 6.4-6.4V512v-6.4s0-6.4-6.4-6.4l-6.4-6.4-70.4-32-6.4 44.8z m-19.2-6.4c6.4 0 0 0 0 0z m6.4-51.2z" fill="#3662EC" p-id="5338"></path></svg>
            {% else %}
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none w-3 h-3" stroke="currentColor" stroke-width="2" class="w-full h-full text-slate-400">
                    <line x1="21" y1="10" x2="3" y2="10"></line>
                    <line x1="21" y1="6" x2="3" y2="6"></line>
                </svg>
            {% endif %}
        <h3 class="font-medium text-slate-800">{{ chart.title }}</h3>
        <span class="text-sm text-slate-500 font-medium">{{ chart.subtitle }}</span>
    </div>
    
    <div id="{{ chart.id }}" style="width: 100%; height: 250px;"></div>
</div>

<script>
    (function() {
        var chartId = '{{ chart.id }}';
        var chartData = {{ chart.dates|safe }};
        var seriesData = [
            {% for s in chart.series %}
            {
                name: '{{ s.name }}',
                type: 'line',
                smooth: true,
                symbol: 'circle',
                symbolSize: 6,
                itemStyle: {
                    color: '{{ s.color }}'
                },
                data: {{ s.data|safe }}
            },
            {% endfor %}
        ];
        var yMin = {{ chart.y_min }};
        var yMax = {{ chart.y_max }};

        // Retry mechanism to ensure ECharts is loaded
        var maxRetries = 20; // 2 seconds max
        var retryCount = 0;

        function initChart() {
            if (typeof echarts === 'undefined') {
                if (retryCount < maxRetries) {
                    retryCount++;
                    setTimeout(initChart, 100);
                } else {
                    console.error('ECharts library not loaded.');
                    // Last resort: try to load it dynamically if missing
                    var script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js';
                    script.onload = function() {
                         retryCount = 0;
                         initChart();
                    };
                    document.head.appendChild(script);
                }
                return;
            }

            var chartDom = document.getElementById(chartId);
            if (!chartDom) return;

            var myChart = echarts.init(chartDom);
            var option = {
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: seriesData.map(function(item) { return item.name; }),
                    top: 0,
                    right: 0,
                    icon: 'circle',
                    itemWidth: 8,
                    itemHeight: 8,
                    textStyle: {
                        fontSize: 12,
                        color: '#64748b'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: chartData,
                    axisLine: {
                        lineStyle: {
                            color: '#94a3b8'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    min: yMin,
                    max: yMax,
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f1f5f9'
                        }
                    }
                },
                series: seriesData
            };
            
            // 如果数据点超过60个（约2个月），启用缩放滑块，优化长周期展示
            if (chartData.length > 60) {
                option.dataZoom = [
                    {
                        type: 'slider',
                        show: true,
                        xAxisIndex: [0],
                        start: 0,
                        end: 30,
                        bottom: 0,
                        height: 20
                    },
                    {
                        type: 'inside',
                        xAxisIndex: [0],
                        start: 0,
                        end: 30
                    }
                ];
                // 增加底部留白给滚动条
                option.grid.bottom = '12%';
            }

            myChart.setOption(option);
            
            // Resize chart on window resize
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }

        // Start initialization
        initChart();
    })();
</script>