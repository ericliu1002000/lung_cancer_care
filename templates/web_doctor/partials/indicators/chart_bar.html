<!-- Chart Bar Component -->
<div class="bg-white p-4 rounded-lg shadow-sm ">
    <div class="flex items-center gap-2 mb-4">
             {% if chart.id == "chart-physical" %}
                <svg t="1766814471225" class="icon w-6 h-6" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4507" width="32" height="32"><path d="M596.552 319.504zM726.232 296.808zM681.664 275.024c57.2 0 103.584-46.376 103.584-103.584 0-57.2-46.376-103.576-103.584-103.576-57.208 0-103.584 46.376-103.584 103.576-0.008 57.208 46.376 103.584 103.584 103.584zM681.664 275.024z" fill="#625e08" p-id="4508"></path><path d="M852.048 245.2c-59.48 83.304-139.12 92.952-224.824 42.08-5.832-3.464-31.72-17.72-37.448-21.128-137.864-81.84-275.576-49.744-367.92 79.576-39.248 55.008 51.512 107.144 90.32 52.776 47.712-66.816 108.392-86.152 174.744-64.984-33.976 58.976-63.68 117.592-105.6 200.872-41.928 83.28-134.496 149.792-223.432 97.768-64.184-37.504-122.056 54.696-58.072 92.088 121.432 70.976 263.808 27.392 336.496-64.864 2.52 1.344 5.184 2.568 8.104 3.584 59.384 20.688 137.216 75.76 160.936 95.28 23.712 19.52 64.456 118.96 88.64 168.92 29.344 60.624 124.12 16.472 94.664-44.416-27.416-56.688-73.448-169.824-109.352-198.448-28.792-22.96-84.704-65.68-132.136-89.92 32.088-62.144 65.496-123.616 100.664-184.024 112.088 34.344 218.632-6.112 294.512-112.408 39.28-54.992-51.464-107.128-90.296-52.752zM852.048 245.2z" fill="#625e08" p-id="4509"></path></svg>          {% elif chart.id == "chart-cough" %}
            
                {% elif chart.id == "chart-appetite" %}
                <svg t="1766815076167" class="icon w-6 h-6" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18561" width="32" height="32"><path d="M307.8 374.6c20.8 0 37.4-16.8 37.4-37.4 0-18.4 18.2-31 31.4-21.4 9.8 7 22.2 9 33.6 5.4 11.4-3.6 20.4-12.6 24-24 3.6-11.2 18.2-21 29.8-12.6 9.8 7 22.2 9 33.6 5.4 11.4-3.8 20.4-12.6 24-24 2.6-8 9.6-16 19.2-16s16.6 8 19.2 16c3.8 11.4 12.6 20.4 24 24 3 1 6 0.4 9 0.8l-63.8 39.8c-17.6 11-23 34.2-12 51.6 7.2 11.4 19.4 17.6 31.8 17.6 6.8 0 13.6-1.8 19.8-5.6l129.2-80.8c5.4 4.6 9.2 11.6 9.2 20.2 0 1.8-0.2 3.4-0.6 5.2-2.8 15.4 4.4 31 17.8 39 5.8 3.4 11.8 11 11.8 22.2H812c0-27.2-10.8-53-29.2-71.6-1-20.8-8.4-39.6-19.8-55l106.4-66.6c17.6-11 23-34.2 12-51.6-11-17.6-34.2-23-51.6-12l-139.4 87.2c-21.4-18.8-50.4-27.6-78.4-22.6-17.8-20.4-43.2-32.8-70.8-32.8-27.6 0-53 12.4-70.8 32.8-32.2-6-66 6.6-87.4 31.2-5.4-1-11-1.6-16.8-1.6-42.2 0-78.2 28.8-91 68.4-36.8 14-63.2 50.8-63.2 94h75c0-14 9.4-25.2 20.8-25.2zM137 437v37.4c0 150 88.8 279.4 216.2 339.2-16.4 4-28.8 18.2-28.8 35.8 0 20.8 16.8 37.4 37.4 37.4h300c20.8 0 37.4-16.8 37.4-37.4 0-17.6-12.4-31.8-28.8-35.8 127.6-60 216.2-189.2 216.2-339.2v-37.4H137z m418.8 283.4L512 654.6l-43.8 65.6-62.4-41.6 75-112.4c7-10.4 18.6-16.6 31.2-16.6 12.6 0 24.2 6.2 31.2 16.6l75 112.4-62.4 41.8z" p-id="18562" fill="#0a3203"></path></svg>             
                {% elif chart.id == "chart-pain" %}
              <svg t="1766815206480" class="icon w-6 h-6" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="24817" width="32" height="32"><path d="M482.848 307.328c1.216-1.408 60.288-30.816 105.344-19.104 92.8 34.88 170.016 92 226.464 176 28.576 42.464-40 82.016-68.32 39.936-14.4-21.44-31.136-41.28-49.824-59.072 10.016 23.68 17.856 48.256 23.424 73.376 1.12 5.12 6.144 28.544 6.144 36.608 0.736 105.408 13.664 207.552 44.224 308.608 20.32 67.328-84.672 95.904-104.928 28.928-26.72-88.448-40.896-179.136-45.92-270.912a92.48 92.48 0 0 1-15.872-5.44c-28.48 81.76-39.68 165.92-35.744 253.696 3.168 70.144-105.632 69.824-108.8 0-5.12-114.528 15.36-221.344 56.992-326.592 30.272-0.384 59.52-3.68 84.704-6.816 31.68-4.032 52.192-24.96 52.192-53.44 0-26.336-24.64-57.088-54.848-53.344-40.48 5.088-71.776 6.656-100.544 5.12-3.328-4.352-6.624-8.704-10.24-12.896a107.552 107.552 0 0 1-11.2-15.904 147.84 147.84 0 0 0-22.432 22.656 25.984 25.984 0 0 0-4.8 8.096c1.664 1.344 3.328 1.92 7.68 3.264 8.96 2.784 18.208 5.248 27.52 6.08 35.488 3.008 70.848 0.416 106.048-4.032 15.264-1.92 28.8 9.088 35.392 22.624 3.712 5.696 6.016 12.288 6.016 18.368 0 11.584-5.12 19.04-11.488 23.84-7.36 7.936-18.048 12.8-29.92 14.304-62.464 7.872-176.256 20.608-212.64-48.544-36.224-68.896 46.624-130.464 96.256-161.184 3.072-1.92 6.08-3.2 9.12-4.224z m-51.616 253.952a9.952 9.952 0 0 1 8.384 11.2 9.952 9.952 0 0 1-3.84 6.528c-48.864 36.64-90.88 80.128-121.984 113.952a9.856 9.856 0 0 1-17.152-6.688c0-5.12-0.288-10.56-0.608-15.968a410.24 410.24 0 0 0-55.328 82.048 9.856 9.856 0 0 1-8.832 5.504 9.984 9.984 0 0 1-8.448-4.704 9.92 9.92 0 0 1-0.384-9.6c17.856-35.744 43.68-71.904 74.688-104.64a9.92 9.92 0 0 1 17.024 6.848 294.4 294.4 0 0 0 0.64 16.48c29.504-31.2 66.4-67.52 108.512-99.072a9.92 9.92 0 0 1 7.328-1.888z m-41.28-40.224a5.504 5.504 0 0 1 2.304 8.992 5.568 5.568 0 0 1-1.824 1.28c-30.528 14.72-58.08 33.92-78.624 48.96a5.472 5.472 0 0 1-8.64-5.44c0.576-2.784 1.024-5.76 1.44-8.768a226.624 226.624 0 0 0-38.912 38.752 5.44 5.44 0 0 1-5.408 2.016 5.44 5.44 0 0 1-3.296-8.736 246.272 246.272 0 0 1 51.84-48.928 5.504 5.504 0 0 1 6.176-0.16 5.536 5.536 0 0 1 2.432 5.664c-0.608 2.88-1.024 5.984-1.44 9.088 19.392-13.824 43.36-29.664 69.664-42.336a5.536 5.536 0 0 1 4.32-0.384z m58.336-82.56c0.192 0.864 0.128 0.96-0.096 0.576a44.48 44.48 0 0 0-0.704 3.52c0.384-2.368 0.768-3.264 1.12-3.52l-0.256-0.736-0.064 0.16z m5.824-312.32a81.056 81.056 0 1 1 0.032 162.144 81.056 81.056 0 0 1 0-162.144z" fill="#5683FF" p-id="24818"></path></svg>
             {% elif chart.id == "chart-sleep" %}
              <svg t="1766814862906" class="icon w-6 h-6" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9259" width="32" height="32"><path d="M930.89792 568.65792a31.88224 31.88224 0 0 0-36.80256 2.79552 312.89856 312.89856 0 0 1-441.10336-436.96128l0.71168-0.9728a31.98976 31.98976 0 0 0 0.83456-36.52096l-0.512-0.78848a31.8976 31.8976 0 0 0-33.83296-13.46048l-0.384 0.09216a437.98528 437.98528 0 0 0 84.43904 864.10752q7.46496 0.25088 14.91968 0.25088a437.62176 437.62176 0 0 0 427.29472-343.63392l0.11776-0.56832a31.96416 31.96416 0 0 0-14.848-33.83808z m-43.008-411.3408a43.83744 43.83744 0 0 0-41.30816-29.21472h-193.51552a31.06816 31.06816 0 0 0-31.0528 31.09376 31.07328 31.07328 0 0 0 31.0528 31.08864h142.14144l-174.49472 142.38208a43.92448 43.92448 0 0 0-13.6192 48.6912 43.83744 43.83744 0 0 0 41.31328 29.21472h203.00288a31.07328 31.07328 0 0 0 31.05792-31.08864 31.07328 31.07328 0 0 0-31.05792-31.09376h-151.6544l174.49472-142.38208a43.90912 43.90912 0 0 0 13.6192-48.6912z" fill="#5288F5" p-id="9260"></path></svg>
             {% elif chart.id == "chart-psych" %}
               <svg t="1766814978497" class="icon w-6 h-6" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="16273" width="32" height="32"><path d="M505.565612 294.621612m-108.207761 0a108.207761 108.207761 0 1 0 216.415522 0 108.207761 108.207761 0 1 0-216.415522 0Z" fill="#FD6566" p-id="16274"></path><path d="M614.323582 222.116299c-8.085015-15.176597 2.705194-92.817194 76.417911-30.628299 73.666866 62.204179 127.327522 122.941134 122.910567 156.274627-4.401672 33.302925-139.584955 157.955821-139.584956 157.955821l0.443224 238.225194H345.133851L344.935164 504.969552S199.206209 380.790448 202.629731 345.531224c3.408239-35.24394 118.035104-150.848955 136.635224-168.241672 18.615403-17.392716 79.596896-8.558806 68.103642 35.763582-11.493254 44.337672-96.745075 109.736119-95.766925 131.270687 0.978149 21.549851 71.496597 82.531343 71.496597 82.531343h243.513313s72.826269-59.667104 76.479045-75.577313c3.71391-15.940776-8.925612-31.927403-8.925612-31.927403s-71.741134-82.057552-79.841433-97.234149z m-78.695164-82.225672l34.281075-43.726328-39.50806-24.820538L583.29791 6.021731l-15.986626 57.802508 35.901134 22.222328-67.584 53.859343z m64.649552-1.604776L656.796657 88.644776l-26.440597-35.916418L728.629493 2.445373l-44.077851 63.65612 20.556418 40.822447-104.799523 31.361911z" fill="#FD6566" p-id="16275"></path><path d="M409.936239 472.308537a64.924657 64.924657 0 0 1 64.924657 64.924657v416.630448a64.924657 64.924657 0 1 1-129.849314 0v-416.630448a64.924657 64.924657 0 0 1 64.924657-64.924657zM609.570388 472.308537a64.924657 64.924657 0 0 1 64.93994 64.924657v416.630448a64.924657 64.924657 0 1 1-129.864597 0v-416.630448a64.924657 64.924657 0 0 1 64.924657-64.924657z" fill="#FD6566" p-id="16276"></path></svg>
            {% else %}
               <svg t="1766814571378" class="icon w-6 h-6" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7006" width="32" height="32"><path d="M420.896 135.04c106.464-37.12 210.944-33.408 310.592 10.88v0.064c105.44 46.848 163.68 157.024 141.568 268a425.6 425.6 0 0 1-25.6 81.472l-1.504 3.008c-9.92 17.472-20.032 32.32-28.96 45.376-27.968 40.96-46.464 67.968-39.52 143.744 5.536 60.512 11.84 120.992 18.88 181.312a40.544 40.544 0 0 1-23.936 41.856 41.184 41.184 0 0 1-16.8 3.552h-267.232a40.8 40.8 0 0 1-40.544-46.848c7.2-46.656 1.696-70.528-2.432-75.744h-0.224c-55.872 1.504-112.128 0.064-114.72 0l-28.096-0.736 0.128-151.424c0.032-6.528-2.944-32.96-53.76-42.496A35.04 35.04 0 0 1 224 578.688a34.72 34.72 0 0 1-0.448-30.72c18.08-38.016 43.84-106.272 54.048-133.888a30.816 30.816 0 0 0 1.92-12.48c-2.72-49.152-0.64-213.6 140.864-266.368l0.544-0.192zM268.832 829.184c2.656 0.32 5.248 0.96 7.744 1.984l2.4 1.12a21.76 21.76 0 0 1 4.48 3.04l1.024 0.896 0.96 0.96 0.96 1.024 0.864 1.024a26.048 26.048 0 0 1 4.064 7.072l0.832 2.56c0.544 1.728 0.896 3.52 1.088 5.312l0.064 1.408v2.72l-0.064 1.408c-0.32 2.72-0.96 5.376-1.92 7.904l-1.152 2.464a22.176 22.176 0 0 1-1.376 2.4c-0.448 0.736-1.056 1.504-1.536 2.24-0.32 0.32-0.576 0.704-0.864 1.024l-0.96 0.992-1.984 1.888a25.504 25.504 0 0 1-6.88 4.096 26.144 26.144 0 0 1-7.744 2.016l-1.28 0.096h-2.72l-1.28-0.096a27.072 27.072 0 0 1-7.776-1.984l-2.4-1.088a16.512 16.512 0 0 1-2.24-1.44c-0.768-0.48-1.504-1.12-2.208-1.6l-1.024-0.96a19.104 19.104 0 0 1-1.888-1.92l-0.896-1.024a26.144 26.144 0 0 1-4-7.104 26.56 26.56 0 0 1-1.92-7.904l-0.128-1.408v-2.72a28.032 28.032 0 0 1 4.48-14.144l1.6-2.24a26.784 26.784 0 0 1 1.792-2.048l0.96-0.96a20.448 20.448 0 0 1 3.2-2.496 31.968 31.968 0 0 1 4.672-2.56 25.44 25.44 0 0 1 7.744-1.92l1.312-0.16a25.088 25.088 0 0 1 2.688 0l1.312 0.128z m413.984-298.08a28.8 28.8 0 0 0-29.248 12.576c-9.984 15.552-30.496 36.608-70.336 43.52-39.616-48.928-114.688-70.24-181.632-46.784a200.864 200.864 0 0 0-50.208 24.576 27.36 27.36 0 0 0-11.584 19.84 27.168 27.168 0 0 0 7.712 21.536l1.888 1.984a27.84 27.84 0 0 0 35.616 3.008 148.672 148.672 0 0 1 35.776-17.056c50.112-17.6 111.104 4.448 128 46.176 31.936 79.232 29.056 155.776 24.832 193.024a26.56 26.56 0 0 0 20.8 28.928l3.648 0.832a27.072 27.072 0 0 0 21.504-4.16 26.944 26.944 0 0 0 11.296-18.688c7.776-67.552 0.64-136-20.992-200.512a152.352 152.352 0 0 0 91.84-65.248v-0.032a28.416 28.416 0 0 0-18.912-43.52zM139.712 720.32a30.08 30.08 0 0 1 21.184 8.736 29.76 29.76 0 0 1-21.184 50.912 29.792 29.792 0 1 1 0-59.648z m69.344-24.128c2.656 0.32 5.248 1.024 7.712 2.016 0.832 0.32 1.664 0.768 2.432 1.152 1.6 0.768 3.104 1.792 4.48 2.944l0.992 0.928 0.96 0.96 0.96 0.992c2.08 2.4 3.744 5.12 4.896 8.096l0.896 2.592a27.712 27.712 0 0 1 1.056 5.376l0.096 1.344v2.72a33.024 33.024 0 0 1-2.016 9.312l-1.152 2.464a22.592 22.592 0 0 1-2.88 4.64l-0.928 0.992a23.104 23.104 0 0 1-0.896 1.056l-0.96 0.96a25.12 25.12 0 0 1-7.936 5.088 25.984 25.984 0 0 1-7.712 2.016l-1.344 0.064h-2.656l-1.376-0.096a27.2 27.2 0 0 1-16.544-8l-0.928-1.088a19.456 19.456 0 0 1-2.432-3.2 31.04 31.04 0 0 1-4.416-12.8l-0.096-1.408v-2.72c0-0.448 0-0.896 0.064-1.344a28.48 28.48 0 0 1 3.04-10.432c0.384-0.8 0.928-1.6 1.408-2.304l1.568-2.24 0.864-1.12 0.928-0.96 0.96-0.96 1.024-0.896a25.6 25.6 0 0 1 6.848-4.128 25.312 25.312 0 0 1 7.712-2.016l1.376-0.096h2.656l1.344 0.096z" fill="#5683FF" p-id="7007"></path></svg>

            {% endif %}
        <h3 class="font-medium text-slate-800">{{ chart.title }}</h3>
        <span class="text-sm text-slate-500 font-medium">{{ chart.subtitle }}</span>
    </div>
    
    <div id="{{ chart.id }}" style="width: 100%; height: 250px;"></div>
</div>

<script>
    (function() {
        var chartId = '{{ chart.id }}';
        var chartData = {{ chart.dates|safe }};
        var seriesData = [
            {% for s in chart.series %}
            {
                name: '{{ s.name }}',
                type: 'bar',
                barMaxWidth: 20,
                itemStyle: {
                    color: '{{ s.color }}',
                    borderRadius: [4, 4, 0, 0]
                },
                data: {{ s.data|safe }}
            },
            {% endfor %}
        ];
        var yMin = {{ chart.y_min }};
        var yMax = {{ chart.y_max }};

        // Retry mechanism to ensure ECharts is loaded
        var maxRetries = 20; // 2 seconds max
        var retryCount = 0;

        function initChart() {
            if (typeof echarts === 'undefined') {
                if (retryCount < maxRetries) {
                    retryCount++;
                    setTimeout(initChart, 100);
                } else {
                    console.error('ECharts library not loaded.');
                    // Last resort: try to load it dynamically if missing
                    var script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js';
                    script.onload = function() {
                         retryCount = 0;
                         initChart();
                    };
                    document.head.appendChild(script);
                }
                return;
            }

            var chartDom = document.getElementById(chartId);
            if (!chartDom) return;

            var myChart = echarts.init(chartDom);
            var option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: seriesData.map(function(item) { return item.name; }),
                    top: 0,
                    right: 0,
                    icon: 'roundRect',
                    itemWidth: 12,
                    itemHeight: 12,
                    textStyle: {
                        fontSize: 12,
                        color: '#64748b'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: true,
                    data: chartData,
                    axisLine: {
                        lineStyle: {
                            color: '#94a3b8'
                        }
                    },
                    axisTick: {
                        alignWithLabel: true
                    }
                },
                yAxis: {
                    type: 'value',
                    min: yMin,
                    max: yMax,
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f1f5f9'
                        }
                    }
                },
                series: seriesData
            };
            
            // 如果数据点超过30个，启用缩放滑块
            if (chartData.length > 30) {
                option.dataZoom = [
                    {
                        type: 'slider',
                        show: true,
                        xAxisIndex: [0],
                        start: 0,
                        end: 40,
                        bottom: 0,
                        height: 20
                    },
                    {
                        type: 'inside',
                        xAxisIndex: [0],
                        start: 0,
                        end: 40
                    }
                ];
                option.grid.bottom = '12%';
            }

            myChart.setOption(option);
            
            // Resize chart on window resize
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }

        // Start initialization
        initChart();
    })();
</script>