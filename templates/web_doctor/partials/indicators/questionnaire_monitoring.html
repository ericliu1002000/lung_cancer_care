<div id="questionnaire-container" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden p-4 mt-6">
     <div class="flex items-center justify-between mb-6 relative">
        <div class="flex items-center gap-6">
            <h3 class="text-base font-bold text-slate-800 border-l-4 border-indigo-500 pl-3">随访问卷</h3>
            <a href="{% url 'web_doctor:questionnaire_detail' patient.id %}" class="text-sm text-indigo-600 hover:underline cursor-pointer flex items-center font-bold">
                查看详情 
                <svg t="1766823529094" class="icon w-4 h-4" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="30115" width="48" height="48"><path d="M722.438 510.815c-0.246-0.246-0.513-0.454-0.766-0.69l-299.893-299.892c-14.231-14.24-37.291-14.24-51.529 0-14.241 14.231-14.241 37.291 0 51.529l274.851 274.859-274.849 274.851c-14.241 14.237-14.241 37.301 0 51.532 7.116 7.119 16.436 10.682 25.764 10.682 9.321 0 18.644-3.563 25.763-10.682l299.905-299.901c0.246-0.234 0.51-0.438 0.751-0.678 7.129-7.13 10.685-16.469 10.674-25.804 0.006-9.337-3.55-18.676-10.674-25.804z" fill="#4f46e5" p-id="30116"></path></svg>
            </a>
        </div>
        <!-- 筛选表单区域 -->
        <form id="indicators-filter-form" 
              class="flex items-center gap-4 text-sm relative" 
              onsubmit="return false;"
              x-data="{ 
                  filterType: '{{ current_filter_type|default:'' }}' || '{% if current_cycle_id %}cycle{% elif current_start_date %}date{% else %}{% endif %}',
                  updateDatesFromCycle(event) {
                      const select = event.target;
                      const option = select.options[select.selectedIndex];
                      const start = option.getAttribute('data-start') || '';
                      const end = option.getAttribute('data-end') || '';
                      
                      const startInput = document.getElementById('start_date');
                      const endInput = document.getElementById('end_date');
                      
                      if (startInput) startInput.value = start;
                      if (endInput) endInput.value = end;
                  }
              }"
        >
            <!-- 筛选条件选择 --> 
            <div class="flex items-center gap-2">
                <input type="hidden" name="filter_type" x-model="filterType">
                <span class="text-slate-600">筛选条件:</span>
                <select x-model="filterType" class="border border-slate-300 rounded px-2 py-1 text-slate-700 focus:outline-none focus:border-indigo-500">
                    <option value="">请选择</option>
                    <option value="cycle">按疗程选择</option>
                    <option value="date">按日期查看</option>
                </select>
            </div>

            <!-- 按疗程选择 -->
            <div class="flex items-center gap-2" x-show="filterType === 'cycle'" x-cloak>
                <select name="cycle_id" 
                        :disabled="filterType !== 'cycle'"
                        @change="updateDatesFromCycle($event)"
                        class="border border-slate-300 rounded px-2 py-1 text-slate-700 focus:outline-none focus:border-indigo-500 max-w-[200px]">
                    <option value="">全部疗程</option>
                    {% for cycle in treatment_cycles %}
                    <option value="{{ cycle.id }}" 
                            data-start="{{ cycle.start_date|date:'Y-m-d' }}" 
                            data-end="{% if cycle.end_date %}{{ cycle.end_date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}"
                            {% if cycle.id == current_cycle_id %}selected{% endif %}>
                        {{ cycle.name }} ({{ cycle.start_date|date:"Y/m/d" }} - {{ cycle.end_date|date:"Y/m/d"|default:"至今" }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- 按日期查看 -->
            <div class="flex items-center gap-2" x-show="filterType === 'date'" x-cloak>
                <div class="flex items-center border border-slate-300 rounded px-2 py-1 bg-white">
                                        <input placeholder="开始日期" type="date" name="start_date" value="{{ current_start_date }}" class="focus:outline-none text-slate-700 date-input">
                    <span class="text-slate-400 mx-1">-</span>
                                        <input placeholder="结束日期" type="date" name="end_date" value="{{ current_end_date }}" class="focus:outline-none text-slate-700 date-input">

                </div>
            </div>

            <!-- 按钮组 -->
            <div class="flex items-center gap-2" x-show="filterType !== ''" x-cloak>
                <button 
                    hx-get="{% url 'web_doctor:patient_workspace_section' patient.id 'indicators' %}"
                    hx-target="#indicators-wrapper"
                    hx-swap="outerHTML"
                    hx-include="#questionnaire-filter-form"
                    class="ml-3 px-4 lg:px-6 py-1.5 bg-indigo-600 text-white text-sm rounded-[4px] hover:bg-indigo-700 shadow-sm transition-colors cursor-pointer">
                    搜索
                </button>
                <button 
                    hx-get="{% url 'web_doctor:patient_workspace_section' patient.id 'indicators' %}"
                    hx-target="#indicators-wrapper"
                    hx-swap="outerHTML"
                    @click="filterType = ''"
                    class="ml-3 px-4 lg:px-6 py-1.5 bg-gray-600 text-white text-sm rounded-[4px] hover:bg-indigo-700 shadow-sm transition-colors cursor-pointer">
                    重置
                </button>
            </div>
             {% if is_default_view %}
        <div class="absolute top-0 right-4 mt-14 text-indigo-600 font-medium hover:text-indigo-800" x-show="filterType === ''">
            最近30天
        </div>
        {% endif %}
        </form>
    </div>

    <!-- Charts Grid -->
    <div class="space-y-6">
        <!-- 1. 体能与呼吸 (拆分为两列) -->
      
            <!-- 体能 -->
            {% if charts.physical %}
            <div id="container-physical">
                {% include "web_doctor/partials/indicators/chart_bar.html" with chart=charts.physical %}
            </div>
            {% endif %}

            <!-- 呼吸 -->
            {% if charts.breath %}
            <div id="container-breath">
                {% include "web_doctor/partials/indicators/chart_bar.html" with chart=charts.breath %}
            </div>
            {% endif %}
     

        <!-- 2. 咳嗽与痰色 (特殊布局：含表格) -->
        {% if charts.cough %}
        <div class="bg-white p-4 rounded-lg shadow-sm">
            <div class="flex items-center gap-2 mb-4">
                 <svg t="1766814571378" class="icon w-6 h-6" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7006" width="32" height="32"><path d="M420.896 135.04c106.464-37.12 210.944-33.408 310.592 10.88v0.064c105.44 46.848 163.68 157.024 141.568 268a425.6 425.6 0 0 1-25.6 81.472l-1.504 3.008c-9.92 17.472-20.032 32.32-28.96 45.376-27.968 40.96-46.464 67.968-39.52 143.744 5.536 60.512 11.84 120.992 18.88 181.312a40.544 40.544 0 0 1-23.936 41.856 41.184 41.184 0 0 1-16.8 3.552h-267.232a40.8 40.8 0 0 1-40.544-46.848c7.2-46.656 1.696-70.528-2.432-75.744h-0.224c-55.872 1.504-112.128 0.064-114.72 0l-28.096-0.736 0.128-151.424c0.032-6.528-2.944-32.96-53.76-42.496A35.04 35.04 0 0 1 224 578.688a34.72 34.72 0 0 1-0.448-30.72c18.08-38.016 43.84-106.272 54.048-133.888a30.816 30.816 0 0 0 1.92-12.48c-2.72-49.152-0.64-213.6 140.864-266.368l0.544-0.192zM268.832 829.184c2.656 0.32 5.248 0.96 7.744 1.984l2.4 1.12a21.76 21.76 0 0 1 4.48 3.04l1.024 0.896 0.96 0.96 0.96 1.024 0.864 1.024a26.048 26.048 0 0 1 4.064 7.072l0.832 2.56c0.544 1.728 0.896 3.52 1.088 5.312l0.064 1.408v2.72l-0.064 1.408c-0.32 2.72-0.96 5.376-1.92 7.904l-1.152 2.464a22.176 22.176 0 0 1-1.376 2.4c-0.448 0.736-1.056 1.504-1.536 2.24-0.32 0.32-0.576 0.704-0.864 1.024l-0.96 0.992-1.984 1.888a25.504 25.504 0 0 1-6.88 4.096 26.144 26.144 0 0 1-7.744 2.016l-1.28 0.096h-2.72l-1.28-0.096a27.072 27.072 0 0 1-7.776-1.984l-2.4-1.088a16.512 16.512 0 0 1-2.24-1.44c-0.768-0.48-1.504-1.12-2.208-1.6l-1.024-0.96a19.104 19.104 0 0 1-1.888-1.92l-0.896-1.024a26.144 26.144 0 0 1-4-7.104 26.56 26.56 0 0 1-1.92-7.904l-0.128-1.408v-2.72a28.032 28.032 0 0 1 4.48-14.144l1.6-2.24a26.784 26.784 0 0 1 1.792-2.048l0.96-0.96a20.448 20.448 0 0 1 3.2-2.496 31.968 31.968 0 0 1 4.672-2.56 25.44 25.44 0 0 1 7.744-1.92l1.312-0.16a25.088 25.088 0 0 1 2.688 0l1.312 0.128z m413.984-298.08a28.8 28.8 0 0 0-29.248 12.576c-9.984 15.552-30.496 36.608-70.336 43.52-39.616-48.928-114.688-70.24-181.632-46.784a200.864 200.864 0 0 0-50.208 24.576 27.36 27.36 0 0 0-11.584 19.84 27.168 27.168 0 0 0 7.712 21.536l1.888 1.984a27.84 27.84 0 0 0 35.616 3.008 148.672 148.672 0 0 1 35.776-17.056c50.112-17.6 111.104 4.448 128 46.176 31.936 79.232 29.056 155.776 24.832 193.024a26.56 26.56 0 0 0 20.8 28.928l3.648 0.832a27.072 27.072 0 0 0 21.504-4.16 26.944 26.944 0 0 0 11.296-18.688c7.776-67.552 0.64-136-20.992-200.512a152.352 152.352 0 0 0 91.84-65.248v-0.032a28.416 28.416 0 0 0-18.912-43.52zM139.712 720.32a30.08 30.08 0 0 1 21.184 8.736 29.76 29.76 0 0 1-21.184 50.912 29.792 29.792 0 1 1 0-59.648z m69.344-24.128c2.656 0.32 5.248 1.024 7.712 2.016 0.832 0.32 1.664 0.768 2.432 1.152 1.6 0.768 3.104 1.792 4.48 2.944l0.992 0.928 0.96 0.96 0.96 0.992c2.08 2.4 3.744 5.12 4.896 8.096l0.896 2.592a27.712 27.712 0 0 1 1.056 5.376l0.096 1.344v2.72a33.024 33.024 0 0 1-2.016 9.312l-1.152 2.464a22.592 22.592 0 0 1-2.88 4.64l-0.928 0.992a23.104 23.104 0 0 1-0.896 1.056l-0.96 0.96a25.12 25.12 0 0 1-7.936 5.088 25.984 25.984 0 0 1-7.712 2.016l-1.344 0.064h-2.656l-1.376-0.096a27.2 27.2 0 0 1-16.544-8l-0.928-1.088a19.456 19.456 0 0 1-2.432-3.2 31.04 31.04 0 0 1-4.416-12.8l-0.096-1.408v-2.72c0-0.448 0-0.896 0.064-1.344a28.48 28.48 0 0 1 3.04-10.432c0.384-0.8 0.928-1.6 1.408-2.304l1.568-2.24 0.864-1.12 0.928-0.96 0.96-0.96 1.024-0.896a25.6 25.6 0 0 1 6.848-4.128 25.312 25.312 0 0 1 7.712-2.016l1.376-0.096h2.656l1.344 0.096z" fill="#5683FF" p-id="7007"></path></svg>
                 <h3 class="font-medium text-slate-800">咳嗽与痰色量表 ({{ charts.cough.dates|length }}次)</h3>
            </div>
            
            <div class="overflow-x-auto mb-2">
                 <table class="w-full text-sm text-center border-collapse">
                     <tbody>
                         {% for row in cough_table.rows %}
                         <tr>
                             <td class="p-2 border border-slate-200 bg-slate-50 font-medium w-20 whitespace-nowrap">{{ row.label }}</td>
                             {% for val in row.values %}
                             <td class="p-1 border border-slate-200 min-w-[30px] text-xs text-slate-600 whitespace-nowrap">
                                 <span class="{% if val == '是' or val == '脓色' or val == '红色' %}text-red-500 font-bold{% elif val == '黄色' %}text-yellow-600{% endif %}">
                                    {{ val }}
                                 </span>
                             </td>
                             {% endfor %}
                         </tr>
                         {% endfor %}
                     </tbody>
                 </table>
            </div>

            <!-- Reuse Bar Chart Logic for Cough Score -->
            {% include "web_doctor/partials/indicators/chart_bar.html" with chart=charts.cough %}

            {% comment %} <div id="{{ charts.cough.id }}" style="width: 100%; height: 200px; "></div>
            <script>
                (function() {
                    var chartId = '{{ charts.cough.id }}';
                    var chartData = {{ charts.cough.dates|safe }};
                    var seriesData = [
                        {% for s in charts.cough.series %}
                        {
                            name: '{{ s.name }}',
                            type: 'bar',
                            barMaxWidth: 20,
                            itemStyle: { color: '{{ s.color }}', borderRadius: [4, 4, 0, 0] },
                            data: {{ s.data|safe }}
                        },
                        {% endfor %}
                    ];
                    
                    var chartDom = document.getElementById(chartId);
                    if (chartDom && typeof echarts !== 'undefined') {
                        var myChart = echarts.init(chartDom);
                        var option = {
                            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                            grid: { left: '3%', right: '4%', bottom: '3%', top: '10%', containLabel: true },
                            xAxis: { type: 'category', boundaryGap: true, data: chartData, axisLine: { lineStyle: { color: '#94a3b8' } } },
                            yAxis: { type: 'value', min: 0, max: 12, splitLine: { lineStyle: { color: '#f1f5f9' } } },
                            series: seriesData
                        };
                        myChart.setOption(option);
                        window.addEventListener('resize', () => myChart.resize());
                    }
                })();
            </script> {% endcomment %}
        </div>
        {% endif %}

        <!-- 3. 食欲评估 -->
        {% if charts.appetite %}
        {% include "web_doctor/partials/indicators/chart_bar.html" with chart=charts.appetite %}
        {% endif %}

        <!-- 4. 疼痛量表 -->
        {% if charts.pain %}
        {% include "web_doctor/partials/indicators/chart_bar.html" with chart=charts.pain %}
        {% endif %}

        <!-- 5. 睡眠质量 -->
        {% if charts.sleep %}
        {% include "web_doctor/partials/indicators/chart_bar.html" with chart=charts.sleep %}
        {% endif %}
        
         <!-- 6. 心理痛苦 -->
        {% if charts.psych %}
        {% include "web_doctor/partials/indicators/chart_bar.html" with chart=charts.psych %}
        {% endif %}
    </div>
</div>