<li class="px-3 pt-3 pb-1">
    <button
        type="button"
        class="w-full flex items-center justify-between text-left text-sm text-slate-700"
        data-section-toggle="managed"
    >
        <span class="flex items-center gap-2">
            <svg class="w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <path d="M20 8v6"></path>
                <path d="M23 11h-6"></path>
            </svg>
            <span class="font-medium">管理中</span>
            <span class="text-slate-500">(<span data-section-count="managed">{{ managed_patients|length }}</span>)</span>
        </span>
        <svg class="w-4 h-4 text-slate-400 rotate-180 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor" data-section-chevron="managed">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"></path>
        </svg>
    </button>
    <div data-section-body="managed" class="overflow-hidden" style="height: auto;">
        <ul class="mt-2 divide-y divide-slate-100 rounded-md border border-slate-100 bg-white">
            {% if managed_patients %}
                {% for patient in managed_patients %}
                    <li data-patient-entry data-section="managed">
                        <button
                            type="button"
                            class="w-full text-left px-4 py-3 hover:bg-indigo-50 focus:bg-indigo-100 focus:outline-none transition"
                            hx-get="{% url 'web_doctor:patient_workspace' patient.id %}"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            data-patient-item
                            data-patient-id="{{ patient.id }}"
                            data-patient-name="{{ patient.name|default:'' }}"
                            data-patient-phone="{{ patient.phone|default:'' }}"
                        >
                            <div class="flex items-center">
                                <p class="text-sm font-medium text-gray-900 mr-3">{{ patient.name }}</p>
                                <p class="text-sm text-gray-500">
                                    性别：{{ patient.get_gender_display }} · 年龄：{{ patient.age|default:"-" }}
                                </p>
                            </div>
                            <div class="mt-2 mb-1 flex items-center text-sm text-gray-500">
                                <span>待办</span>
                                <span class="text-red-500 ml-1">
                                    {% if patient.todo_count > 99 %}(99+){% else %}({{ patient.todo_count|default:0 }}){% endif %}
                                </span>
                                <span class="ml-3">咨询</span>
                                <span class="text-red-500 ml-1">
                                    {% if patient.consult_count > 99 %}(99+){% else %}({{ patient.consult_count|default:0 }}){% endif %}
                                </span>
                            </div>
                        </button>
                    </li>
                {% endfor %}
            {% else %}
                <li class="px-4 py-3 text-sm text-gray-400">暂无患者</li>
            {% endif %}
        </ul>
    </div>
</li>

<li class="px-3 pt-3 pb-1">
    <button
        type="button"
        class="w-full flex items-center justify-between text-left text-sm text-slate-700"
        data-section-toggle="stopped"
    >
        <span class="flex items-center gap-2">
            <svg class="w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <path d="M18 8l4 4"></path>
                <path d="M22 8l-4 4"></path>
            </svg>
            <span class="font-medium">停止管理</span>
            <span class="text-slate-500">(<span data-section-count="stopped">{{ stopped_patients|length }}</span>)</span>
        </span>
        <svg class="w-4 h-4 text-slate-400 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor" data-section-chevron="stopped">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"></path>
        </svg>
    </button>
    <div data-section-body="stopped" class="overflow-hidden" style="height: 0px;">
        <ul class="mt-2 divide-y divide-slate-100 rounded-md border border-slate-100 bg-white">
            {% if stopped_patients %}
                {% for patient in stopped_patients %}
                    <li data-patient-entry data-section="stopped">
                        <button
                            type="button"
                            class="w-full text-left px-4 py-3 hover:bg-indigo-50 focus:bg-indigo-100 focus:outline-none transition"
                            hx-get="{% url 'web_doctor:patient_workspace' patient.id %}"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            data-patient-item
                            data-patient-id="{{ patient.id }}"
                            data-patient-name="{{ patient.name|default:'' }}"
                            data-patient-phone="{{ patient.phone|default:'' }}"
                        >
                            <div class="flex items-center">
                                <p class="text-sm font-medium text-gray-900 mr-3">{{ patient.name }}</p>
                                <p class="text-sm text-gray-500">
                                    性别：{{ patient.get_gender_display }} · 年龄：{{ patient.age|default:"-" }}
                                </p>
                            </div>
                            <div class="mt-2 mb-1 flex items-center text-sm text-gray-500">
                                <span>待办</span>
                                <span class="text-red-500 ml-1">
                                    {% if patient.todo_count > 99 %}(99+){% else %}({{ patient.todo_count|default:0 }}){% endif %}
                                </span>
                                <span class="ml-3">咨询</span>
                                <span class="text-red-500 ml-1">
                                    {% if patient.consult_count > 99 %}(99+){% else %}({{ patient.consult_count|default:0 }}){% endif %}
                                </span>
                            </div>
                        </button>
                    </li>
                {% endfor %}
            {% else %}
                <li class="px-4 py-3 text-sm text-gray-400">暂无患者</li>
            {% endif %}
        </ul>
    </div>
</li>

<li class="px-3 pt-3 pb-1">
    <button
        type="button"
        class="w-full flex items-center justify-between text-left text-sm text-slate-700"
        data-section-toggle="unpaid"
    >
        <span class="flex items-center gap-2">
            <svg class="w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <path d="M12 12v6"></path>
                <path d="M9 15h6"></path>
            </svg>
            <span class="font-medium">未付费患者</span>
            <span class="text-slate-500">(<span data-section-count="unpaid">{{ unpaid_patients|length }}</span>)</span>
        </span>
        <svg class="w-4 h-4 text-slate-400 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor" data-section-chevron="unpaid">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"></path>
        </svg>
    </button>
    <div data-section-body="unpaid" class="overflow-hidden" style="height: 0px;">
        <ul class="mt-2 divide-y divide-slate-100 rounded-md border border-slate-100 bg-white">
            {% if unpaid_patients %}
                {% for patient in unpaid_patients %}
                    <li data-patient-entry data-section="unpaid">
                        <button
                            type="button"
                            class="w-full text-left px-4 py-3 hover:bg-indigo-50 focus:bg-indigo-100 focus:outline-none transition"
                            hx-get="{% url 'web_doctor:patient_workspace' patient.id %}"
                            hx-target="#main-content"
                            hx-swap="innerHTML"
                            data-patient-item
                            data-patient-id="{{ patient.id }}"
                            data-patient-name="{{ patient.name|default:'' }}"
                            data-patient-phone="{{ patient.phone|default:'' }}"
                        >
                            <div class="flex items-center">
                                <p class="text-sm font-medium text-gray-900 mr-3">{{ patient.name }}</p>
                                <p class="text-sm text-gray-500">
                                    性别：{{ patient.get_gender_display }} · 年龄：{{ patient.age|default:"-" }}
                                </p>
                            </div>
                            <div class="mt-2 mb-1 flex items-center text-sm text-gray-500">
                                <span>待办</span>
                                <span class="text-red-500 ml-1">
                                    {% if patient.todo_count > 99 %}(99+){% else %}({{ patient.todo_count|default:0 }}){% endif %}
                                </span>
                                <span class="ml-3">咨询</span>
                                <span class="text-red-500 ml-1">
                                    {% if patient.consult_count > 99 %}(99+){% else %}({{ patient.consult_count|default:0 }}){% endif %}
                                </span>
                            </div>
                        </button>
                    </li>
                {% endfor %}
            {% else %}
                <li class="px-4 py-3 text-sm text-gray-400">暂无患者</li>
            {% endif %}
        </ul>
    </div>
</li>

<li class="hidden"
    hx-get="{% url 'web_doctor:doctor_workspace_patient_list' %}"
    hx-trigger="every 180s"
    hx-target="#patient-list-container"
    hx-swap="innerHTML">
</li>

<template id="patient-main-loading-template">
  {% include "web_doctor/partials/patient_workspace_loading.html" %}
</template>

<script>
(function () {
  if (window.__doctorPatientListInitialized) return;
  window.__doctorPatientListInitialized = true;

  const SECTION_STATE_KEY = "doctor_patient_list_section_state";
  const FILTER_KEY = "doctor_patient_list_filter";
  const SELECTED_KEY = "doctor_patient_list_selected_patient_id";
  const SECTIONS = ["managed", "stopped", "unpaid"];
  const DEFAULT_SECTION_STATE = { managed: true, stopped: false, unpaid: false };

  const readJson = function (key, fallback) {
    try {
      const raw = sessionStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    } catch (e) {
      return fallback;
    }
  };

  const writeJson = function (key, value) {
    try {
      sessionStorage.setItem(key, JSON.stringify(value));
    } catch (e) {}
  };

  const getSectionState = function () {
    const state = readJson(SECTION_STATE_KEY, DEFAULT_SECTION_STATE);
    for (const section of SECTIONS) {
      if (typeof state[section] !== "boolean") state[section] = DEFAULT_SECTION_STATE[section];
    }
    return state;
  };

  const setSectionOpen = function (section, open, animate) {
    const body = document.querySelector('[data-section-body="' + section + '"]');
    if (!body) return;

    const chevron = document.querySelector('[data-section-chevron="' + section + '"]');
    if (chevron) {
      if (open) chevron.classList.add("rotate-180");
      else chevron.classList.remove("rotate-180");
      chevron.classList.add("transition-transform", "duration-200");
    }

    if (!animate) {
      body.style.transitionProperty = "none";
      body.style.height = open ? "auto" : "0px";
      body.offsetHeight;
      body.style.transitionProperty = "";
      return;
    }

    body.style.transitionProperty = "height";
    body.style.transitionDuration = "200ms";
    body.style.transitionTimingFunction = "ease";

    if (open) {
      body.style.height = "0px";
      body.offsetHeight;
      body.style.height = body.scrollHeight + "px";
      const onEnd = function () {
        body.style.height = "auto";
        body.removeEventListener("transitionend", onEnd);
      };
      body.addEventListener("transitionend", onEnd);
      return;
    }

    body.style.height = body.scrollHeight + "px";
    body.offsetHeight;
    body.style.height = "0px";
  };

  const applyAllSectionStates = function (animate) {
    const state = getSectionState();
    for (const section of SECTIONS) {
      setSectionOpen(section, !!state[section], animate);
    }
  };

  const getFilterTerm = function () {
    const raw = sessionStorage.getItem(FILTER_KEY) || "";
    return raw.trim();
  };

  const setFilterTerm = function (term) {
    try {
      sessionStorage.setItem(FILTER_KEY, (term || "").trim());
    } catch (e) {}
  };

  const applyFilter = function () {
    const term = getFilterTerm().toLowerCase();
    const entries = document.querySelectorAll("[data-patient-entry]");
    for (const entry of entries) {
      const btn = entry.querySelector("button[data-patient-item]");
      const name = (btn && btn.dataset && btn.dataset.patientName ? btn.dataset.patientName : "").toLowerCase();
      const phone = (btn && btn.dataset && btn.dataset.patientPhone ? btn.dataset.patientPhone : "").toLowerCase();
      const matched = !term || name.includes(term) || phone.includes(term);
      if (matched) entry.classList.remove("hidden");
      else entry.classList.add("hidden");
    }
  };

  const syncSearchInput = function () {
    const input = document.getElementById("patient-search-input");
    if (!input) return;
    input.value = getFilterTerm();
  };

  const applySelectedHighlight = function () {
    const selectedId = sessionStorage.getItem(SELECTED_KEY);
    if (!selectedId) return;
    const btn = document.querySelector('button[data-patient-item][data-patient-id="' + selectedId + '"]');
    if (!btn) return;
    document.querySelectorAll("button[data-patient-item]").forEach(function (item) {
      item.classList.remove("bg-indigo-50");
    });
    btn.classList.add("bg-indigo-50");
  };

  const applyAllUIState = function (animate) {
    syncSearchInput();
    applyAllSectionStates(animate);
    applyFilter();
    applySelectedHighlight();
  };

  const runSearch = function () {
    const input = document.getElementById("patient-search-input");
    if (!input) return;
    setFilterTerm(input.value);
    applyFilter();

    const term = getFilterTerm().toLowerCase();
    if (!term) return;

    const state = getSectionState();
    for (const section of SECTIONS) {
      const sectionEntries = document.querySelectorAll('[data-patient-entry][data-section="' + section + '"]');
      let hasMatch = false;
      for (const entry of sectionEntries) {
        if (!entry.classList.contains("hidden")) {
          hasMatch = true;
          break;
        }
      }
      if (hasMatch) {
        state[section] = true;
        setSectionOpen(section, true, true);
      }
    }
    writeJson(SECTION_STATE_KEY, state);
  };

  const runReset = function () {
    const input = document.getElementById("patient-search-input");
    if (input) input.value = "";
    setFilterTerm("");
    applyFilter();

    try {
      sessionStorage.removeItem(SELECTED_KEY);
    } catch (e) {}
    document.querySelectorAll("button[data-patient-item]").forEach(function (item) {
      item.classList.remove("bg-indigo-50");
    });

    const state = { managed: true, stopped: false, unpaid: false };
    writeJson(SECTION_STATE_KEY, state);
    applyAllSectionStates(true);
  };

  document.addEventListener("click", function (event) {
    const sectionBtn = event.target.closest("[data-section-toggle]");
    if (sectionBtn) {
      const section = sectionBtn.getAttribute("data-section-toggle");
      const state = getSectionState();
      const nextOpen = !state[section];
      state[section] = nextOpen;
      writeJson(SECTION_STATE_KEY, state);
      setSectionOpen(section, nextOpen, true);
      return;
    }

    const searchBtn = event.target.closest("#patient-search-btn");
    if (searchBtn) {
      runSearch();
      return;
    }

    const resetBtn = event.target.closest("#patient-search-reset");
    if (resetBtn) {
      runReset();
      return;
    }

    const btn = event.target.closest("button[hx-get][hx-target='#main-content']");
    if (!btn) return;

    const patientId = btn.dataset && btn.dataset.patientId ? parseInt(btn.dataset.patientId) : null;
    const patientName = btn.dataset && btn.dataset.patientName ? btn.dataset.patientName : "";
    if (patientId) {
      try {
        sessionStorage.setItem(SELECTED_KEY, String(patientId));
      } catch (e) {}
      window.dispatchEvent(new CustomEvent("update-chat-patient", { detail: { id: patientId, name: patientName } }));
    }

    document.querySelectorAll("button[data-patient-item]").forEach(function (item) {
      item.classList.remove("bg-indigo-50");
    });
    btn.classList.add("bg-indigo-50");

    const tmpl = document.getElementById("patient-main-loading-template");
    const main = document.querySelector("#main-content");
    if (!tmpl || !main) return;
    const clone = tmpl.content ? tmpl.content.cloneNode(true) : null;
    if (!clone) return;
    main.innerHTML = "";
    main.appendChild(clone);
  });

  document.addEventListener("keydown", function (event) {
    const target = event.target;
    if (!target || target.id !== "patient-search-input") return;
    if (event.key !== "Enter") return;
    event.preventDefault();
    runSearch();
  });

  document.body.addEventListener("htmx:afterSwap", function (event) {
    const target = event.target;
    if (!target || target.id !== "patient-list-container") return;
    applyAllUIState(false);
  });

  writeJson(SECTION_STATE_KEY, DEFAULT_SECTION_STATE);
  applyAllUIState(false);
})();
</script>
