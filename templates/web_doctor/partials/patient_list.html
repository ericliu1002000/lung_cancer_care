{% if patients %}
    {% for patient in patients %}
        <li>
            <button
                type="button"
                class="w-full text-left px-4 py-3 hover:bg-indigo-50 focus:bg-indigo-100 focus:outline-none transition border-b border-gray-200"
                hx-get="{% url 'web_doctor:patient_workspace' patient.id %}"
                hx-target="#main-content"
                hx-swap="innerHTML"
                data-patient-item
            >
            <div class="flex items-center ">
                <p class="text-sm font-medium text-gray-900 mr-3">{{ patient.name }}</p>
                <p class="text-sm text-gray-500">
                    性别：{{ patient.get_gender_display }} · 年龄：{{ patient.age|default:"-" }}
                </p></div>
                <div class="mt-2 mb-1 flex items-center text-sm text-gray-500">
                    <span>待办</span>
                    <span class="text-red-500 ml-1">
                        {% if patient.todo_count > 99 %}(99+){% else %}({{ patient.todo_count|default:0 }}){% endif %}
                    </span>
                    <span class="ml-3">咨询</span>
                    <span class="text-red-500 ml-1">
                        {% if patient.consult_count > 99 %}(99+){% else %}({{ patient.consult_count|default:0 }}){% endif %}
                    </span>
                </div>
            </button>
        </li>
    {% endfor %}
    
    <!-- 自动轮询更新 (3分钟) -->
    <li class="hidden"
        hx-get="{% url 'web_doctor:doctor_workspace_patient_list' %}"
        hx-trigger="every 180s"
        hx-target="#patient-list-container"
        hx-swap="innerHTML">
    </li>
{% else %}
    <li class="px-4 py-3 text-sm text-gray-400">暂无患者</li>
{% endif %}

<template id="patient-main-loading-template">
  {% include "web_doctor/partials/patient_workspace_loading.html" %}
</template>

<script>
(function () {
  const tmpl = document.getElementById("patient-main-loading-template");
  if (!tmpl) return;

  // 监听患者列表区域内的点击，在 htmx 请求真正发出前先替换 main 内容为 loading
    // 同时触发聊天窗口切换患者事件
    document.addEventListener("click", function (event) {
    const btn = event.target.closest("button[hx-get][hx-target='#main-content']");
    if (!btn) return;
    
    // 获取患者ID和姓名 (假设 URL 格式为 .../patient/<id>/ )
    // 更好的方式是直接在 button 上 data-patient-id
    // 但目前我们只有 URL，正则解析一下
    const url = btn.getAttribute('hx-get');
    const match = url.match(/patient\/(\d+)\//);
    const patientName = btn.querySelector('.text-gray-900').innerText;
    
    if (match) {
        const patientId = parseInt(match[1]);
        window.dispatchEvent(new CustomEvent('update-chat-patient', {
            detail: { id: patientId, name: patientName }
        }));
    }

    // 高亮当前选中的患者按钮
    document.querySelectorAll("button[data-patient-item]").forEach(function (item) {
      item.classList.remove("bg-indigo-50");
    });
    btn.classList.add("bg-indigo-50");

    const main = document.querySelector("#main-content");
    if (!main) return;
    const clone = tmpl.content ? tmpl.content.cloneNode(true) : null;
    if (!clone) return;
    main.innerHTML = "";
    main.appendChild(clone);
  });
})();
</script>
