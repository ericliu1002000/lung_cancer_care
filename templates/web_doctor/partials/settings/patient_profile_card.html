<div id="patient-profile-card" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[240px] flex flex-col md:flex-row">
    {# 左侧：个人资料 #}
    <div class="relative w-full md:w-1/2 border-b md:border-b-0 md:border-r border-slate-200 p-4 lg:p-5 flex flex-col">
        <div class="flex items-center justify-between mb-4 shrink-0">
            <h3 class="text-base font-bold text-slate-800 border-l-4 border-indigo-500 pl-3">个人资料</h3>
        </div>
         <div class="absolute bottom-4 right-4">
             <button onclick="document.getElementById('edit-profile-modal').showModal()" class="px-4 lg:px-6 py-1.5 bg-indigo-600 text-white text-sm rounded-full hover:bg-indigo-700 shadow-sm transition-colors">
                编辑
             </button> 
        </div>
        
        <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-y-2 gap-x-2 text-sm content-start overflow-y-auto">
            <div class="flex items-baseline">
                <span class="text-slate-500 w-20 lg:w-24 shrink-0 text-right mr-2 lg:mr-3">患者姓名</span>
                <span class="text-slate-800 font-medium truncate">{{ patient_info.name }}</span>
            </div>
            <div class="flex items-baseline">
                <span class="text-slate-500 w-20 lg:w-24 shrink-0 text-right mr-2 lg:mr-3">患者性别</span>
                <span class="text-slate-800 font-medium truncate">{{ patient_info.gender }}</span>
            </div>
            <div class="flex items-baseline">
                <span class="text-slate-500 w-20 lg:w-24 shrink-0 text-right mr-2 lg:mr-3">联系方式</span>
                <span class="text-slate-800 font-medium truncate">{{ patient_info.phone }}</span>
            </div>
            <div class="flex items-baseline">
                <span class="text-slate-500 w-20 lg:w-24 shrink-0 text-right mr-2 lg:mr-3">出生日期</span>
                <span class="text-slate-800 font-medium truncate">{{ patient_info.birth_date }}</span>
            </div>
            <div class="flex items-baseline col-span-1 lg:col-span-2">
                <span class="text-slate-500 w-20 lg:w-24 shrink-0 text-right mr-2 lg:mr-3">患者地址</span>
                <span class="text-slate-800 font-medium  truncate" title="{{ patient_info.address }}">{{ patient_info.address }}</span>
            </div>
            <div class="flex items-baseline col-span-1 lg:col-span-2">
                <span class="text-slate-500 w-24 lg:w-24 shrink-0 text-right mr-2 lg:mr-3">紧急联系人</span>
                <span class="text-slate-800 font-medium  truncate">
                    {{ patient_info.emergency_contact|default:"无" }} 
                </span>
            </div>
            <div class="flex items-baseline col-span-1 lg:col-span-2">
                <span class="text-slate-500  shrink-0 text-right mr-2 lg:mr-3">紧急联系人关系</span>
                <span class="text-slate-800 font-medium  truncate">
                    {{ patient_info.emergency_relation|default:"无" }} 
                </span>
            </div>
            <div class="flex items-baseline col-span-1 lg:col-span-2">
                <span class="text-slate-500  shrink-0 text-right mr-2 lg:mr-3">紧急联系人电话</span>
                <span class="text-slate-800 truncate">
                    {{ patient_info.emergency_phone|default:"无" }}
                </span>
            </div>
        </div>
    </div>

    {# 右侧：亲情账号 #}
    <div class="w-full md:w-1/2 p-4 lg:p-5 flex flex-col relative">
        <h3 class="text-base font-bold text-slate-800 border-l-4 border-indigo-500 pl-3 mb-4 shrink-0">亲情账号</h3>
        
        <div class="flex-1 overflow-y-auto max-h-[200px] pr-2 space-y-3">
            {% for relation in patient_info.relations %}
            <div class="flex flex-wrap lg:flex-nowrap items-center text-sm text-slate-700 gap-5">
                <span class=" shrink-0 ">姓名：{{ relation.name }}</span>
                <span class="shrink-0">关系：{{ relation.relation }}</span>
                <span class="shrink-0">手机号：{{ relation.phone|default:"无" }}</span>
            </div>
            {% empty %}
            <div class="text-sm text-slate-400 ">暂无亲情账号</div>
            {% endfor %}
        </div>

       
    </div>
</div>

{# 个人资料编辑弹框 #}
<dialog id="edit-profile-modal" class="rounded-xl shadow-xl backdrop:bg-slate-900/30 w-full max-w-2xl p-0 open:animate-fade-in">
    <div class="flex flex-col max-h-[90vh]">
        <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
            <h3 class="text-lg font-bold text-slate-800">编辑个人资料</h3>
            <button type="button" onclick="this.closest('dialog').close()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <form method="post" 
              hx-post="{% url 'web_doctor:patient_profile_update' patient.id %}" 
              hx-target="#patient-profile-card" 
              hx-swap="outerHTML"
              class="p-6 overflow-y-auto space-y-4" 
              onsubmit="return validateProfileForm(this)">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="block text-sm font-medium text-slate-700">患者姓名 <span class="text-rose-500">*</span></label>
                    <input type="text" placeholder="请输入患者姓名" name="name" value="{{ patient_info.name }}" required class="w-full rounded-lg  text-sm focus:border-[#6366f1] focus:outline-none border border-[#999999] p-2">
                </div>
                <div class="space-y-1">
                    <label class="block text-sm font-medium text-slate-700">联系方式 <span class="text-rose-500">*</span></label>
                    <input type="tel" name="phone" placeholder="请输入联系方式" value="{{ patient_info.phone }}" required class="w-full rounded-lg  text-sm focus:border-[#6366f1] focus:outline-none border border-[#999999] p-2">
                </div>
                <div class="space-y-1">
                    <label class="block text-sm font-medium text-slate-700">出生日期 <span class="text-rose-500">*</span></label>
                    <input type="date" name="birth_date" placeholder="请输入出生日期" value="{{ patient_info.birth_date }}" required class="w-full rounded-lg  text-sm focus:border-[#6366f1] focus:outline-none border border-[#999999] p-2">
                </div>
                 <div class="space-y-1">
                    <label class="block text-sm font-medium text-slate-700">性别</label>
                    <select name="gender" class="w-full rounded-lg  text-sm focus:border-[#6366f1] focus:outline-none border border-[#999999] p-2">
                        <option value="男" {% if patient_info.gender == '男' %}selected{% endif %}>男</option>
                        <option value="女" {% if patient_info.gender == '女' %}selected{% endif %}>女</option>
                    </select>
                </div>
                <div class="space-y-1 md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700">患者地址 <span class="text-rose-500">*</span></label>
                    <input type="text" name="address" placeholder="请输入患者地址" value="{{ patient_info.address }}" required class="border border-[#999999] p-2 w-full rounded-lg  text-sm focus:border-[#6366f1] focus:outline-none">
                </div>
                
                <div class="md:col-span-2 pt-2 pb-1 border-t border-dashed  mt-2">
                    <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">紧急联系人信息</span>
                </div>

                <div class="space-y-1">
                    <label class="block text-sm font-medium text-slate-700">紧急联系人 <span class="text-rose-500">*</span></label>
                    <input type="text" name="emergency_contact" placeholder="请输入患者紧急联系人" value="{{ patient_info.emergency_contact }}" required class="border border-[#999999] p-2 w-full rounded-lg  text-sm focus:border-[#6366f1] focus:outline-none">
                </div>
                <div class="space-y-1">
                    <label class="block text-sm font-medium text-slate-700">紧急联系人关系 <span class="text-rose-500">*</span></label>
                    <input type="text" name="emergency_relation" placeholder="请输入紧急联系人关系" value="{{ patient_info.emergency_relation }}" required class="border border-[#999999] p-2 w-full rounded-lg  text-sm focus:border-[#6366f1] focus:outline-none">
                </div>
                <div class="space-y-1 md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700">紧急联系人联系电话 <span class="text-rose-500">*</span></label>
                    <input type="tel" name="emergency_phone" placeholder="请输入紧急联系人联系电话" value="{{ patient_info.emergency_phone }}" required class="border border-[#999999] p-2 w-full rounded-lg text-sm focus:border-[#6366f1] focus:outline-none">
                </div>
            </div>
            
            <div id="profile-error-msg" class="text-rose-500 text-sm hidden bg-rose-50 p-2 rounded border border-rose-100  items-center gap-2">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>请确保所有带星号的必填项都不为空。</span>
            </div>

            <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-100 mt-6">
                <button type="button" onclick="this.closest('dialog').close()" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 rounded-lg transition-colors">取消</button>
                <button type="submit" class="px-6 py-2 text-sm text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm transition-colors">确定保存</button>
            </div>
        </form>
    </div>
</dialog>

<script>
function validateProfileForm(form) {
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            isValid = false;
            field.classList.add('border-rose-300', 'ring-1', 'ring-rose-200');
        } else {
            field.classList.remove('border-rose-300', 'ring-1', 'ring-rose-200');
        }
    });

    const errorMsg = document.getElementById('profile-error-msg');
    if (!isValid) {
        errorMsg.classList.remove('hidden');
        // 自动定位到第一个错误项
        form.querySelector(':invalid')?.focus();
        return false;
    }
    
    errorMsg.classList.add('hidden');
    // 此处仅为演示关闭，实际业务中应使用 AJAX/HTMX 提交
    form.closest('dialog').close();
    return true; // 允许表单提交（或在 HTMX 中处理）
}

// 监听输入，实时消除错误状态
document.getElementById('edit-profile-modal').addEventListener('input', function(e) {
    if (e.target.hasAttribute('required') && e.target.value.trim()) {
        e.target.classList.remove('border-rose-300', 'ring-1', 'ring-rose-200');
    }
});
</script>
