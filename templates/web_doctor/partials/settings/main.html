<div class="space-y-6 max-w-6xl mx-auto pb-10">

    <style>
      /* 一般监测区域加载态：请求过程中弱化开关，并显示“保存中...” */
      #monitoring-form .monitoring-loading { display: none; }
      #monitoring-form.htmx-request .monitoring-loading { display: inline-flex; }
      #monitoring-form.htmx-request [data-monitoring-switch] { opacity: 0.5; pointer-events: none; }
    </style>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
        <form
            id="monitoring-form"
            method="post"
            hx-post="{% url 'web_doctor:patient_monitoring_update' patient.id %}"
            hx-trigger="change"
            hx-swap="none"
            class="space-y-4"
        >
            {% csrf_token %}
            <div class="flex items-center justify-between">
                <h3 class="text-base font-bold text-slate-800 flex items-center gap-3">
                    <span class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        一般监测
                    </span>
                    <span class="monitoring-loading inline-flex items-center gap-2 text-sm text-slate-400">
                        <span class="w-3 h-3 border-2 border-slate-300 border-t-transparent rounded-full animate-spin"></span>
                        <span>保存中...</span>
                    </span>
                </h3>
                <div class="text-sm text-slate-500 flex items-center gap-2">
                    <span>监测频率：</span>
                    <select
                        name="check_freq_days"
                        class="bg-slate-50 border-none text-sm font-medium text-slate-700 py-1 pl-2 pr-8 rounded-md focus:ring-1 focus:ring-indigo-500"
                    >
                        <option value="1" {% if monitoring_config.check_freq_days == 1 %}selected{% endif %}>每天</option>
                        <option value="2" {% if monitoring_config.check_freq_days == 2 %}selected{% endif %}>每2天</option>
                        <option value="7" {% if monitoring_config.check_freq_days == 7 %}selected{% endif %}>每周</option>
                    </select>
                </div>
            </div>

            <div class="flex flex-wrap gap-6">
                {% for item in monitoring_items %}
                <label class="flex items-center gap-3 cursor-pointer group" data-monitoring-switch>
                    <span class="text-sm font-medium text-slate-700">{{ item.label }}</span>
                    <input
                        type="checkbox"
                        name="{{ item.field_name }}"
                        class="sr-only peer"
                        {% if item.is_checked %}checked{% endif %}
                    >
                    <div
                        class="inline-flex h-6 w-11 items-center rounded-full bg-slate-200 transition-colors duration-200 justify-start peer-checked:justify-end peer-checked:bg-emerald-500 focus-within:ring-2 focus-within:ring-indigo-500 focus-within:ring-offset-2"
                    >
                        <span
                            class="h-4 w-4 rounded-full bg-white transition-transform duration-200"
                        ></span>
                    </div>
                </label>
                {% endfor %}
            </div>
        </form>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between bg-slate-50/50">
            <div class="flex items-center gap-4">
                <h3 class="text-base font-bold text-slate-800 border-l-4 border-indigo-500 pl-3">医院计划设置</h3>
                {% if active_cycle %}
                    <span class="text-sm text-slate-600 bg-white border border-slate-200 px-3 py-1 rounded-md shadow-sm">
                        当前疗程：<span class="font-bold text-slate-900">{{ active_cycle.name }}</span>
                    </span>
                    <span class="text-sm text-slate-400">
                        {{ active_cycle.start_date }} 开始
                    </span>
                {% else %}
                    <span class="text-sm text-slate-400 italic">当前无进行中疗程</span>
                {% endif %}
            </div>
            <div class="text-sm text-indigo-600 flex items-center gap-3">
                {% if cycle_form_errors %}
                    <span class="text-sm text-rose-500">
                        {{ cycle_form_errors.0 }}
                    </span>
                {% endif %}
                <span class="text-sm text-slate-400">疗程按结束时间倒序展示，最多 10 条</span>
            </div>
        </div>

        <div class="px-5 py-4 border-b border-slate-200">
            {% if cycle_page.paginator.count == 0 %}
                <div class="p-6 text-center text-sm text-slate-500">
                    <p class="mb-4">当前患者尚未创建任何治疗疗程，请先创建首个疗程。</p>
                </div>
            {% else %}
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <h4 class="text-sm font-semibold text-slate-700">疗程列表</h4>
                        <span class="text-sm text-slate-400">
                            共 {{ cycle_page.paginator.count }} 个疗程，当前第 {{ cycle_page.number }}/{{ cycle_page.paginator.num_pages }} 页
                        </span>
                    </div>
                    <div class="space-y-2">
                        {% for cycle in cycle_page %}
                        <div class="border border-slate-200 rounded-lg bg-white">
                            <button
                                type="button"
                                class="w-full flex items-center justify-between px-4 py-2 text-sm hover:bg-slate-50 {% if selected_cycle and cycle.id == selected_cycle.id %}bg-indigo-50{% endif %}"
                                hx-get="{% url 'web_doctor:patient_workspace_section' patient.id 'settings' %}?tc_page={{ cycle_page.number }}&cycle_id={{ cycle.id }}"
                                hx-target="#patient-content"
                                hx-swap="innerHTML"
                            >
                                <div class="flex flex-col text-left">
                                    <span class="font-medium text-slate-800">
                                        {{ cycle.name }}
                                        {% if selected_cycle and cycle.id == selected_cycle.id %}
                                            <span class="ml-2 text-sm text-emerald-600 border border-emerald-200 rounded-full px-2 py-0.5">当前疗程</span>
                                        {% endif %}
                                    </span>
                                    <span class="text-sm text-slate-500">
                                        {{ cycle.start_date }} ~ {{ cycle.end_date }} · 状态：{{ cycle.get_status_display }}
                                    </span>
                                </div>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% if cycle_page.has_previous or cycle_page.has_next %}
                    <div class="flex justify-end gap-2 text-sm text-slate-500 pt-1">
                        {% if cycle_page.has_previous %}
                            <button
                                type="button"
                                class="px-2 py-1 border border-slate-200 rounded hover:bg-slate-50"
                                hx-get="{% url 'web_doctor:patient_workspace_section' patient.id 'settings' %}?tc_page={{ cycle_page.previous_page_number }}"
                                hx-target="#patient-content"
                                hx-swap="innerHTML"
                            >
                                上一页
                            </button>
                        {% endif %}
                        {% if cycle_page.has_next %}
                            <button
                                type="button"
                                class="px-2 py-1 border border-slate-200 rounded hover:bg-slate-50"
                                hx-get="{% url 'web_doctor:patient_workspace_section' patient.id 'settings' %}?tc_page={{ cycle_page.next_page_number }}"
                                hx-target="#patient-content"
                                hx-swap="innerHTML"
                            >
                                下一页
                            </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        {% if selected_cycle %}
        <div class="px-5 py-4 border-t border-dashed border-slate-200">
            {% include "web_doctor/partials/settings/plan_table.html" with cycle=selected_cycle patient=patient %}
        </div>
        {% endif %}

        <div class="px-5 py-4 border-t border-dashed border-slate-200 mt-2">
            <h4 class="text-sm font-semibold text-slate-700 mb-3">创建新疗程</h4>
            <form
                id="treatment-cycle-form"
                method="post"
                hx-post="{% url 'web_doctor:patient_treatment_cycle_create' patient.id %}"
                hx-target="#patient-content"
                hx-swap="innerHTML"
                class="flex flex-wrap items-end gap-4 text-sm"
            >
                {% csrf_token %}
                <div class="flex flex-col gap-1">
                    <label class="text-sm text-slate-500">疗程名称</label>
                    <input
                        type="text"
                        name="name"
                        value="{{ cycle_form_initial.name|default:'' }}"
                        placeholder="例如：术后辅助治疗第1阶段"
                        class="border border-slate-200 rounded px-2 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 min-w-[220px]"
                        required
                    >
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-sm text-slate-500">开始日期</label>
                    <input
                        type="date"
                        name="start_date"
                        value="{{ cycle_form_initial.start_date|default:'' }}"
                        data-cycle-start
                        class="border border-slate-200 rounded px-2 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                    >
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-sm text-slate-500">周期天数</label>
                    <select
                        name="cycle_days"
                        data-cycle-days
                        class="w-28 border border-slate-200 rounded px-2 py-1.5 text-sm bg-white focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                    >
                        {% with selected_days=cycle_form_initial.cycle_days|default:'21' %}
                        <option value="21" {% if selected_days != '28' %}selected{% endif %}>21 天</option>
                        <option value="28" {% if selected_days == '28' %}selected{% endif %}>28 天</option>
                        {% endwith %}
                    </select>
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-sm text-slate-500">预计结束日期（自动计算）</label>
                    <div class="h-9 flex items-center px-2 rounded border border-dashed border-slate-200 bg-slate-50 text-sm text-slate-500">
                        <span data-cycle-end-display class="tabular-nums"></span>
                    </div>
                </div>
                <button
                    type="submit"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm"
                >
                    创建疗程
                </button>
            </form>
        </div>

    </div>
</div>
</div>

<style>
  /* 用药计划：剂量/频次未保存与已保存的底色提示 */
  .plan-field-dirty {
    background-color: #fef9c3; /* 近似 Tailwind amber-100 */
  }
  .plan-field-saved {
    background-color: #ecfdf3; /* 近似 Tailwind emerald-50 */
  }
</style>

<script>
// 在创建疗程表单中，根据开始日期与周期天数自动计算结束日期，仅展示不可编辑
(function () {
  const form = document.getElementById("treatment-cycle-form");
  if (!form) return;

  const startInput = form.querySelector("[data-cycle-start]");
  const daysSelect = form.querySelector("[data-cycle-days]");
  const endDisplay = form.querySelector("[data-cycle-end-display]");

  if (!startInput || !daysSelect || !endDisplay) return;

  function formatDate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return y + "-" + m + "-" + day;
  }

  function updateEndDate() {
    const startValue = startInput.value;
    const days = parseInt(daysSelect.value || "21", 10);
    if (!startValue || Number.isNaN(days) || days <= 0) {
      endDisplay.textContent = "";
      return;
    }
    const start = new Date(startValue + "T00:00:00");
    if (Number.isNaN(start.getTime())) {
      endDisplay.textContent = "";
      return;
    }
    const end = new Date(start);
    end.setDate(end.getDate() + days - 1);
    endDisplay.textContent = formatDate(end);
  }

  startInput.addEventListener("change", updateEndDate);
  daysSelect.addEventListener("change", updateEndDate);
  // 初次渲染时计算一次
  updateEndDate();
})();

// 复查计划：左侧开关控制后续日期选择是否可编辑（仅前端视觉与交互）
(function () {
  function initCheckupRows(root) {
    const scope = root || document;
    const rows = scope.querySelectorAll("[data-checkup-row]");
    rows.forEach((row) => {
      if (row.dataset.checkupInitialized === "1") return;
      const toggle = row.querySelector("[data-checkup-toggle]");
      const slots = row.querySelectorAll("[data-checkup-slot]");
      if (!toggle || !slots.length) return;

      function sync() {
        const enabled = toggle.checked;
        slots.forEach((input) => {
          const isReadonly = input.hasAttribute("data-readonly");
          if (isReadonly) {
            // 历史执行日：始终禁用，仅保持灰色展示
            input.disabled = true;
            input.classList.add("opacity-50", "cursor-not-allowed");
            return;
          }
          input.disabled = !enabled;
          input.classList.toggle("opacity-50", !enabled);
          input.classList.toggle("cursor-not-allowed", !enabled);
        });
        row.classList.toggle("opacity-60", !enabled);
      }

      toggle.addEventListener("change", sync);
      sync();
      row.dataset.checkupInitialized = "1";
    });
  }

  // 初次渲染时处理一次
  initCheckupRows(document);

  // 每次 plan 表格通过 HTMX 局部刷新后，重新初始化新插入的行
  document.body.addEventListener("htmx:afterSwap", function (event) {
    const target = event.target;
    if (!target) return;
    if (target.id === "plan-table-container" || (target.closest && target.closest("#plan-table-container"))) {
      initCheckupRows(target);
    }
  });
})();

// 问卷计划：左侧开关控制后续日期选择是否可编辑（与复查计划交互一致）
(function () {
  function initQuestionnaireRows(root) {
    const scope = root || document;
    const rows = scope.querySelectorAll("[data-questionnaire-row]");
    rows.forEach((row) => {
      if (row.dataset.questionnaireInitialized === "1") return;
      const toggle = row.querySelector("[data-questionnaire-toggle]");
      const slots = row.querySelectorAll("[data-questionnaire-slot]");
      if (!toggle || !slots.length) return;

      function sync() {
        const enabled = toggle.checked;
        slots.forEach((input) => {
          const isReadonly = input.hasAttribute("data-readonly");
          if (isReadonly) {
            input.disabled = true;
            input.classList.add("opacity-50", "cursor-not-allowed");
            return;
          }
          input.disabled = !enabled;
          input.classList.toggle("opacity-50", !enabled);
          input.classList.toggle("cursor-not-allowed", !enabled);
        });
        row.classList.toggle("opacity-60", !enabled);
      }

      toggle.addEventListener("change", sync);
      sync();
      row.dataset.questionnaireInitialized = "1";
    });
  }

  // 初次渲染时处理一次
  initQuestionnaireRows(document);

  // 每次 plan 表格通过 HTMX 局部刷新后，重新初始化新插入的问卷行
  document.body.addEventListener("htmx:afterSwap", function (event) {
    const target = event.target;
    if (!target) return;
    if (target.id === "plan-table-container" || (target.closest && target.closest("#plan-table-container"))) {
      initQuestionnaireRows(target);
    }
  });
})();

// 用药计划：本地过滤药品库并通过下拉选择加入当前疗程（事件委托，兼容 htmx 局部刷新）
(function () {
  if (window.__medSearchDelegated) return;
  window.__medSearchDelegated = true;

  function getContainer(el) {
    return el.closest("[data-med-search-container]");
  }

  function getElements(container) {
    if (!container) return {};
    const searchInput = container.querySelector("[data-med-search-input]");
    const list = container.querySelector("[data-med-search-list]");
    const hiddenId = container.querySelector("[data-med-library-id]");
    const options = list ? Array.from(list.querySelectorAll("[data-med-option]")) : [];
    return { searchInput, list, hiddenId, options };
  }

  function getVisibleOptions(options) {
    return options.filter((btn) => !btn.classList.contains("hidden"));
  }

  function setActiveIndex(container, options, index) {
    const visible = getVisibleOptions(options);
    if (!visible.length) {
      container.dataset.medActiveIndex = "-1";
      return;
    }
    if (index < 0) index = visible.length - 1;
    if (index >= visible.length) index = 0;
    container.dataset.medActiveIndex = String(index);
    visible.forEach((btn, i) => {
      btn.classList.toggle("bg-indigo-50", i === index);
    });
  }

  function filterOptionsForInput(input) {
    const container = getContainer(input);
    if (!container) return;
    const { list, options } = getElements(container);
    if (!list || !options.length) return;

    const q = (input.value || "").trim().toLowerCase();
    if (!q) {
      options.forEach((btn) => btn.classList.add("hidden"));
      list.classList.add("hidden");
      container.dataset.medActiveIndex = "-1";
      return;
    }

    let anyVisible = false;
    options.forEach((btn) => {
      const keywords = (btn.getAttribute("data-med-keywords") || "").toLowerCase();
      const match = keywords.indexOf(q) !== -1;
      btn.classList.toggle("hidden", !match);
      if (match) anyVisible = true;
    });
    list.classList.toggle("hidden", !anyVisible);
    if (anyVisible) {
      setActiveIndex(container, options, 0);
    } else {
      container.dataset.medActiveIndex = "-1";
    }
  }

  function chooseOption(btn) {
    const container = getContainer(btn);
    if (!container) return;
    const { searchInput, list, hiddenId } = getElements(container);
    if (!searchInput || !list || !hiddenId) return;

    const id = btn.getAttribute("data-med-id");
    const label = btn.getAttribute("data-med-label") || "";
    if (!id) return;
    hiddenId.value = id;
    searchInput.value = label;
    list.classList.add("hidden");
    const form = searchInput.form;
    if (form) {
      form.requestSubmit ? form.requestSubmit() : form.submit();
    }
  }

  // 输入时过滤
  document.body.addEventListener("input", function (event) {
    const input = event.target;
    if (!input || !input.matches || !input.matches("[data-med-search-input]")) return;
    filterOptionsForInput(input);
  });

  // 键盘交互：上下箭头移动，回车选择
  document.body.addEventListener("keydown", function (event) {
    const input = event.target;
    if (!input || !input.matches || !input.matches("[data-med-search-input]")) return;

    const container = getContainer(input);
    if (!container) return;
    const { options } = getElements(container);
    if (!options.length) return;

    const visible = getVisibleOptions(options);
    if (!visible.length) return;

    let activeIndex = parseInt(container.dataset.medActiveIndex || "-1", 10);
    if (Number.isNaN(activeIndex)) activeIndex = -1;

    if (event.key === "ArrowDown" || event.key === "Down") {
      event.preventDefault();
      setActiveIndex(container, options, activeIndex + 1);
    } else if (event.key === "ArrowUp" || event.key === "Up") {
      event.preventDefault();
      setActiveIndex(container, options, activeIndex - 1);
    } else if (event.key === "Enter") {
      event.preventDefault();
      const idx = activeIndex >= 0 ? activeIndex : 0;
      const visibleNow = getVisibleOptions(options);
      const target = visibleNow[idx] || visibleNow[0];
      if (target) {
        chooseOption(target);
      }
    }
  });

  // 点击候选项
  document.body.addEventListener("click", function (event) {
    const btn = event.target && event.target.closest && event.target.closest("[data-med-option]");
    if (!btn) return;
    chooseOption(btn);
  });
})();

// 用药计划：剂量/频次字段的“未保存 / 已保存”提示
(function () {
  if (window.__planFieldSaveHooksInstalled) return;
  window.__planFieldSaveHooksInstalled = true;

  // 输入发生变化时，标记为“未保存”状态（黄色底）
  document.body.addEventListener("input", function (event) {
    const input = event.target;
    if (!input || !input.getAttribute) return;
    if (!input.getAttribute("data-plan-field")) return;
    input.classList.add("plan-field-dirty");
  });

  // 提交成功后，移除“未保存”标记，短暂展示绿色底提示
  document.body.addEventListener("htmx:afterRequest", function (event) {
    const source = event.target;
    if (!source) return;

    let input = null;
    if (source.getAttribute && source.getAttribute("data-plan-field")) {
      input = source;
    } else if (source.querySelector) {
      input = source.querySelector("[data-plan-field]");
    }
    if (!input) return;

    input.classList.remove("plan-field-dirty");
    input.classList.add("plan-field-saved");
    setTimeout(function () {
      input.classList.remove("plan-field-saved");
    }, 600);
  });
})();

// 计划表：统一处理勾选类控件的“请求中锁定 / 成功高亮 / 失败回滚”
(function () {
  if (window.__planAtomicCheckboxHooksInstalled) return;
  window.__planAtomicCheckboxHooksInstalled = true;

  function getAtomicCheckbox(event) {
    const detail = event.detail || {};
    const elt = detail.elt || event.target;
    if (!elt) return null;
    if (elt.matches && elt.matches("input[type='checkbox'][data-atomic-checkbox]")) {
      return elt;
    }
    return null;
  }

  document.body.addEventListener("htmx:beforeRequest", function (event) {
    const checkbox = getAtomicCheckbox(event);
    if (!checkbox) return;
    checkbox.dataset.prevChecked = checkbox.checked ? "1" : "0";
    checkbox.disabled = true;
    checkbox.classList.add("opacity-50", "cursor-wait");
  });

  document.body.addEventListener("htmx:afterRequest", function (event) {
    const checkbox = getAtomicCheckbox(event);
    if (!checkbox) return;
    checkbox.disabled = false;
    checkbox.classList.remove("cursor-wait");
    checkbox.classList.remove("opacity-50");
    checkbox.classList.add("ring-2", "ring-emerald-400");
    setTimeout(function () {
      checkbox.classList.remove("ring-2", "ring-emerald-400");
    }, 500);
    delete checkbox.dataset.prevChecked;
  });

  function handleError(event) {
    const checkbox = getAtomicCheckbox(event);
    if (!checkbox) return;
    checkbox.disabled = false;
    checkbox.classList.remove("cursor-wait");
    checkbox.classList.remove("opacity-50");
    const prev = checkbox.dataset.prevChecked;
    if (prev !== undefined) {
      checkbox.checked = prev === "1";
    }
    checkbox.classList.add("ring-2", "ring-rose-400");
    setTimeout(function () {
      checkbox.classList.remove("ring-2", "ring-rose-400");
    }, 700);
  }

  document.body.addEventListener("htmx:responseError", handleError);
  document.body.addEventListener("htmx:sendError", handleError);
})();

// 计划表通用错误提示：监听 HX-Trigger 触发的 plan-error 事件
(function () {
  if (window.__planErrorToastInstalled) return;
  window.__planErrorToastInstalled = true;

  function showPlanError(message) {
    if (!message) return;
    let container = document.getElementById("plan-error-toast");
    if (!container) {
      container = document.createElement("div");
      container.id = "plan-error-toast";
      container.className =
        "fixed bottom-4 right-4 max-w-sm bg-rose-600 text-white text-sm px-3 py-2 rounded shadow-lg z-50";
      document.body.appendChild(container);
    }
    container.textContent = message;
    container.style.display = "block";
    clearTimeout(container._hideTimer);
    container._hideTimer = setTimeout(function () {
      container.style.display = "none";
    }, 4000);
  }

  document.body.addEventListener("plan-error", function (event) {
    const detail = event.detail || {};
    const msg = detail.message || "";
    showPlanError(msg);
  });
})();
</script>
