{# å•ä¸ªç–—ç¨‹çš„è®¡åˆ’è§†å›¾ï¼šç”¨è¯ + å¤æŸ¥ + éšè®¿ #}
{% load plan_dates %}

<div id="plan-table-container" class="overflow-x-auto mt-3">
  <table class="w-full text-left border-collapse">
    <thead>
      <tr class="bg-slate-50 text-sm uppercase text-slate-500 border-b border-slate-200">
        <th class="px-4 py-3 font-semibold w-48">é¡¹ç›®åç§°</th>
        <th class="px-2 py-3 font-semibold w-24">å‰‚é‡/é…ç½®</th>
        <th class="px-2 py-3 font-semibold w-24">é»˜è®¤é¢‘æ¬¡</th>
        {% for i in "x"|rjust:"21" %}
        <th
          class="cursor-pointer px-1 py-3 font-medium text-center w-8 {% if forloop.counter == 1 or forloop.counter == 8 or forloop.counter == 15 %}text-sm text-slate-800{% else %}text-[10px] text-slate-400{% endif %} {% if forloop.counter|divisibleby:7 %}border-r border-gray-200{% endif %}"
          data-plan-day="{{ forloop.counter }}"
          data-plan-label="D{{ forloop.counter }}"
          data-plan-date="{% if cycle and cycle.start_date %}{{ cycle.start_date|add_days:forloop.counter0|date:'m/d' }}{% endif %}"
        >
          D{{ forloop.counter }}
        </th>
        {% endfor %}
      </tr>
    </thead>

    <tbody class="divide-y divide-slate-100 group-section">
      <tr class="bg-slate-50/30">
        <td colspan="24" class="px-4 py-2 text-sm font-bold text-indigo-700 bg-indigo-50/40">
          ğŸ“ˆ ä¸€èˆ¬ç›‘æµ‹è®¡åˆ’
        </td>
      </tr>
      {% with current_day=plan_view.current_day_index|default:1 %}
      {% for monitoring in plan_view.monitorings %}
        {% include "web_doctor/partials/settings/plan_table_monitoring_row.html" with monitoring=monitoring patient=patient cycle=cycle current_day=current_day %}
      {% endfor %}
      {% endwith %}
    </tbody>

    <tbody class="divide-y divide-slate-100 border-t border-slate-200">
      <tr class="bg-slate-50/30">
        <td colspan="24" class="px-4 py-2 text-sm font-bold text-indigo-600 bg-indigo-50/30">
          <div class="flex items-center justify-between">
            <span>ğŸ’Š ç”¨è¯è®¡åˆ’</span>
            {% if cycle and patient %}
            <div class="relative text-sm" data-med-search-container>
              <form
                method="post"
                hx-post="{% url 'web_doctor:patient_cycle_medication_add' patient.id cycle.id %}"
                hx-target="#plan-table-container"
                hx-swap="outerHTML"
                class="flex items-center gap-2"
              >
                {% csrf_token %}
                <input type="hidden" name="library_id" value="" data-med-library-id>
                <input
                  type="text"
                  name="q"
                  placeholder="æœç´¢è¯å“/æ‹¼éŸ³ï¼Œå›è½¦æ·»åŠ "
                  class="h-7 w-52 rounded border border-slate-200 bg-white px-2 py-1 placeholder:text-slate-300 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-slate-50 disabled:text-slate-400 disabled:cursor-not-allowed"
                  autocomplete="off"
                  data-med-search-input
                  {% if not is_cycle_editable %}disabled{% endif %}
                >
              </form>
              <div
                class="absolute mt-1 w-64 max-h-56 overflow-y-auto bg-white border border-slate-200 rounded-md shadow-md z-10 hidden"
                data-med-search-list
              >
                {% for med in plan_view.med_library %}
                <button
                  type="button"
                  class="w-full px-3 py-1.5 text-left text-sm text-slate-700 hover:bg-indigo-50 flex justify-between items-center hidden"
                  data-med-option
                  data-med-id="{{ med.lib_id }}"
                  data-med-label="{{ med.name }}"
                  data-med-keywords="{{ med.keywords }}"
                >
                  <span class="truncate">
                    {{ med.name }}
                    <span class="text-[10px] text-slate-400 ml-1">{{ med.type }}</span>
                  </span>
                  {% if med.default_dosage %}
                  <span class="ml-2 text-[10px] text-slate-400">{{ med.default_dosage }}</span>
                  {% endif %}
                </button>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
        </td>
      </tr>
      {% with current_day=plan_view.current_day_index|default:1 %}
        {% for med in plan_view.medications %}
          {% include "web_doctor/partials/settings/plan_table_medication_row.html" with med=med patient=patient cycle=cycle current_day=current_day is_cycle_editable=is_cycle_editable %}
        {% endfor %}
      {% endwith %}
    </tbody>

    <tbody class="divide-y divide-slate-100 border-t border-slate-200">
      <tr class="bg-slate-50/30">
        <td colspan="24" class="px-4 py-2 text-sm font-bold text-sky-600 bg-sky-50/30">
          ğŸ“„ å¤æŸ¥è®¡åˆ’
        </td>
      </tr>
      {% with current_day=plan_view.current_day_index|default:1 %}
      {% for check in plan_view.checkups %}
        {% include "web_doctor/partials/settings/plan_table_checkup_row.html" with check=check patient=patient cycle=cycle current_day=current_day %}
      {% endfor %}
      {% endwith %}
    </tbody>

    <tbody class="divide-y divide-slate-100 border-t border-slate-200">
      <tr class="bg-slate-50/30">
        <td colspan="24" class="px-4 py-2 text-sm font-bold text-emerald-600 bg-emerald-50/30">
          ğŸ§¾ é—®å·è®¡åˆ’
        </td>
      </tr>
      {% with current_day=plan_view.current_day_index|default:1 %}
      {% for questionnaire in plan_view.questionnaires %}
        {% include "web_doctor/partials/settings/plan_table_questionnaire_row.html" with questionnaire=questionnaire patient=patient cycle=cycle current_day=current_day is_cycle_editable=is_cycle_editable %}
      {% endfor %}
      {% endwith %}
    </tbody>
  </table>

  <div
    id="plan-day-tooltip"
    class="fixed z-50 hidden max-w-[260px] rounded-md border border-slate-200 bg-white px-3 py-2 text-xs text-slate-700 shadow-lg opacity-0 translate-y-1 transition-opacity transition-transform duration-150 sm:max-w-[320px] sm:text-sm"
    role="tooltip"
    aria-hidden="true"
  >
    <div class="flex items-center justify-between gap-3">
      <div class="font-semibold text-slate-900" data-plan-tooltip-title></div>
      <div class="text-slate-500 font-medium tabular-nums" data-plan-tooltip-date></div>
    </div>
    <div class="mt-1 text-[11px] text-slate-500 sm:text-xs" data-plan-tooltip-desc></div>
  </div>
</div>

<script>
  (function() {
    if (window.__planDayTooltipBound) return;
    window.__planDayTooltipBound = true;

    var showDelayMs = 300;
    var hideAfterMs = 160;
    var activeTarget = null;
    var showTimer = null;
    var hideTimer = null;

    function getTooltipEl() {
      return document.getElementById('plan-day-tooltip');
    }

    function clearTimers() {
      if (showTimer) {
        clearTimeout(showTimer);
        showTimer = null;
      }
      if (hideTimer) {
        clearTimeout(hideTimer);
        hideTimer = null;
      }
    }

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function setTooltipContent(tooltipEl, targetEl) {
      var label = targetEl.getAttribute('data-plan-label') || '';
      var date = targetEl.getAttribute('data-plan-date') || '';
      var titleEl = tooltipEl.querySelector('[data-plan-tooltip-title]');
      var dateEl = tooltipEl.querySelector('[data-plan-tooltip-date]');
      var descEl = tooltipEl.querySelector('[data-plan-tooltip-desc]');

      if (titleEl) titleEl.textContent = label;
      if (dateEl) dateEl.textContent = date ? date : '--/--';
      if (descEl) descEl.textContent = 'åŸºäºå½“å‰é€‰ä¸­çš„ç–—ç¨‹å¼€å§‹æ—¥æœŸæ¨ç®—ï¼ˆæŒ‰å¤©åºé—´éš”è‡³ç»“æŸæ—¥æœŸï¼‰';
    }

    function positionTooltip(tooltipEl, targetEl) {
      var padding = 8;
      var rect = targetEl.getBoundingClientRect();

      tooltipEl.style.left = '0px';
      tooltipEl.style.top = '0px';
      tooltipEl.classList.remove('hidden');

      var tooltipRect = tooltipEl.getBoundingClientRect();
      var viewportW = window.innerWidth;
      var viewportH = window.innerHeight;

      var left = rect.left + rect.width / 2 - tooltipRect.width / 2;
      left = clamp(left, padding, viewportW - tooltipRect.width - padding);

      var top = rect.top - tooltipRect.height - 10;
      if (top < padding) {
        top = rect.bottom + 10;
      }
      top = clamp(top, padding, viewportH - tooltipRect.height - padding);

      tooltipEl.style.left = Math.round(left) + 'px';
      tooltipEl.style.top = Math.round(top) + 'px';
    }

    function showTooltip(targetEl) {
      var tooltipEl = getTooltipEl();
      if (!tooltipEl || !targetEl) return;

      setTooltipContent(tooltipEl, targetEl);
      positionTooltip(tooltipEl, targetEl);

      tooltipEl.setAttribute('aria-hidden', 'false');
      tooltipEl.classList.remove('opacity-0', 'translate-y-1');
      tooltipEl.classList.add('opacity-100', 'translate-y-0');
    }

    function hideTooltip() {
      var tooltipEl = getTooltipEl();
      if (!tooltipEl) return;

      tooltipEl.setAttribute('aria-hidden', 'true');
      tooltipEl.classList.add('opacity-0', 'translate-y-1');
      tooltipEl.classList.remove('opacity-100', 'translate-y-0');

      hideTimer = setTimeout(function() {
        tooltipEl.classList.add('hidden');
      }, hideAfterMs);
    }

    function scheduleShow(targetEl) {
      clearTimers();
      showTimer = setTimeout(function() {
        activeTarget = targetEl;
        showTooltip(targetEl);
      }, showDelayMs);
    }

    function scheduleHide(targetEl) {
      if (targetEl && activeTarget && targetEl !== activeTarget) return;
      clearTimers();
      hideTooltip();
      activeTarget = null;
    }

    document.addEventListener('mouseover', function(e) {
      var cell = e.target && e.target.closest ? e.target.closest('[data-plan-day]') : null;
      if (!cell) return;
      scheduleShow(cell);
    });

    document.addEventListener('mouseout', function(e) {
      var cell = e.target && e.target.closest ? e.target.closest('[data-plan-day]') : null;
      if (!cell) return;
      var related = e.relatedTarget && e.relatedTarget.closest ? e.relatedTarget.closest('[data-plan-day]') : null;
      if (related === cell) return;
      scheduleHide(cell);
    });

    document.addEventListener('focusin', function(e) {
      var cell = e.target && e.target.closest ? e.target.closest('[data-plan-day]') : null;
      if (!cell) return;
      scheduleShow(cell);
    });

    document.addEventListener('focusout', function(e) {
      var cell = e.target && e.target.closest ? e.target.closest('[data-plan-day]') : null;
      if (!cell) return;
      scheduleHide(cell);
    });

    window.addEventListener('scroll', function() {
      if (!activeTarget) return;
      var tooltipEl = getTooltipEl();
      if (!tooltipEl) return;
      positionTooltip(tooltipEl, activeTarget);
    }, true);

    window.addEventListener('resize', function() {
      if (!activeTarget) return;
      var tooltipEl = getTooltipEl();
      if (!tooltipEl) return;
      positionTooltip(tooltipEl, activeTarget);
    });
  })();
</script>
