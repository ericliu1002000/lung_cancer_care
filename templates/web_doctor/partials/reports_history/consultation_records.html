<div id="consultation-records-root" class="space-y-4" 
     hx-get="{% url 'web_doctor:patient_workspace_section' patient.id 'reports' %}?tab=records"
     hx-trigger="refresh-records-list from:body"
     hx-target="#patient-content"
     hx-swap="innerHTML"
     hx-indicator="#workspace-loading-overlay"
     hx-include="[name='csrfmiddlewaretoken']"
     x-data="{
    filters: {
        recordType: '{{ request.GET.recordType|default:"all" }}',
        reportDateStart: '{{ request.GET.reportDateStart|default:"" }}',
        reportDateEnd: '{{ request.GET.reportDateEnd|default:"" }}',
        archivedDateStart: '{{ request.GET.archivedDateStart|default:"" }}',
        archivedDateEnd: '{{ request.GET.archivedDateEnd|default:"" }}',
        archiver: '{{ request.GET.archiver|default:"" }}'
    }
}">
    {# 1. 顶部筛选区域 #}
    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
        <div class="flex flex-wrap items-center gap-4">
            {# 记录类型 #}
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">记录类型：</label>
                <select x-model="filters.recordType" class="border text-sm border-slate-300 rounded-md focus:border-indigo-500 focus:ring-indigo-500 py-1">
                    <option value="all">全部</option>
                    <option value="门诊">门诊</option>
                    <option value="住院">住院</option>
                    <option value="复查">复查</option>
                </select>
            </div>

            {# 报告日期 #}
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">报告日期：</label>
                <div class="flex items-center gap-1">
                    <input type="date" x-model="filters.reportDateStart" class="border text-sm border-slate-300 rounded-md focus:border-indigo-500 focus:ring-indigo-500 py-1 w-32">
                    <span class="text-slate-400">-</span>
                    <input type="date" x-model="filters.reportDateEnd" class="border text-sm border-slate-300 rounded-md focus:border-indigo-500 focus:ring-indigo-500 py-1 w-32">
                </div>
            </div>

            {# 归档日期 #}
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">归档日期：</label>
                <div class="flex items-center gap-1">
                    <input type="date" x-model="filters.archivedDateStart" class="border text-sm border-slate-300 rounded-md focus:border-indigo-500 focus:ring-indigo-500 py-1 w-32">
                    <span class="text-slate-400">-</span>
                    <input type="date" x-model="filters.archivedDateEnd" class="border text-sm border-slate-300 rounded-md focus:border-indigo-500 focus:ring-indigo-500 py-1 w-32">
                </div>
            </div>

            {# 归档人 #}
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-slate-700">归档人：</label>
                <input type="text" placeholder="请输入姓名" x-model="filters.archiver" class="border text-sm border-slate-300 rounded-md focus:border-indigo-500 focus:ring-indigo-500 py-1 w-24">
            </div>
            
            {# 搜索按钮 #}
            <button class="px-4 py-1 bg-indigo-600 text-white rounded  text-sm font-medium transition-colors">
                搜索
            </button>
        </div>
    </div>

    {# 2. 功能按钮区 #}
    <div class="flex justify-end">
        <button 
            @click="$dispatch('open-add-record-modal', { type: '' })" 
            class="px-4 py-1.5 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition-colors flex items-center gap-1 shadow-sm"
        >
            <span class="text-lg leading-none">+</span> 新增记录
        </button>
    </div>

    {# 3. 表格列表展示 #}
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
        {# 表头 #}
        <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-slate-50 border-b border-slate-100 font-bold text-sm text-slate-700">
            <div class="col-span-2">记录类型</div>
            <div class="col-span-3">报告日期</div>
            <div class="col-span-2 text-center">图片数量</div>
            <div class="col-span-2 text-center">归档人</div>
            <div class="col-span-3 text-right pr-8">归档日期</div>
        </div>

        {# 列表内容 #}
        <div class="divide-y divide-slate-100">
            {% for report in reports_page %}
            <div data-event-id="{{ report.id }}" x-data="{ 
                expanded: false, 
                editing: false,
                saving: false,
                originalInterpretation: null,
                originalImageCats: null,
                eventId: {{ report.id }},
                deleteUrl: '{% url 'web_doctor:delete_consultation_record' patient.id report.id %}',
                recordType: '{{ report.record_type }}',
                subCategory: '{{ report.sub_category|default:'' }}',
                interpretation: '{{ report.interpretation|escapejs }}',
                
                // Constants for categories
                categories: ['门诊', '住院', '复查'],
                subcategories: {{ checkup_subcategories|safe|default:'[]' }},

                startEdit() {
                    if (this.saving) return;
                    this.originalInterpretation = this.interpretation;
                    this.originalImageCats = {};
                    const hiddenInputs = $el.querySelectorAll('input[type=hidden][data-image-id]');
                    hiddenInputs.forEach(input => {
                        this.originalImageCats[input.dataset.imageId] = input.value;
                    });
                    this.editing = true;
                },

                cancelEdit() {
                    if (this.saving) return;
                    if (this.originalInterpretation !== null) {
                        this.interpretation = this.originalInterpretation;
                    }
                    if (this.originalImageCats) {
                        const cards = $el.querySelectorAll('[data-image-card]');
                        cards.forEach(card => {
                            const imageId = card.dataset.imageCard;
                            if (!imageId) return;
                            if (!(imageId in this.originalImageCats)) return;
                            const hidden = card.querySelector('input[type=hidden][data-image-id]');
                            if (hidden) hidden.value = this.originalImageCats[imageId];
                            const select = card.querySelector('select[data-subcategory-select]');
                            if (select) {
                                const value = this.originalImageCats[imageId] || '';
                                const parts = value.split('-');
                                select.value = parts.length > 1 ? parts[1] : (parts[0] === '复查' ? '' : select.value);
                            }
                        });
                    }
                    this.editing = false;
                },

                async saveChanges() {
                    if (this.saving) return;
                    this.saving = true;
                    
                    const updates = [];
                    // 收集图片分类更新
                    const hiddenInputs = $el.querySelectorAll('input[type=hidden][data-image-id]');
                    hiddenInputs.forEach(input => {
                        const imageId = input.dataset.imageId;
                        const currentValue = input.value;
                        if (this.originalImageCats && imageId in this.originalImageCats) {
                            if (this.originalImageCats[imageId] === currentValue) return;
                        }
                        updates.push({ image_id: imageId, category: currentValue });
                    });

                    try {
                        const response = await fetch('{% url 'web_doctor:patient_report_update' patient.id report.id %}?page={{ history_page.number }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({ 
                                image_updates: updates,
                                record_type: this.recordType,
                                sub_category: this.subCategory,
                                interpretation: this.interpretation
                            })
                        });

                        if (response.ok) {
                            const html = await response.text();
                            const container = document.querySelector('#patient-content');
                            if (container) {
                                container.innerHTML = html;
                                htmx.process(container);
                            }
                            this.editing = false;
                        } else {
                            alert('保存失败，请重试');
                            this.saving = false;
                        }
                    } catch (error) {
                        console.error('Save failed:', error);
                        alert('网络错误，请重试');
                        this.saving = false;
                    }
                },
                
                confirmDelete() {
                    if (window.openConsultationRecordDeleteModal) {
                        window.openConsultationRecordDeleteModal({
                            eventId: this.eventId,
                            deleteUrl: this.deleteUrl
                        });
                    }
                }
            }" class="group transition-colors hover:bg-slate-50/50">
                
                {# 摘要行 (点击展开) #}
                <div class="grid grid-cols-12 gap-4 px-6 py-4 cursor-pointer items-center" @click="if(!editing) expanded = !expanded">
                    {# 记录类型列 #}
                    <div class="col-span-2 flex items-center gap-2">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium" 
                                  :class="{
                                      'text-green-600': recordType === '复查',
                                      'text-amber-500': recordType === '门诊',
                                      'text-purple-600': recordType === '住院'
                                  }">
                                <i class="fas fa-file-medical mr-1"></i>
                                <span x-text="recordType"></span>
                            </span>
                        </div>
                    </div>

                    <div class="col-span-3 text-sm text-slate-600">{{ report.date }}</div>
                    <div class="col-span-2 text-center text-sm text-slate-600">{{ report.image_count }}</div>
                    <div class="col-span-2 text-center text-sm text-slate-600">{{ report.archiver }}</div>
                    <div class="col-span-3 flex items-center justify-end gap-2 pr-2">
                        <span class="text-sm text-slate-600">{{ report.archived_date }}</span>
                        <button class="text-slate-400 hover:text-slate-600 ml-2 flex items-center group/btn" 
                                @click.stop="expanded = !expanded; if(!expanded) editing = false;">
                            <span class="text-xs mr-1" x-text="expanded ? '收起详情' : '展开详情'"></span>
                            <svg class="w-4 h-4 transition-transform duration-300 ease-in-out" 
                                 :class="expanded ? 'rotate-180' : ''"
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                {# 详情区域 (展开显示) #}
                <div x-show="expanded" 
                     x-collapse
                     class="px-6 pb-6 border-t border-slate-50 bg-slate-50/30"
                     style="display: none;">
                    
                    {# 图片列表 #}
                    <div class="flex flex-wrap gap-6 mt-4 mb-4">
                        {% for img in report.images %}
                        <div class="flex flex-col gap-2 w-[180px] relative" data-image-card="{{ img.id }}">
                            {% if report.record_type == '复查' %}
                              {% with img.category|cut:'复查-' as checkup_name %}
                                <input type="hidden" data-image-id="{{ img.id }}" value="复查-{% if checkup_name and checkup_name != '复查' %}{{ checkup_name }}{% else %}其他{% endif %}">
                              {% endwith %}
                            {% else %}
                              <input type="hidden" data-image-id="{{ img.id }}" value="{{ report.record_type }}">
                            {% endif %}
                            
                            {# 图片 #}
                            <div class="w-full h-[120px] relative bg-white rounded border border-slate-200 overflow-hidden cursor-pointer hover:shadow-md transition-shadow group/img"
                                 @click="$dispatch('show-preview', '{{ img.url }}')">
                                <img src="{{ img.url }}" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black/0 group-hover/img:bg-black/10 transition-colors flex items-center justify-center">
                                     <svg class="w-6 h-6 text-white opacity-0 group-hover/img:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                                </div>
                            </div>

                            {# 类目信息 #}
                            <div class="flex text-xs gap-1 items-center">
                                <span class="text-slate-500 font-medium shrink-0 mr-1">类目:</span>
                                {% if report.record_type == '复查' %}
                                  {% with img.category|cut:'复查-' as checkup_name %}
                                  <div class="flex-1 min-w-0">
                                    <div class="text-slate-700">复查</div>
                                    <div x-show="!editing" class="text-slate-700 break-words">{% if checkup_name and checkup_name != '复查' %}{{ checkup_name }}{% else %}其他{% endif %}</div>
                                    <select
                                      x-show="editing"
                                      data-subcategory-select
                                      class="mt-1 w-full border text-xs border-slate-300 rounded py-1 bg-white"
                                      @change="
                                        $el.closest('[data-image-card]').querySelector('input[type=hidden][data-image-id]').value = '复查-' + $event.target.value
                                      "
                                    >
                                      {% for sub in checkup_subcategories %}
                                        <option value="{{ sub }}" {% if checkup_name and checkup_name != '复查' and sub == checkup_name %}selected{% endif %}>{{ sub }}</option>
                                      {% endfor %}
                                    </select>
                                  </div>
                                  {% endwith %}
                                {% else %}
                                  <div class="flex-1 min-w-0 text-slate-700">{{ report.record_type }}</div>
                                {% endif %}
                            </div>
                            
                            {# 上传人信息 #}
                            <div class="text-slate-500 font-medium text-xs">
                                上传人: {{ report.uploader_info.name }}
                            </div>

                        </div>
                        {% endfor %}
                    </div>

                    {# 报告备注与解读 #}
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">报告备注与解读</label>
                        <textarea 
                            x-model="interpretation"
                            :disabled="!editing"
                            class="w-full text-sm p-3 border border-slate-200 rounded-lg bg-white focus:border-indigo-500 focus:ring-indigo-500 disabled:bg-slate-50 disabled:text-slate-500 resize-none"
                            rows="3"
                            placeholder="暂无解读内容..."
                        ></textarea>
                    </div>

                    {# 底部操作按钮 #}
                    <div class="flex justify-between items-center pt-2">
                        <button 
                            @click="confirmDelete"
                            class="px-4 py-1.5 bg-gray-400 text-white rounded-full text-sm hover:bg-gray-500 transition-colors"
                        >
                            删除此条档案
                        </button>

                        <div class="flex items-center gap-2">
                            <button 
                                x-show="editing"
                                @click="cancelEdit()"
                                class="px-6 py-1.5 rounded-full text-sm font-medium transition-colors shadow-sm bg-white border border-slate-300 text-slate-700 hover:bg-slate-50"
                                :disabled="saving"
                                style="display: none;"
                            >
                                取消
                            </button>
                            <button 
                                @click="if(editing) { saveChanges(); } else { startEdit(); }"
                                class="px-6 py-1.5 rounded-full text-sm font-medium transition-colors shadow-sm bg-blue-600 text-white hover:bg-blue-700"
                                :disabled="saving"
                            >
                                <span x-text="editing ? '保存' : '编辑'"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="p-8 text-center text-slate-500 text-sm">暂无诊疗记录</div>
            {% endfor %}
        </div>
    </div>
    
    {# 分页 (复用现有逻辑) #}
    {% if reports_page.paginator.num_pages > 1 %}
    <div class="flex items-center justify-center gap-2 mt-6">
        {% if reports_page.has_previous %}
        <button class="px-3 py-1 text-sm border border-slate-200 rounded hover:bg-slate-50" hx-get="{% url 'web_doctor:patient_workspace_section' patient.id 'reports' %}?tab=records&records_page={{ reports_page.previous_page_number }}&images_page={{ archives_page.number }}" hx-target="#patient-content">
            <
        </button>
        {% endif %}
        
        {% for i in reports_page.paginator.page_range %}
            <button 
                class="px-3 py-1 text-sm border rounded hover:bg-slate-50 {% if i == reports_page.number %}bg-slate-100 font-bold border-slate-300{% else %}border-slate-200{% endif %}" 
                hx-get="{% url 'web_doctor:patient_workspace_section' patient.id 'reports' %}?tab=records&records_page={{ i }}&images_page={{ archives_page.number }}" 
                hx-target="#patient-content">
                {{ i }}
            </button>
        {% endfor %}

        {% if reports_page.has_next %}
        <button class="px-3 py-1 text-sm border border-slate-200 rounded hover:bg-slate-50" hx-get="{% url 'web_doctor:patient_workspace_section' patient.id 'reports' %}?tab=records&records_page={{ reports_page.next_page_number }}&images_page={{ archives_page.number }}" hx-target="#patient-content">
            >
        </button>
        {% endif %}
    </div>
    {% endif %}
    
    <script>
      (function () {
        if (window.__consultationRecordsRefreshHooksInstalled) return;
        window.__consultationRecordsRefreshHooksInstalled = true;

        function showToast(message, type) {
          if (!message) return;
          var container = document.getElementById("consultation-records-toast");
          if (!container) {
            container = document.createElement("div");
            container.id = "consultation-records-toast";
            container.className =
              "fixed bottom-4 right-4 max-w-sm text-white text-sm px-3 py-2 rounded shadow-lg z-50";
            document.body.appendChild(container);
          }
          var bg = "bg-slate-800";
          if (type === "error") bg = "bg-rose-600";
          if (type === "success") bg = "bg-emerald-600";
          container.className =
            "fixed bottom-4 right-4 max-w-sm text-white text-sm px-3 py-2 rounded shadow-lg z-50 " + bg;
          container.textContent = message;
          container.style.display = "block";
          clearTimeout(container._hideTimer);
          container._hideTimer = setTimeout(function () {
            container.style.display = "none";
          }, 4000);
        }

        function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            var cookies = document.cookie.split(";");
            for (var i = 0; i < cookies.length; i++) {
              var cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }

        var deleting = false;
        var pendingDeleteUrl = "";
        var pendingDeleteEventId = null;

        function setDeleteModalOpen(open) {
          var modal = document.getElementById("consultation-delete-modal");
          if (!modal) return;
          if (open) {
            modal.classList.remove("hidden");
          } else {
            modal.classList.add("hidden");
          }
        }

        function setDeleteModalLoading(isLoading) {
          var confirmBtn = document.getElementById("consultation-delete-confirm-btn");
          var cancelBtn = document.getElementById("consultation-delete-cancel-btn");
          if (!confirmBtn || !cancelBtn) return;
          confirmBtn.disabled = isLoading;
          cancelBtn.disabled = isLoading;
          if (isLoading) {
            confirmBtn.dataset.prevText = confirmBtn.textContent;
            confirmBtn.textContent = "删除中...";
            confirmBtn.classList.add("opacity-60", "cursor-wait");
            cancelBtn.classList.add("opacity-60", "cursor-not-allowed");
          } else {
            confirmBtn.textContent = confirmBtn.dataset.prevText || "确定";
            confirmBtn.classList.remove("opacity-60", "cursor-wait");
            cancelBtn.classList.remove("opacity-60", "cursor-not-allowed");
          }
        }

        function closeConsultationRecordDeleteModal() {
          if (deleting) return;
          pendingDeleteUrl = "";
          pendingDeleteEventId = null;
          setDeleteModalOpen(false);
        }

        function openConsultationRecordDeleteModal(options) {
          var opts = options || {};
          pendingDeleteUrl = opts.deleteUrl || "";
          pendingDeleteEventId = opts.eventId;
          if (!pendingDeleteUrl || !pendingDeleteEventId) {
            showToast("删除参数缺失", "error");
            return;
          }
          setDeleteModalLoading(false);
          setDeleteModalOpen(true);
        }

        async function doDeleteConsultationRecord() {
          if (deleting) return;
          if (!pendingDeleteUrl || !pendingDeleteEventId) return;
          deleting = true;
          setDeleteModalLoading(true);
          try {
            var resp = await fetch(pendingDeleteUrl, {
              method: "POST",
              headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest",
              },
            });
            var data = await resp.json().catch(function () {
              return null;
            });
            if (!resp.ok || !data || data.status !== "success") {
              var msg = (data && data.message) || "删除失败，请稍后重试";
              showToast(msg, "error");
              return;
            }

            var row = document.querySelector('[data-event-id="' + pendingDeleteEventId + '"]');
            if (row) {
              row.style.transition = "all 0.2s";
              row.style.opacity = "0";
              row.style.transform = "scale(0.98)";
              setTimeout(function () {
                row.remove();
              }, 200);
            }

            document.body.dispatchEvent(new CustomEvent("refresh-records-list", { bubbles: true }));
            showToast("删除成功", "success");
            closeConsultationRecordDeleteModal();
          } catch (e) {
            showToast("网络异常，删除失败", "error");
          } finally {
            deleting = false;
            setDeleteModalLoading(false);
          }
        }

        window.openConsultationRecordDeleteModal = openConsultationRecordDeleteModal;

        function isRecordsRequest(event) {
          var root = document.getElementById("consultation-records-root");
          var detail = event.detail || {};
          var elt = detail.elt || event.target;
          if (!root || !elt || !root.contains(elt)) return false;
          return true;
        }

        document.body.addEventListener("htmx:responseError", function (event) {
          if (!isRecordsRequest(event)) return;
          showToast("列表刷新失败，请稍后重试", "error");
        });

        document.body.addEventListener("htmx:sendError", function (event) {
          if (!isRecordsRequest(event)) return;
          showToast("网络异常，列表刷新失败", "error");
        });

        document.body.addEventListener("htmx:afterSwap", function (event) {
          var pendingId = window.__pendingConsultationEventId;
          if (!pendingId) return;
          var target = event.detail && event.detail.target;
          if (!target || target.id !== "patient-content") return;

          var row = document.querySelector('[data-event-id="' + pendingId + '"]');
          if (!row) {
            showToast("已新增记录，但当前页未找到（可能受分页/筛选影响）", "error");
            window.__pendingConsultationEventId = null;
            return;
          }

          row.scrollIntoView({ block: "center" });
          row.classList.add("ring-2", "ring-emerald-400");
          setTimeout(function () {
            row.classList.remove("ring-2", "ring-emerald-400");
          }, 1200);
          window.__pendingConsultationEventId = null;
        });

        document.body.addEventListener("click", function (event) {
          var target = event.target;
          if (!target) return;
          if (target.id === "consultation-delete-modal") {
            closeConsultationRecordDeleteModal();
            return;
          }
          if (target.id === "consultation-delete-cancel-btn") {
            closeConsultationRecordDeleteModal();
            return;
          }
          if (target.id === "consultation-delete-confirm-btn") {
            doDeleteConsultationRecord();
            return;
          }
        });

        document.body.addEventListener("keydown", function (event) {
          if (event.key === "Escape") {
            closeConsultationRecordDeleteModal();
          }
        });
      })();
    </script>

    {# 包含 Modal 组件 #}
    {% include "web_doctor/partials/reports_history/add_record_modal.html" %}

    <div id="consultation-delete-modal" class="fixed inset-0 hidden" style="background: rgba(0,0,0,0.5);z-index: 9999;">
      <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-[320px] p-6 shadow-2xl flex flex-col items-center">
          <div class="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center mb-4">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </div>
          <h3 class="text-lg font-bold text-slate-800 mb-2 text-center">是否删除此条档案？</h3>
          <p class="text-sm text-slate-500 text-center mb-6 leading-relaxed">删除后数据无法恢复，请谨慎操作。</p>
          <div class="flex gap-3 w-full">
            <button id="consultation-delete-cancel-btn" type="button" class="flex-1 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-bold active:bg-slate-50 transition">
              取消
            </button>
            <button id="consultation-delete-confirm-btn" type="button" class="flex-1 py-2.5 rounded-xl bg-red-500 text-white font-bold shadow-lg shadow-red-200 active:scale-95 transition">
              确定
            </button>
          </div>
        </div>
      </div>
    </div>
</div>
