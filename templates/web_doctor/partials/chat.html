<div class="flex flex-col flex-1 min-h-0" 
     x-data="chatWidget()" 
     x-init="init()"
     @update-chat-patient.window="handlePatientSelect($event.detail)">
    
    <!-- 顶部标题栏 -->
    <div class="px-4 py-3 border-b border-slate-200 bg-slate-50/50 flex flex-col doctor-chat-header">
        <div class="flex flex-col">
            <h3 class="font-semibold text-slate-700 text-sm">在线沟通</h3>
            <span class="text-xs text-slate-400" x-text="currentUserInfo"></span>
        </div>
        
        <!-- Tab 切换 (仅在选中患者后显示) -->
         <div class="flex justify-center items-center mt-1">
        <div class="flex bg-slate-200 p-0.5 rounded-lg" x-show="patientId" style="display: none;">
            <button @click="switchTab('patient')" 
                    :class="{'bg-white shadow text-slate-700': activeTab === 'patient', 'text-slate-500 hover:text-slate-600': activeTab !== 'patient'}"
                    class="px-3 py-1 text-xs font-medium rounded-md transition-all duration-200">
                <span class="truncate" x-text="patientLabel">患者</span>
            </button>
            <button @click="switchTab('internal')" 
                    :class="{'bg-white shadow text-slate-700': activeTab === 'internal', 'text-slate-500 hover:text-slate-600': activeTab !== 'internal'}"
                    class=" px-3 py-1 text-xs font-medium rounded-md transition-all duration-200 ml-1 relative">
                <span class="truncate" x-text="internalLabel">内部会话</span>
                <!-- 未读红点 -->
                <span x-show="internalUnreadCount > 0 && activeTab !== 'internal'" 
                      x-transition:enter="transition ease-out duration-300"
                      x-transition:enter-start="transform scale-0 opacity-0"
                      x-transition:enter-end="transform scale-100 opacity-100"
                      class="absolute top-0 right-0 min-w-[16px] h-4 px-1 bg-red-500 text-white text-[10px] flex items-center justify-center rounded-full shadow-sm border border-white z-10"
                      x-text="internalUnreadCount > 99 ? '99+' : internalUnreadCount">
                </span>
            </button>
        </div>
        </div>
    </div>

    <!-- 空状态 -->
    <div x-show="!patientId" class="pt-10 flex-1 min-h-0 flex flex-col items-center justify-center text-slate-300 text-sm" data-test="empty-state">
        <svg class="w-12 h-12 mb-2 opacity-50" fill="#10b981" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
        请从左侧选择患者开始聊天
    </div>

    <!-- 聊天内容区域 -->
    <div x-show="patientId" class="flex flex-col flex-1 min-h-0 relative" style="display: none;">
        
        <!-- 消息列表 -->
        <div class="flex-1 min-h-0 overflow-y-auto overscroll-contain p-3 lg:p-4 2xl:p-5 space-y-4 doctor-chat-scroll" id="chat-messages-container" x-ref="messagesContainer">
            <template x-for="msg in messages" :key="msg.id">
                <div class="flex flex-col" :class="isMyMessage(msg) ? 'items-end' : 'items-start'">
                    <!-- 时间戳 (可选: 仅当时间间隔较大时显示) -->
                    <div class="text-xs text-slate-300 mb-1 text-center w-full" x-text="msg.created_at_display || formatTime(msg.created_at)"></div>
                    
                    <div class="flex max-w-[95%]" :class="isMyMessage(msg) ? 'flex-row-reverse' : 'flex-row'">
                        <!-- 头像/名字 -->
                        <div class="flex-shrink-0 flex flex-col items-center mx-2">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white"
                                 :class="getAvatarColor(msg.sender_role)">
                                <span x-text="msg.sender_name.substring(0, 1)"></span>
                            </div>
                            <span class="text-[10px] text-slate-400 mt-1 max-w-[4rem] truncate" x-text="msg.sender_name"></span>
                        </div>

                        <!-- 消息气泡 -->
                        <div class="px-4 py-2.5 rounded-2xl shadow-sm relative group border border-black/5"
                             :class="isMyMessage(msg) ? 'bg-emerald-500 text-white rounded-tr-none' : 'bg-white text-slate-800 rounded-tl-none'">
                            
                            <!-- 文本内容 -->
                            <p x-show="msg.content_type === 1" class="whitespace-pre-wrap break-words text-[15px] leading-6 2xl:text-base 2xl:leading-7" x-text="msg.text_content"></p>
                            
                            <!-- 图片内容 -->
                            <div x-show="msg.content_type === 2">
                                <img :src="msg.image_url" class="max-w-full rounded cursor-pointer" @click="window.open(msg.image_url, '_blank')">
                            </div>

                            <!-- 发送中状态 -->
                            <div x-show="msg.sending" class="absolute -left-6 top-1/2 -translate-y-1/2">
                                <svg class="animate-spin h-4 w-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
            
            <div x-show="messages.length === 0 && !loading" class="min-h-full flex flex-col items-center justify-center text-slate-300 text-sm py-8">
                <svg class="w-10 h-10 mb-2 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 10h8M8 14h5m-7 7l2.4-3.2A9 9 0 1 1 21 12a9 9 0 0 1-12.6 8.8L6 21z"></path>
                </svg>
                <div>暂无聊天记录</div>
            </div>
        </div>

        <!-- 底部输入栏 -->
        <div class="doctor-chat-input" x-show="canChat" style="display: none;">
        <div class="h-full p-3 border-t border-slate-100 bg-white">
            <div class="flex items-end gap-2 bg-slate-50 p-1 rounded-xl border border-slate-200 transition-all">
                <textarea 
                    x-model="inputText" 
                    @keydown.enter.prevent="if(!$event.shiftKey) sendMessage()"
                    class="flex-1 bg-transparent border-none outline-none p-1 text-sm 2xl:text-base focus:ring-0 resize-none max-h-24 min-h-[24px]" 
                    rows="1" 
                    placeholder="输入消息..."
                    data-test="chat-input"></textarea>
                
                <!-- 工具栏 -->
                <div class="flex items-center gap-1 pb-0.5 shrink-0">
                    <button @click="$refs.fileInput.click()" class="p-1.5 text-slate-400 hover:text-emerald-500 rounded-full hover:bg-slate-200 transition-colors" title="发送图片">
                        <svg class="w-5 h-5 2xl:w-6 2xl:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <input type="file" x-ref="fileInput" class="hidden" accept="image/*" @change="uploadImage($event)">
                    </button>
                    
                    <button @click="sendMessage()" 
                            :disabled="!inputText.trim()"
                            class="p-1.5 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
                            data-test="send-btn">
                        <svg class="w-4 h-4 2xl:w-5 2xl:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>

<style>
.doctor-chat-scroll {
  transition: height 180ms ease, max-height 180ms ease, min-height 180ms ease;
}
.doctor-chat-scroll {
  scrollbar-width: thin;
  scrollbar-color: rgb(148 163 184 / 0.9) transparent;
}
.doctor-chat-scroll::-webkit-scrollbar {
  width: 10px;
}
.doctor-chat-scroll::-webkit-scrollbar-track {
  background: transparent;
}
.doctor-chat-scroll::-webkit-scrollbar-thumb {
  background-color: rgb(148 163 184 / 0.8);
  border-radius: 9999px;
  border: 3px solid transparent;
  background-clip: content-box;
}
.doctor-chat-input {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100%;
  height: 70px;
  z-index: 20;
}
@media (max-height: 800px) {
  .doctor-chat-scroll {
    padding: 12px !important;
  }
}
</style>

<script>
function chatWidget() {
    return {
        patientId: null,
        patientName: '',
        activeTab: 'patient', // 'patient' or 'internal'
        patientLabel: '患者',
        internalLabel: '内部会话',
        internalUnreadCount: 0,
        isDirector: false,
        canChat: true,
        debugEnabled: false,
        
        conversations: {
            patient: null,
            internal: null
        },
        permissions: {
            patient: true,
            internal: true
        },
        
        messages: [],
        inputText: '',
        loading: false,
        pollInterval: null,
        currentUserInfo: '加载中...',
        currentUserId: {{ request.user.id }}, // Django 模板变量注入
        
        // 角色常量定义 (参考后端 choices)
        ROLES: {
            PATIENT: 1,
            FAMILY: 2,
            DIRECTOR: 3,
            PLATFORM_DOCTOR: 4,
            ASSISTANT: 5,
            CRC: 6
        },

        get currentConversationId() {
            return this.conversations[this.activeTab];
        },

        async init() {
            // 初始化时获取当前用户信息
            await this.fetchContext();
            this.debugEnabled = (window.localStorage && window.localStorage.getItem('doctorChatDebug') === '1');
            this.syncChatPermission('init');
            this.$watch('activeTab', () => this.syncChatPermission('activeTab'));
            this.$watch(() => JSON.stringify(this.permissions), () => this.syncChatPermission('permissions'));
            this.updateLayoutHeights();
            this._onResize = () => {
                this.updateLayoutHeights();
            };
            window.addEventListener('resize', this._onResize);
            
            // 监听图片上传按钮点击（通过 label 或 JS 触发 input 点击）
            // 上面的 input 已经绑定了 @change
        },

        async fetchContext(patientId = null) {
            try {
                let url = '/doctor/chat/api/context/';
                if (patientId) {
                    url += `?patient_id=${patientId}`;
                }
                const res = await fetch(url);
                const data = await res.json();
                if (data.status === 'success') {
                    const info = data.data;
                    this.currentUserInfo = `当前账号: ${info.user_name}(${info.role_label})`;
                    if (patientId) {
                        this.patientLabel = info.tab_patient_label;
                        this.internalLabel = info.tab_internal_label;
                        
                        this.conversations.patient = info.patient_conversation_id;
                        this.conversations.internal = info.internal_conversation_id;
                        
                        this.permissions = {
                            patient: !!info.can_send_patient,
                            internal: !!info.can_send_internal,
                        };
                        
                        // 设置未读数
                        this.internalUnreadCount = info.internal_unread_count || 0;
                        this.isDirector = !!(info.is_director ?? (info.role_label == '主任'));
                        this.syncChatPermission('fetchContext');
                        
                    }
                }
            } catch (e) {
                // Fallback
                const userType = "{{ request.user.user_type }}";
                const userName = "{{ request.user.display_name }}";
                this.currentUserInfo = `当前账号: ${userName}`;
            }
        },

        async handlePatientSelect(detail) {
            if (this.patientId === detail.id) return;
            
            this.patientId = detail.id;
            this.patientName = detail.name;
            this.activeTab = 'patient'; // 默认切回患者会话
            this.messages = [];
            
            // 获取新的上下文（包括动态的内部会话标签）
            await this.fetchContext(this.patientId);
            this.syncChatPermission('handlePatientSelect');
            
            this.$nextTick(() => {
                this.updateLayoutHeights();
            });
            this.loadMessages();
            this.startPolling();
        },

        switchTab(tab) {
            if (this.activeTab === tab) return;
            this.activeTab = tab;
            
            // 切换到内部会话时，清除未读
            if (tab === 'internal' && this.conversations.internal) {
                this.internalUnreadCount = 0;
                // 注意：真正的 markRead 会在 loadMessages 加载完后调用
            }
            
            this.messages = [];
            this.$nextTick(() => {
                this.syncChatPermission('switchTab');
                this.updateLayoutHeights();
                this.loadMessages();
            });
        },

        async loadMessages() {
            if (!this.patientId || !this.currentConversationId) {
                 this.messages = [];
                 return;
            }
            
            this.loading = true;
            try {
                const url = `/doctor/chat/api/messages/list/?conversation_id=${this.currentConversationId}`;
                const msgRes = await fetch(url);
                if (msgRes.status === 403) {
                    await this.fetchContext(this.patientId);
                    if (this.currentConversationId) {
                        const retryUrl = `/doctor/chat/api/messages/list/?conversation_id=${this.currentConversationId}`;
                        const retryRes = await fetch(retryUrl);
                        const retryData = await retryRes.json();
                        if (retryData.status === 'success') {
                            this.messages = retryData.messages;
                            this.scrollToBottom();
                            if (this.messages.length > 0) {
                                this.markRead(this.currentConversationId, this.messages[this.messages.length - 1].id);
                            }
                            return;
                        }
                    }
                }
                const msgData = await msgRes.json();
                
                if (msgData.status === 'success') {
                    this.messages = msgData.messages;
                    this.scrollToBottom();
                    // 标记已读
                    if (this.messages.length > 0) {
                        this.markRead(this.currentConversationId, this.messages[this.messages.length-1].id);
                    }
                }
            } catch (e) {
            } finally {
                this.loading = false;
            }
        },

        async sendMessage() {
            const content = this.inputText.trim();
            if (!content || !this.patientId) return;
            if (!this.canChat) {
                return;
            }

            // 乐观更新
            const tempMsg = {
                id: 'temp-' + Date.now(),
                sender_id: this.currentUserId,
                text_content: content,
                content_type: 1, // TEXT
                created_at: new Date().toISOString(),
                sender_name: '我',
                sender_role: this.ROLES.PLATFORM_DOCTOR, // 临时
                sending: true
            };
            this.messages.push(tempMsg);
            this.inputText = '';
            this.scrollToBottom();

            try {
                if (!this.currentConversationId) {
                    // 如果没有会话ID，可能需要后端支持通过 patient_id 发送，或者先创建
                    // 这里简化处理，提示错误
                    alert('会话未建立，无法发送');
                    this.messages.pop();
                    return;
                }

                const res = await fetch('/doctor/chat/api/messages/send/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        conversation_id: this.currentConversationId,
                        content: content
                    })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    // 替换临时消息
                    const index = this.messages.findIndex(m => m.id === tempMsg.id);
                    if (index !== -1) {
                        this.messages[index] = { ...tempMsg, ...data.message, sending: false };
                    }
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                this.messages.pop(); // 移除失败消息
                alert('发送失败: ' + e.message);
            }
        },

        startPolling() {
            if (this.pollInterval) clearInterval(this.pollInterval);
            this.pollInterval = setInterval(() => {
                if (this.currentConversationId) {
                    this.pollMessages();
                }
                // 如果是主任且在患者Tab，轮询内部会话未读数
                if (this.isDirector && this.activeTab === 'patient' && this.conversations.internal) {
                    this.pollUnreadCount();
                }
            }, 5000);
        },

        async pollUnreadCount() {
            try {
                const res = await fetch(`/doctor/chat/api/messages/unread-count/?conversation_id=${this.conversations.internal}`);
                if (res.status === 403) {
                    await this.fetchContext(this.patientId);
                    return;
                }
                const data = await res.json();
                if (data.status === 'success') {
                    this.internalUnreadCount = data.unread_count;
                }
            } catch (e) {
            }
        },

        async pollMessages() {
            // 获取最新一条消息ID
            const lastId = this.messages.length > 0 ? this.messages[this.messages.length - 1].id : null;
            if (!lastId || String(lastId).startsWith('temp')) return; // 只有临时消息时不轮询增量

            try {
                const url = `/doctor/chat/api/messages/list/?conversation_id=${this.currentConversationId}&after_id=${lastId}`;
                const res = await fetch(url);
                if (res.status === 403) {
                    await this.fetchContext(this.patientId);
                    return;
                }
                const data = await res.json();
                if (data.status === 'success' && data.messages.length > 0) {
                    // 过滤掉已存在的（以防万一）
                    const newMsgs = data.messages.filter(m => !this.messages.some(exist => exist.id === m.id));
                    if (newMsgs.length > 0) {
                        this.messages = [...this.messages, ...newMsgs];
                        this.scrollToBottom();
                        this.markRead(this.currentConversationId, newMsgs[newMsgs.length-1].id);
                    }
                }
            } catch (e) {
                console.error('轮询失败', e);
            }
        },
        
        async markRead(conversationId, lastMessageId) {
            if (!lastMessageId) return;
            try {
                await fetch('/doctor/chat/api/messages/read/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        conversation_id: conversationId,
                        last_message_id: lastMessageId
                    })
                });
            } catch (e) {}
        },

        scrollToBottom() {
            this.$nextTick(() => {
                const container = this.$refs.messagesContainer;
                container.scrollTop = container.scrollHeight;
            });
        },

       

        syncChatPermission(reason = '') {
            const next = !!this.permissions[this.activeTab];
            const changed = this.canChat !== next;
            this.canChat = next;
           
            if (changed) {
                this.$nextTick(() => this.updateLayoutHeights());
            }
        },

        updateLayoutHeights() {
            this.$nextTick(() => {
                const messagesEl = this.$refs.messagesContainer;
                if (!messagesEl) return;

                const viewportHeight = window.innerHeight || 0;
                const topNavEl = document.querySelector('header');
                const topNavHeight = topNavEl ? topNavEl.getBoundingClientRect().height : 64;

                const todoEl = document.getElementById('patient-todo-list');
                const todoHeight = todoEl ? todoEl.getBoundingClientRect().height : 0;

                const chatHeaderEl = this.$el.querySelector('.doctor-chat-header');
                const chatHeaderHeight = chatHeaderEl ? chatHeaderEl.getBoundingClientRect().height : 0;

                const rawRemainingHeight = viewportHeight - topNavHeight - todoHeight - chatHeaderHeight;
                let maxHeight = Math.max(240, Math.min(rawRemainingHeight, viewportHeight));
                if (maxHeight < 390) {
                    maxHeight = 280; 
                }

                if (maxHeight > 500) {
                    maxHeight = 440; 
                }
                
                messagesEl.style.maxHeight = `${maxHeight}px`;
                messagesEl.style.height = '';
                messagesEl.style.minHeight = '';
                const inputHeight = this.canChat ? 120 : 0;
                const safeGap = 16;
                messagesEl.style.setProperty('padding-bottom', `${inputHeight + safeGap}px`, 'important');
            });
        },

        isMyMessage(msg) {
            return msg.sender_id === this.currentUserId;
        },

        formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const pad = (n) => String(n).padStart(2, '0');
            const yyyy = date.getFullYear();
            const mm = pad(date.getMonth() + 1);
            const dd = pad(date.getDate());
            const hh = pad(date.getHours());
            const min = pad(date.getMinutes());
            return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
        },

        getAvatarColor(role) {
            // 根据角色返回背景色
            if (role === this.ROLES.PATIENT) return 'bg-blue-400';
            if (role === this.ROLES.FAMILY) return 'bg-indigo-400';
            if (role === this.ROLES.DIRECTOR) return 'bg-rose-500';
            return 'bg-emerald-500'; // 医生/助理
        },
        
        async uploadImage(event) {
             const file = event.target.files[0];
             if (!file) return;
             
             if (!this.currentConversationId) {
                 alert('会话未建立');
                 return;
             }
             
             const formData = new FormData();
             formData.append('conversation_id', this.currentConversationId);
             formData.append('image', file);
             formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
             
             // 乐观更新（略复杂，暂略）
             this.loading = true; // 简单loading
             
             try {
                 const res = await fetch('/doctor/chat/api/messages/upload/', {
                     method: 'POST',
                     body: formData
                 });
                 const data = await res.json();
                 if (data.status === 'success') {
                     this.messages.push({
                         ...data.message,
                         sender_id: this.currentUserId,
                         sender_name: '我',
                         content_type: 2
                     });
                     this.scrollToBottom();
                 } else {
                     alert(data.message);
                 }
             } catch(e) {
                 alert('上传失败');
             } finally {
                 this.loading = false;
                 event.target.value = ''; // 重置 input
             }
        }
    }
}
</script>
