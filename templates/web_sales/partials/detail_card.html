<div class="space-y-6">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 space-y-6">
      <div data-ws-card class="bg-white rounded-3xl shadow-xl border border-slate-200 p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3 min-w-0">
            <button
              type="button"
              class="ws-tap-target inline-flex items-center gap-1.5 px-3 py-2 rounded-xl text-slate-600 hover:text-slate-900 hover:bg-slate-100 bg-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-200 transition ws-active-bg"
              onclick="webSalesGoBackToDashboard()"
              aria-label="返回到首页"
              aria-keyshortcuts="Esc"
              title="返回首页（Esc）"
            >
              <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M11.78 15.53a.75.75 0 0 1-1.06 0l-5-5a.75.75 0 0 1 0-1.06l5-5a.75.75 0 1 1 1.06 1.06L7.31 9.25H16a.75.75 0 0 1 0 1.5H7.31l4.47 4.47a.75.75 0 0 1 0 1.06Z" clip-rule="evenodd" />
              </svg>
              <span class="text-sm font-medium">返回</span>
            </button>
            <div class="min-w-0">
              <p class="text-sm uppercase text-slate-400 tracking-widest">基础信息</p>
              <h2 data-ws-page-title class="text-xl font-semibold text-slate-900 mt-1 truncate">{{ patient.name }}</h2>
            </div>
          </div>
          <span class="inline-flex items-center px-3 py-1 rounded-full bg-sky-100 text-sky-600 text-sm">
            {{ patient.get_gender_display }}{% if patient.age %} · {{ patient.age }}岁{% endif %}
          </span>
        </div>
        <dl class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-600">
          <div>
            <dt class="text-slate-400">出生日期</dt>
            <dd class="font-medium text-slate-800">{{ patient.birth_date|date:"Y-m-d"|default:"-" }}</dd>
          </div>
          <div>
            <dt class="text-slate-400">联系电话</dt>
            <dd class="font-medium text-slate-800">{{ patient.phone }}</dd>
          </div>
          <div class="md:col-span-2">
            <dt class="text-slate-400">联系地址</dt>
            <dd class="font-medium text-slate-800">{{ patient.address|default:"-" }}</dd>
          </div>
          <div class="md:col-span-2">
            <dt class="text-slate-400">主治医生</dt>
            <dd class="font-medium text-slate-800 mt-2">
              <select
                name="doctor_id"
                class="ws-tap-target w-full md:w-2/3 rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100"
                hx-post="{% url 'web_sales:update_patient_doctor' patient.id %}"
                hx-trigger="change"
                hx-target="#doctor-update-toast"
                hx-swap="innerHTML"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
              >
                <option value="">暂未指定</option>
                {% for doctor in doctors %}
                <option value="{{ doctor.id }}" {% if patient.doctor_id == doctor.id %}selected{% endif %}>{{ doctor.name }}（{{ doctor.hospital|default:"-" }}）</option>
                {% endfor %}
              </select>
              <div id="doctor-update-toast" class="text-sm text-slate-400 mt-2"></div>
            </dd>
          </div>
        </dl>
      </div>

      <div data-ws-card class="bg-white rounded-3xl shadow-xl border border-slate-200 p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-sm uppercase text-slate-400 tracking-widest">紧急联系人</p>
            <h3 class="text-lg font-semibold text-slate-900">应急联系方案</h3>
          </div>
        </div>
        <dl class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-slate-600">
          <div>
            <dt class="text-slate-400">姓名</dt>
            <dd class="font-medium text-slate-800">{{ patient.ec_name|default:"-" }}</dd>
          </div>
          <div>
            <dt class="text-slate-400">关系</dt>
            <dd class="font-medium text-slate-800">{{ patient.ec_relation|default:"-" }}</dd>
          </div>
          <div>
            <dt class="text-slate-400">联系电话</dt>
            <dd class="font-medium text-slate-800">{{ patient.ec_phone|default:"-" }}</dd>
          </div>
        </dl>
      </div>
    </div>

    <div class="space-y-6">
      <div data-ws-card class="bg-white rounded-3xl shadow-xl border border-slate-200 p-6 flex flex-col items-center text-center">
        <h3 class="text-lg font-semibold text-slate-900 mb-2">绑定二维码</h3>
        <p class="text-sm text-slate-500 mb-6">患者扫码后即可绑定专属档案</p>
        {% if qrcode_url %}
        <div class="w-48 h-48 bg-slate-50 border border-slate-200 rounded-2xl flex items-center justify-center mb-4">
          <img src="{{ qrcode_url }}" alt="绑定二维码" class="w-44 h-44 object-contain">
        </div>
        {% else %}
        <div class="w-48 h-48 bg-slate-50 border border-dashed border-rose-200 rounded-2xl flex items-center justify-center mb-4 text-rose-500">
          <span>二维码生成失败</span>
        </div>
        <button
          type="button"
          class="ws-tap-target px-4 py-2 rounded-xl bg-rose-500 text-white text-sm hover:bg-rose-400 transition ws-active-bg"
          hx-get="{% url 'web_sales:patient_detail' patient.id %}"
          hx-target="#main-content-area"
          hx-swap="innerHTML"
        >
          重新获取
        </button>
        {% endif %}
        <p class="text-sm text-slate-400 mt-4">请患者或家属使用微信扫码绑定档案</p>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    if (window.__webSalesBackNavBound) return;
    window.__webSalesBackNavBound = true;

    window.webSalesGoBackToDashboard = function () {
      var dashboardUrl = "{% url 'web_sales:sales_dashboard' %}";
      var mainArea = document.getElementById('main-content-area');

      if (window.htmx && mainArea) {
        htmx.ajax('GET', dashboardUrl, { target: mainArea, swap: 'innerHTML' });
        return;
      }
      window.location.href = dashboardUrl;
    };

    window.addEventListener('keydown', function (event) {
      if (event.key !== 'Escape') return;
      var active = document.activeElement;
      if (
        active &&
        (active.tagName === 'INPUT' ||
          active.tagName === 'TEXTAREA' ||
          active.tagName === 'SELECT' ||
          active.isContentEditable)
      ) {
        return;
      }
      window.webSalesGoBackToDashboard();
    });
  })();
</script>
