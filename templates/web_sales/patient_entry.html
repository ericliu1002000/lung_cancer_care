{% extends "layouts/base_portal.html" %}
{% block body %}
<div class="min-h-screen bg-slate-50 flex flex-col">
  <header class="h-16 bg-white shadow border-b border-slate-200 flex items-center justify-between px-6">
    <div>
      <p class="text-xs uppercase text-slate-400 tracking-widest">录入中心</p>
      <h1 class="text-xl font-semibold text-slate-800">患者档案录入</h1>
    </div>
    <div class="flex items-center space-x-3">
      <a href="{% url 'web_sales:sales_dashboard' %}" class="text-sm text-slate-500 hover:text-slate-700">返回工作台</a>
      <a href="{% url 'web_sales:sales_dashboard' %}" class="px-4 py-2 rounded-lg bg-slate-800 text-white text-sm font-medium">Dashboard</a>
    </div>
  </header>
  <div class="flex-1 p-4 md:p-8">
    <form method="post" class="space-y-6" id="patient-entry-form">
      {% csrf_token %}
      <!-- 基础信息 -->
      <section class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-800">A. 基础信息</h2>
          <p class="text-xs text-slate-400">用于创建患者档案</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-slate-600">患者姓名 *</label>
            <input type="text" name="name" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="请输入姓名" required>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-600">性别 *</label>
            <div class="mt-2 flex items-center space-x-6">
              {% for value, label in gender_choices %}
              <label class="flex items-center space-x-2 text-sm text-slate-600">
                <input type="radio" name="gender" value="{{ value }}" class="text-blue-600 border-slate-300 focus:ring-blue-500" {% if forloop.first %}checked{% endif %}>
                <span>{{ label }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-600">出生年月</label>
            <div class="mt-1 flex items-center space-x-3">
              <input type="date" name="birth_date" class="flex-1 rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100">
              <span class="text-sm text-slate-500">年龄：<span id="age-preview">-</span></span>
            </div>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-600">联系电话 *</label>
            <input type="tel" name="phone" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="11 位手机号" required>
          </div>
          <div class="md:col-span-2">
            <label class="text-sm font-medium text-slate-600">联系地址</label>
            <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-3">
              <select name="address_province" id="province-select" class="rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100">
                <option value="">选择省份</option>
                {% for province in provinces %}
                <option value="{{ province.id }}">{{ province.name }}</option>
                {% endfor %}
              </select>
              <select name="address_city" id="city-select" class="rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100">
                <option value="">选择城市</option>
              </select>
              <input type="text" name="address_detail" class="rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="详细地址（街道/门牌）">
            </div>
          </div>
        </div>
      </section>

      <!-- 紧急联系人 -->
      <section class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-800">B. 紧急联系人</h2>
          <p class="text-xs text-slate-400">用于突发状况的第一联系人</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="text-sm font-medium text-slate-600">姓名</label>
            <input type="text" name="ec_name" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="王先生">
          </div>
          <div>
            <label class="text-sm font-medium text-slate-600">关系</label>
            <input type="text" name="ec_relation" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="配偶/子女">
          </div>
          <div>
            <label class="text-sm font-medium text-slate-600">联系电话</label>
            <input type="tel" name="ec_phone" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="紧急联系方式">
          </div>
        </div>
      </section>

      <!-- 病史概况 -->
      <section class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-800">C. 病史概况</h2>
          <p class="text-xs text-slate-400">记录最新诊疗信息</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-slate-600">临床诊断</label>
            <input type="text" name="diagnosis" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="如：肺腺癌">
          </div>
          <div>
            <label class="text-sm font-medium text-slate-600">病理类型</label>
            <input type="text" name="pathology" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="如：腺癌">
          </div>
          <div>
            <label class="text-sm font-medium text-slate-600">TNM 分期</label>
            <input type="text" name="tnm_stage" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="T2N1M0">
          </div>
          <div>
            <label class="text-sm font-medium text-slate-600">基因检测</label>
            <input type="text" name="gene_mutation" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="EGFR/L858R">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-slate-600">手术信息</label>
            <textarea name="surgery_info" rows="3" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="记录手术名称、日期、医生等"></textarea>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-600">既往病史</label>
            <textarea name="doctor_note" rows="3" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="糖尿病/高血压等"></textarea>
          </div>
        </div>
      </section>

      <!-- 危险因素 -->
      <section class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-800">D. 危险因素</h2>
          <p class="text-xs text-slate-400">选择患者具备的危险因素</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          {% for label in risk_options %}
          <label class="flex items-center space-x-2 rounded-2xl border border-slate-200 px-4 py-3 text-sm text-slate-700 hover:border-blue-400 transition">
            <input type="checkbox" name="risk_factors" value="{{ label }}" class="text-blue-600 border-slate-300 focus:ring-blue-500">
            <span>{{ label }}</span>
          </label>
          {% endfor %}
        </div>
      </section>

      <div class="flex items-center justify-end space-x-4">
        <button type="button" id="reset-draft" class="px-4 py-2 rounded-xl border border-slate-200 text-slate-600 hover:bg-slate-100">清空草稿</button>
        <button type="submit" class="px-6 py-2.5 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-500 shadow">保存档案</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function () {
    const form = document.getElementById("patient-entry-form");
    const STORAGE_KEY = "patient_entry_draft";
    const agePreview = document.getElementById("age-preview");
    const provinceSelect = document.getElementById("province-select");
    const citySelect = document.getElementById("city-select");
    const resetBtn = document.getElementById("reset-draft");

    const cityCache = {};

    function renderCityOptions(list, selectedId) {
      citySelect.innerHTML = '<option value="">选择城市</option>';
      list.forEach((city) => {
        const option = document.createElement("option");
        option.value = city.id;
        option.textContent = city.name;
        if (selectedId && String(city.id) === String(selectedId)) {
          option.selected = true;
        }
        citySelect.appendChild(option);
      });
    }

    function loadCities(provinceId, selectedCityId) {
      citySelect.innerHTML = '<option value="">选择城市</option>';
      if (!provinceId) {
        return Promise.resolve();
      }
      if (cityCache[provinceId]) {
        renderCityOptions(cityCache[provinceId], selectedCityId);
        return Promise.resolve();
      }
      return fetch(`/regions/api/provinces/${provinceId}/cities/`)
        .then((resp) => resp.ok ? resp.json() : Promise.reject())
        .then((data) => {
          const cities = data.results || [];
          cityCache[provinceId] = cities;
          renderCityOptions(cities, selectedCityId);
        })
        .catch(() => {
          citySelect.innerHTML = '<option value="">城市加载失败</option>';
        });
    }

    provinceSelect.addEventListener("change", () => {
      const provinceId = provinceSelect.value;
      loadCities(provinceId).then(triggerAutoSave);
    });

    const birthInput = form.querySelector('input[name="birth_date"]');
    birthInput.addEventListener("change", () => {
      const value = birthInput.value;
      if (!value) {
        agePreview.textContent = "-";
        return;
      }
      const birthDate = new Date(value);
      if (Number.isNaN(birthDate.getTime())) {
        agePreview.textContent = "-";
        return;
      }
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      agePreview.textContent = age >= 0 ? age : "-";
    });

    function serializeForm() {
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => {
        if (data[key]) {
          if (Array.isArray(data[key])) {
            data[key].push(value);
          } else {
            data[key] = [data[key], value];
          }
        } else {
          data[key] = value;
        }
      });
      return data;
    }

    function restoreDraft(data) {
      let pendingProvinceId = null;
      let pendingCityId = null;
      const entries = Object.entries(data);
      entries.forEach(([key, value]) => {
        if (key === "address_province") {
          provinceSelect.value = value;
          pendingProvinceId = value;
        } else if (key === "address_city") {
          pendingCityId = value;
        }
        const elements = form.elements[key];
        if (!elements) return;
        if (Array.isArray(value)) {
          value.forEach((val) => {
            const el = form.querySelector(`[name="${key}"][value="${val}"]`);
            if (el && (el.type === "checkbox" || el.type === "radio")) {
              el.checked = true;
            }
          });
        } else {
          if (elements.length && elements[0].type === "radio") {
            const radio = form.querySelector(`[name="${key}"][value="${value}"]`);
            if (radio) radio.checked = true;
          } else if (elements.type === "checkbox") {
            if (value === elements.value) elements.checked = true;
          } else {
            elements.value = value;
          }
        }
      });
      birthInput.dispatchEvent(new Event("change"));
      if (pendingProvinceId) {
        loadCities(pendingProvinceId, pendingCityId);
      }
    }

    function saveDraft() {
      const data = serializeForm();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    let saveTimer = null;
    function triggerAutoSave() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveDraft, 1000);
    }

    form.addEventListener("input", triggerAutoSave);
    form.addEventListener("change", triggerAutoSave);

    const draft = localStorage.getItem(STORAGE_KEY);
    if (draft) {
      try {
        const parsed = JSON.parse(draft);
        const shouldRestore = confirm("检测到未提交的草稿，是否恢复？");
        if (shouldRestore) {
          restoreDraft(parsed);
        } else {
          localStorage.removeItem(STORAGE_KEY);
        }
      } catch (_) {
        localStorage.removeItem(STORAGE_KEY);
      }
    }

    resetBtn.addEventListener("click", () => {
      if (confirm("确定清空当前表单草稿吗？")) {
        form.reset();
        agePreview.textContent = "-";
        provinceSelect.value = "";
        citySelect.innerHTML = '<option value="">选择城市</option>';
        localStorage.removeItem(STORAGE_KEY);
      }
    });

    form.addEventListener("submit", () => {
      localStorage.removeItem(STORAGE_KEY);
    });
  })();
</script>
{% endblock %}
