{% extends "layouts/base_portal.html" %}
{% load static %}
{% block title %}意见反馈{% endblock %}
{% block body %}
<div class="min-h-screen bg-slate-50 pb-24">
  <!-- <div class="sticky top-0 z-20 bg-slate-50/95 backdrop-blur border-b border-slate-200">
    <div class="max-w-3xl mx-auto flex items-center gap-4 px-4 py-4">
      <a href="{% url 'web_patient:patient_dashboard' %}" class="w-11 h-11 flex items-center justify-center rounded-full bg-white shadow text-slate-600">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 6l-6 6 6 6"/>
        </svg>
      </a>
      <div>
        <p class="text-sm text-slate-500">帮助与支持</p>
        <h1 class="text-2xl font-semibold text-slate-900">意见反馈</h1>
      </div>
    </div>
  </div> -->

  <form class="max-w-3xl mx-auto px-4 py-6 space-y-6" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <input type="hidden" name="feedback_type" id="id_feedback_type" value="{{ form.feedback_type.value|default:1 }}">

    <div class="bg-white rounded-3xl shadow-sm p-5">
      <div class="grid grid-cols-2 gap-3 text-lg font-semibold">
        <label class="feedback-tab" data-value="1">
          <input type="radio" name="feedback_type_tab" value="1" class="sr-only">
          <div class="tab-inner">
            <span>反馈问题</span>
          </div>
        </label>
        <label class="feedback-tab" data-value="2">
          <input type="radio" name="feedback_type_tab" value="2" class="sr-only">
          <div class="tab-inner">
            <span>提出建议</span>
          </div>
        </label>
      </div>
    </div>

    <div class="bg-white rounded-3xl shadow-sm p-5 space-y-3">
      <div class="flex items-center justify-between text-sm text-slate-500">
        <span>反馈内容</span>
        <span id="char-count">0/140</span>
      </div>
      {{ form.content }}
      {% if form.content.errors %}
      <p class="text-sm text-rose-500">{{ form.content.errors.0 }}</p>
      {% endif %}
    </div>

    <div class="bg-white rounded-3xl shadow-sm p-5 space-y-3">
      <div class="flex items-center justify-between text-sm text-slate-500">
        <span>上传图片（最多 4 张）</span>
        <span class="text-sm text-slate-400">帮助我们更快定位问题</span>
      </div>
      <div id="image-list" class="flex flex-wrap gap-4"></div>
    </div>

    <div class="bg-white rounded-3xl shadow-sm p-5 space-y-3">
      <label class="text-sm text-slate-500">联系方式（手机）</label>
      {{ form.contact_phone }}
      {% if form.contact_phone.errors %}
      <p class="text-sm text-rose-500">{{ form.contact_phone.errors.0 }}</p>
      {% endif %}
    </div>

    <div class="text-sm text-slate-500 px-2">我们会在 1-3 个工作日内通过您填写的联系方式与您沟通处理进展。</div>

    <div class="fixed bottom-0 left-0 right-0 bg-white/95 border-t border-slate-200 backdrop-blur z-30">
      <div class="max-w-3xl mx-auto px-4 py-4">
        <button type="submit" class="w-full h-14 rounded-2xl bg-sky-500 text-white text-lg font-semibold shadow-lg">提交反馈</button>
      </div>
    </div>
  </form>
</div>

<style>
  .feedback-tab .tab-inner {
    width: 100%;
    border-radius: 1rem;
    border: 1px solid rgb(226 232 240);
    text-align: center;
    padding: 0.75rem;
    background-color: rgb(248 250 252);
    color: rgb(100 116 139);
    transition: all 0.2s ease;
  }
  .feedback-tab.active .tab-inner {
    border-color: rgb(14 165 233);
    background-color: rgb(240 249 255);
    color: rgb(2 132 199);
  }
  .upload-slot {
    width: 7rem;
    height: 7rem;
    border-radius: 1rem;
    border: 2px dashed rgb(226 232 240);
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgb(248 250 252);
    cursor: pointer;
  }
  .slot-inner {
    text-align: center;
  }
  .preview-thumb {
    position: relative;
    width: 7rem;
    height: 7rem;
    border-radius: 1rem;
    overflow: hidden;
    background-color: rgb(248 250 252);
    box-shadow: 0 4px 6px -1px rgb(15 23 42 / 0.1);
  }
  .preview-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .preview-thumb button {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgb(15 23 42);
    color: white;
    font-size: 14px;
    line-height: 1;
  }
</style>

<script>
  const feedbackTypeInput = document.getElementById('id_feedback_type');
  const tabs = document.querySelectorAll('.feedback-tab');
  const charCountEl = document.getElementById('char-count');
  const textarea = document.getElementById('id_content');
  const imageList = document.getElementById('image-list');
  const maxImages = 4;

  function updateTabs(value) {
    tabs.forEach(tab => {
      if (tab.dataset.value === value) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });
    feedbackTypeInput.value = value;
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      updateTabs(tab.dataset.value);
    });
  });

  updateTabs(feedbackTypeInput.value || "1");

  function updateCharCount() {
    const length = textarea.value.trim().length;
    charCountEl.textContent = `${length}/140`;
  }
  textarea.addEventListener('input', updateCharCount);
  updateCharCount();

  function createUploadSlot() {
    const label = document.createElement('label');
    label.className = 'upload-slot';
    const input = document.createElement('input');
    input.type = 'file';
    input.name = 'images';
    input.accept = 'image/*';
    input.className = 'sr-only';
    input.addEventListener('change', handleImageSelect);
    const inner = document.createElement('div');
    inner.className = 'slot-inner';
    inner.innerHTML = `
      <svg class="w-8 h-8 text-slate-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14"/>
      </svg>
      <p class="text-sm text-slate-400 mt-1">添加图片</p>
    `;
    label.appendChild(input);
    label.appendChild(inner);
    return label;
  }

  function ensureUploadSlot() {
    const existingSlot = imageList.querySelector('.upload-slot');
    const previewCount = imageList.querySelectorAll('.preview-thumb').length;
    if (previewCount >= maxImages) {
      if (existingSlot) existingSlot.remove();
      return;
    }
    if (!existingSlot) {
      imageList.appendChild(createUploadSlot());
    }
  }

  function handleImageSelect(event) {
    const input = event.target;
    const file = input.files[0];
    if (!file || !file.type.startsWith('image/')) {
      input.value = "";
      return;
    }
    if (imageList.querySelectorAll('.preview-thumb').length >= maxImages) {
      input.value = "";
      return;
    }
    const wrapper = document.createElement('div');
    wrapper.className = 'preview-thumb';
    const img = document.createElement('img');
    const reader = new FileReader();
    reader.onload = (e) => {
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.setAttribute('aria-label', '删除图片');
    removeBtn.textContent = '×';
    removeBtn.addEventListener('click', () => {
      wrapper.remove();
      input.remove();
      ensureUploadSlot();
    });
    wrapper.appendChild(img);
    wrapper.appendChild(removeBtn);
    wrapper.appendChild(input);
    const slot = imageList.querySelector('.upload-slot');
    if (slot) {
      imageList.insertBefore(wrapper, slot);
      slot.remove();
    } else {
      imageList.appendChild(wrapper);
    }
    ensureUploadSlot();
  }

  ensureUploadSlot();
</script>
{% endblock %}
