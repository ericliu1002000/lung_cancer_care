{% extends "layouts/base_portal.html" %}

{% block body %}
<div class="min-h-screen bg-[#F5F7FA] flex flex-col">
    <!-- Header -->
    <div class="bg-white sticky top-0 z-30 border-b border-gray-100 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-3 flex items-center gap-3">
            <a href="javascript:history.back()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <h1 class="text-lg font-bold text-gray-900">新增报告</h1>
        </div>
    </div>

    <form id="upload-form" class="flex-1 flex flex-col max-w-4xl mx-auto w-full">
        {% csrf_token %}
        <div class="p-4 space-y-4 flex-1">
            <!-- Error/Status Message Area -->
            <div id="status-message" class="hidden w-full p-3 rounded-lg text-sm font-medium mb-4 text-center"></div>

            <!-- Date Input -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <label class="block text-sm font-medium text-gray-500 mb-2">上传日期</label>
                <div class="flex items-center border-gray-200 pb-1">
                    <input type="date" name="report_date" value="{{ today }}" class="w-full border p-2 rounded text-gray-900 focus:ring-blue-500 focus:border-blue-500 text-lg bg-transparent font-medium" required>
                </div>
            </div>

            <!-- Image Upload -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <p class="text-sm font-medium text-gray-500 mb-3">报告图片</p>
                <div class="grid grid-cols-3 sm:grid-cols-4 gap-3" id="image-preview-container">
                    <!-- Images will be inserted here -->
                    
                    <!-- Upload Button -->
                    <label class="aspect-square bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 transition active:scale-95 text-gray-400 hover:text-gray-600 hover:border-gray-300" id="upload-btn">
                        <svg class="w-8 h-8 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <input type="file" id="file-input" multiple accept="image/*" class="hidden" onchange="handleFileChange(event)">
                    </label>
                </div>
                <p class="text-xs text-gray-400 mt-3">支持上传多张图片，每张不超过 10MB</p>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="p-4 bg-white border-t border-gray-100 sticky bottom-0 z-20">
            <button type="button" onclick="submitReport()" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 active:scale-[0.98] transition flex items-center justify-center gap-2">
                <span>提交</span>
            </button>
        </div>
    </form>
</div>

<script>
// State to store uploaded files
let uploads = [];

// Image compression config
const COMPRESS_CONFIG = {
    maxWidth: 1920,
    maxHeight: 1920,
    quality: 0.8,
    type: 'image/jpeg'
};

// Compress image function
function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                let width = img.width;
                let height = img.height;
                
                // Calculate scale ratio
                if (width > COMPRESS_CONFIG.maxWidth || height > COMPRESS_CONFIG.maxHeight) {
                    const ratio = Math.max(width / COMPRESS_CONFIG.maxWidth, height / COMPRESS_CONFIG.maxHeight);
                    width = Math.floor(width / ratio);
                    height = Math.floor(height / ratio);
                } else {
                    width = Math.floor(width);
                    height = Math.floor(height);
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob(function(blob) {
                    if (!blob || blob.size > file.size) {
                        resolve(file);
                    } else {
                        const newFile = new File([blob], file.name, {
                            type: COMPRESS_CONFIG.type,
                            lastModified: Date.now()
                        });
                        resolve(newFile);
                    }
                }, COMPRESS_CONFIG.type, COMPRESS_CONFIG.quality);
            };
            img.onerror = function(err) {
                console.warn('Image load failed, using original file', err);
                resolve(file);
            };
        };
        reader.onerror = function(err) {
            console.warn('FileReader failed, using original file', err);
            resolve(file);
        };
    });
}

function handleFileChange(event) {
    const fileList = event.target.files;
    if (!fileList || fileList.length === 0) return;
    
    const files = Array.from(fileList);
    event.target.value = ''; // Reset input
    
    showStatus('正在处理图片...', 'info');

    const processPromises = files.map(async file => {
        if (!file.type.startsWith('image/')) {
            showStatus(`文件 ${file.name} 格式不支持`, 'error');
            return null;
        }

        if (file.size > 20 * 1024 * 1024) {
             showStatus(`文件 ${file.name} 超过20MB限制`, 'error');
             return null;
        }

        try {
            const compressedFile = await compressImage(file);
            const fileId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            uploads.push({ id: fileId, file: compressedFile });
            
            const previewUrl = URL.createObjectURL(compressedFile);
            addPreviewElement(previewUrl, fileId);
            
            return fileId;
        } catch (err) {
            console.error('Image processing error:', err);
            showStatus(`图片 ${file.name} 处理失败`, 'error');
            return null;
        }
    });

    Promise.all(processPromises).then(() => {
        const statusEl = document.getElementById('status-message');
        if (statusEl && statusEl.textContent === '正在处理图片...') {
             statusEl.classList.add('hidden');
        }
    });
}

function addPreviewElement(url, fileId) {
    const container = document.getElementById('image-preview-container');
    const uploadBtn = document.getElementById('upload-btn');
    
    const div = document.createElement('div');
    div.id = `preview-${fileId}`;
    div.className = 'aspect-square bg-gray-100 rounded-xl overflow-hidden relative group border border-gray-200';
    
    const img = document.createElement('img');
    img.src = url;
    img.className = 'w-full h-full object-cover';
    
    // Delete Button
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'absolute top-2 right-2 w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center opacity-90 hover:opacity-100 hover:scale-110 transition-all shadow-md z-10';
    deleteBtn.innerHTML = '<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
    deleteBtn.onclick = function(e) {
        e.stopPropagation();
        removeFile(fileId);
    };
    
    div.appendChild(img);
    div.appendChild(deleteBtn);
    
    container.insertBefore(div, uploadBtn);
}

function removeFile(fileId) {
    if (confirm("确定要移除这张图片吗？")) {
        uploads = uploads.filter(item => item.id !== fileId);
        const wrapper = document.getElementById(`preview-${fileId}`);
        if (wrapper) {
            const img = wrapper.querySelector('img');
            if (img && img.src) URL.revokeObjectURL(img.src);
            wrapper.remove();
        }
    }
}

function submitReport() {
    if (uploads.length === 0) {
        alert("请至少上传一张图片");
        return;
    }
    
    const reportDate = document.querySelector('input[name="report_date"]').value;
    if (!reportDate) {
        alert("请选择上传日期");
        return;
    }

    const formData = new FormData();
    formData.append('report_date', reportDate);
    
    uploads.forEach(u => {
        formData.append('images', u.file);
    });
    
    const submitBtn = document.querySelector('button[onclick="submitReport()"]');
    const originalText = submitBtn.innerText;
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        提交中...
    `;

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("{% url 'web_patient:report_upload' %}", {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        // Handle JSON response if we changed view to return JSON (which we haven't strictly, but redirect works via 302)
        // Actually, fetch follows redirects automatically. 
        // If the view returns redirect, fetch follows it and returns the page content of list page.
        // We should check response.url
        if (response.ok) {
            showStatus('上传成功', 'success');
            
            // 设置刷新标志，用于上一页数据刷新
            localStorage.setItem('refresh_report_list', 'true');
            
            setTimeout(() => {
                // 优先返回上一页
                if (document.referrer && document.referrer.includes(window.location.host)) {
                    history.back();
                } else {
                    window.location.href = "{% url 'web_patient:report_list' %}";
                }
            }, 500);
        } else {
            throw new Error('Upload failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showStatus('上传失败，请重试', 'error');
        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
    });
}

function showStatus(message, type) {
    const statusEl = document.getElementById('status-message');
    statusEl.textContent = message;
    statusEl.className = `w-full p-3 rounded-lg text-sm font-medium mb-4 text-center ${
        type === 'error' ? 'bg-red-100 text-red-700 border border-red-200' : 
        type === 'success' ? 'bg-green-100 text-green-700 border border-green-200' : 
        'bg-blue-100 text-blue-700 border border-blue-200'
    }`;
    statusEl.classList.remove('hidden');
    
    if (type !== 'info') {
        setTimeout(() => {
            statusEl.classList.add('hidden');
        }, 3000);
    }
}
</script>
{% endblock %}
