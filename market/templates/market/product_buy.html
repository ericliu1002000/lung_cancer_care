{% extends "layouts/base_portal.html" %}
{% block title %}购买服务包{% endblock %}
{% block body %}
<div class="min-h-screen bg-slate-50 pb-24">
  <!-- 顶部 Banner -->
  <div class="bg-gradient-to-r from-amber-100 via-orange-50 to-amber-100">
    <div class="max-w-3xl mx-auto px-4 py-6 flex items-center gap-4">
      <div class="flex-1 space-y-3">
        <p class="text-sm font-semibold text-amber-700 tracking-wide">肺癌院外康复管理服务包</p>
        <h1 class="text-2xl md:text-3xl font-bold text-slate-900">{{ product.name }}</h1>
        <div class="flex flex-wrap items-center gap-3">
          <span class="inline-flex items-center px-3 py-1 rounded-full bg-amber-50 text-amber-700 text-sm font-medium">
            服务有效期：{{ product.duration_days }} 天
          </span>
          <span class="inline-flex items-baseline gap-1 text-rose-600">
            <span class="text-sm">￥</span>
            <span class="text-2xl font-semibold leading-none">{{ product.price }}</span>
          </span>
        </div>
      </div>
      <div class="hidden sm:block w-24 h-24 rounded-3xl bg-white/60 shadow-inner flex items-center justify-center">
        <!-- 肺部插画占位 -->
        <svg class="w-14 h-14 text-amber-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15M15 4.5v15"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 9C6.5 7 3.5 7 3 10.5 2.5 14 4 16 6 17.5M15 9c2.5-2 5.5-2 6 1.5.5 3.5-1 5.5-3 7"/>
        </svg>
      </div>
    </div>
  </div>

  <div class="max-w-3xl mx-auto px-4 py-6 space-y-6">
    <!-- 服务包内容 -->
    <section class="bg-white rounded-3xl shadow-sm p-6 space-y-4">
      <h2 class="text-xl font-semibold text-slate-900">服务包内容</h2>
      <div class="rounded-2xl bg-sky-50 px-4 py-4 text-[15px] md:text-[16px] leading-relaxed text-slate-800">
        <div class="prose prose-slate max-w-none">
          {{ service_html|safe }}
        </div>
      </div>
    </section>

    <!-- 协议勾选 -->
    <section class="bg-white rounded-3xl shadow-sm p-5">
      <label class="flex items-start gap-3 cursor-pointer select-none">
        <input id="agree-checkbox" type="checkbox" class="mt-1 w-5 h-5 rounded border-slate-300 text-sky-600 focus:ring-sky-500">
        <span class="text-sm md:text-base text-slate-700 leading-relaxed">
          我已完整阅读并同意
          <a href="{{ urls.user_policy }}" class="text-sky-600 underline underline-offset-2" target="_blank">《用户须知》</a>、
          <a href="{{ urls.privacy_policy }}" class="text-sky-600 underline underline-offset-2" target="_blank">《隐私协议》</a>、
          <a href="{{ urls.consent }}" class="text-sky-600 underline underline-offset-2" target="_blank">《知情同意书》</a>、
          <a href="{{ urls.member_agreement }}" class="text-sky-600 underline underline-offset-2" target="_blank">《会员服务协议》</a>
        </span>
      </label>
      <p class="mt-3 text-sm text-slate-400">
        为保障您的知情权和隐私安全，请在支付前认真阅读以上协议内容。
      </p>
    </section>
  </div>

  <!-- 底部操作栏 -->
  <div class="fixed bottom-0 left-0 right-0 bg-white/95 border-t border-slate-200 backdrop-blur z-30">
    <div class="max-w-3xl mx-auto px-4 py-4 flex items-center gap-4">
      <div class="flex-1">
        <p class="text-sm text-slate-500">支付前请确认已阅读并同意所有服务协议</p>
      </div>
      <button
        id="buy-btn"
        class="w-40 h-12 rounded-2xl bg-emerald-500 text-white text-base font-semibold shadow-lg disabled:opacity-60 disabled:cursor-not-allowed"
        onclick="startPurchase()"
      >
        立即购买
      </button>
    </div>
  </div>
</div>

<script>
  const CREATE_ORDER_URL = "{% url 'market:create_order_api' %}";
  const PRODUCT_ID = {{ product.id }};

  function isWeChat() {
    const ua = navigator.userAgent.toLowerCase();
    return ua.indexOf('micromessenger') !== -1;
  }

  function getCsrfToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : '';
  }

  function showAlert(message) {
    if (window.alert) {
      alert(message);
    }
  }

  function startPurchase() {
    const agree = document.getElementById('agree-checkbox');
    if (!agree.checked) {
      showAlert('请先阅读并勾选同意所有协议后再购买。');
      return;
    }

    if (!isWeChat()) {
      showAlert('请在微信内打开本页面完成支付。');
      return;
    }

    const btn = document.getElementById('buy-btn');
    if (btn.disabled) return;
    btn.disabled = true;
    btn.textContent = '创建订单中...';

    fetch(CREATE_ORDER_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken(),
      },
      body: JSON.stringify({ product_id: PRODUCT_ID }),
      credentials: 'same-origin',
    })
      .then(res => res.json())
      .then(data => {
        if (data.code !== 200) {
          throw new Error(data.message || '创建订单失败');
        }
        const payParams = data.data.pay_params;
        invokeWeChatPay(payParams);
      })
      .catch(err => {
        console.error(err);
        showAlert(err.message || '创建订单失败，请稍后重试');
        btn.disabled = false;
        btn.textContent = '立即购买';
      });
  }

  function invokeWeChatPay(params) {
    function onBridgeReady() {
      WeixinJSBridge.invoke(
        'getBrandWCPayRequest',
        {
          appId: params.appId,
          timeStamp: params.timeStamp,
          nonceStr: params.nonceStr,
          package: params.package,
          signType: params.signType,
          paySign: params.paySign,
        },
        function (res) {
          if (res.err_msg === 'get_brand_wcpay_request:ok') {
            showAlert('支付成功，感谢您的信任！');
            window.location.href = '/p/orders/';
          } else if (res.err_msg === 'get_brand_wcpay_request:cancel') {
            showAlert('您已取消支付，如需继续请再次发起。');
          } else {
            showAlert('支付未完成：' + (res.err_msg || '未知错误'));
          }
          const btn = document.getElementById('buy-btn');
          btn.disabled = false;
          btn.textContent = '立即购买';
        }
      );
    }

    if (typeof WeixinJSBridge === 'undefined') {
      if (document.addEventListener) {
        document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
      } else if (document.attachEvent) {
        document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
        document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
      }
    } else {
      onBridgeReady();
    }
  }
</script>
{% endblock %}

