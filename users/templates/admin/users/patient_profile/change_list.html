{% extends "admin/change_list.html" %}
{% load admin_list i18n static %}

{% block extrastyle %}
{{ block.super }}
<style>
  /* --- 1. å¸ƒå±€å®¹å™¨ (æ›¿ä»£ Bootstrap Grid) --- */
  .layout-container {
    display: flex;
    gap: 20px;
    align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
  }
  
  .layout-main {
    flex: 3; /* å·¦ä¾§å  3 ä»½ (çº¦ 75%) */
    min-width: 0; /* é˜²æ­¢è¡¨æ ¼æ’‘çˆ†å®¹å™¨ */
  }
  
  .layout-sidebar {
    flex: 1; /* å³ä¾§å  1 ä»½ (çº¦ 25%) */
    position: sticky;
    top: 20px; /* ç®€å•çš„å¸é¡¶æ•ˆæœ */
  }

  /* --- 2. å¡ç‰‡æ ·å¼ (æ›¿ä»£ Bootstrap Card) --- */
  .custom-card {
    background: var(--body-bg, #fff); /* é€‚é… Django æ·±è‰²æ¨¡å¼å˜é‡ */
    border: 1px solid var(--hairline-color, #ccc);
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    padding: 15px;
  }
  
  .card-body {
    width: 100%;
  }

  /* --- 3. ç­›é€‰è¡¨å•æ ·å¼ (æ›¿ä»£ Bootstrap Form) --- */
  .filter-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* è‡ªåŠ¨å“åº”å¼åˆ— */
    gap: 15px;
    align-items: end; /* åº•éƒ¨å¯¹é½ï¼Œä¸ºäº†æŒ‰é’® */
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
  }
  
  .form-group label {
    font-weight: bold;
    margin-bottom: 5px;
    color: var(--body-fg, #333);
  }
  
  .form-group input, 
  .form-group select {
    padding: 6px 8px;
    border: 1px solid var(--border-color, #ccc);
    border-radius: 4px;
    width: 100%;
    box-sizing: border-box;
  }

  /* --- 4. æŒ‰é’®æ ·å¼ (å¤ç”¨ Django Admin åŸç”Ÿæ ·å¼) --- */
  .btn-actions {
    grid-column: 1 / -1; /* æŒ‰é’®å æ»¡ä¸€è¡Œ */
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
  }
  
  /* å¼ºåˆ¶ä¿®æ­£ Django Admin è¡¨æ ¼åœ¨ flex å®¹å™¨ä¸­çš„å®½åº¦ */
  .results table {
    width: 100%;
  }
</style>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block change_list %}
<div class="layout-container">
  
  <div class="layout-main">
    
    <div class="custom-card">
      <form method="get" class="filter-form-grid">
        
        <div class="form-group">
          {{ filter_form.q.label_tag }}
          {{ filter_form.q }}
        </div>
        <div class="form-group">
          {{ filter_form.gender.label_tag }}
          {{ filter_form.gender }}
        </div>
        
        <div class="form-group">
          {{ filter_form.doctor_name.label_tag }}
          {{ filter_form.doctor_name }}
        </div>
        <div class="form-group">
          {{ filter_form.sales_name.label_tag }}
          {{ filter_form.sales_name }}
        </div>

        <div class="form-group">
          {{ filter_form.birth_start.label_tag }}
          {{ filter_form.birth_start }}
        </div>
        <div class="form-group">
          {{ filter_form.birth_end.label_tag }}
          {{ filter_form.birth_end }}
        </div>

        <div class="form-group">
          {{ filter_form.date_range_start.label_tag }}
          {{ filter_form.date_range_start }}
        </div>
        <div class="form-group">
          {{ filter_form.date_range_end.label_tag }}
          {{ filter_form.date_range_end }}
        </div>

        <div class="form-group">
          {{ filter_form.purchase_start.label_tag }}
          {{ filter_form.purchase_start }}
        </div>
        <div class="form-group">
          {{ filter_form.purchase_end.label_tag }}
          {{ filter_form.purchase_end }}
        </div>

        <div class="btn-actions">
          <input type="submit" value="ç­›é€‰" class="button button-primary" style="padding: 8px 20px;">
          <a href="{{ request.path }}" class="button" style="padding: 8px 20px; line-height: 15px;">é‡ç½®</a>
        </div>
      </form>
    </div>

    <div class="custom-card" id="patient-table-wrapper">
      {% result_list cl %}
      
      {# åˆ†é¡µå™¨ #}
      {% pagination cl %}
    </div>
  </div>

  <div class="layout-sidebar">
    <div id="patient-detail-panel" class="custom-card" style="min-height: 300px;">
      <div style="color: #666; text-align: center; margin-top: 50px;">
        <p>ğŸ‘‰ è¯·ç‚¹å‡»å·¦ä¾§åˆ—è¡¨æŸ¥çœ‹è¯¦æƒ…</p>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
(function() {
  const previewBase = "{{ preview_url_base|default:''|escapejs }}";
  function initPatientRows() {
    // æ³¨æ„ï¼šDjango Admin è¡¨æ ¼è¡Œé€šå¸¸æ˜¯ .row1, .row2ï¼Œè¿™é‡Œé€‰æ‹©å™¨éœ€é€šç”¨
    const rows = document.querySelectorAll('#result_list tbody tr');
    rows.forEach(function(row) {
      // æŸ¥æ‰¾ checkbox æˆ– link è·å– IDï¼ŒDjango admin é€šå¸¸åœ¨ tr ä¸Šæ²¡æœ‰ç›´æ¥çš„ data-id
      // æˆ‘ä»¬éœ€è¦ä¾èµ–ä¹‹å‰æç¤ºè¯é‡Œè®© AI ç”Ÿæˆçš„ data-object-idï¼Œæˆ–è€…ä»ç¬¬ä¸€åˆ—çš„ checkbox value è·å–
      
      // å°è¯•ä» checkbox è·å– ID (è¿™æ˜¯ Django admin çš„æ ‡å‡†ç»“æ„)
      let pk = null;
      const checkbox = row.querySelector('.action-select');
      if (checkbox) {
          pk = checkbox.value;
      } else {
          // å¦‚æœæ²¡æœ‰ checkboxï¼Œå°è¯•ä»ç¬¬ä¸€åˆ—é“¾æ¥è·å– ID
          const firstLink = row.querySelector('th.field-name a, td.field-name a, th a');
          if (firstLink) {
              const match = firstLink.getAttribute('href').match(/(\d+)\/change/);
              if (match) pk = match[1];
          }
      }

      if (!pk || !previewBase) return;

      row.setAttribute('hx-get', `${previewBase}/${pk}/`); // ç¡®ä¿ URL æ ¼å¼æ­£ç¡®
      row.setAttribute('hx-target', '#patient-detail-panel');
      row.setAttribute('hx-swap', 'innerHTML');
      row.style.cursor = 'pointer';
      
      // é¿å…ç‚¹å‡» checkbox æ—¶è§¦å‘ HTMX
      row.querySelectorAll('input, a').forEach(el => {
          el.addEventListener('click', e => e.stopPropagation());
      });
    });
    
    // å¦‚æœ htmx æ²¡åŠ è½½ï¼Œå¤„ç†ä¸€ä¸‹
    if (window.htmx) {
        htmx.process(document.querySelector('#result_list'));
    }
  }

  document.addEventListener('DOMContentLoaded', initPatientRows);
  // ç›‘å¬ HTMX äº¤æ¢åçš„äº‹ä»¶ï¼ˆå¦‚æœæ˜¯ Ajax ç¿»é¡µï¼‰- Django Admin é»˜è®¤ä¸æ˜¯ Ajax ç¿»é¡µï¼Œ
  // ä½†å¦‚æœä½ å°†æ¥åšäº† Ajax ç¿»é¡µï¼Œè¿™ä¸ªç›‘å¬å¾ˆæœ‰ç”¨
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.target && evt.target.id === 'patient-table-wrapper') {
      initPatientRows();
    }
  });
})();
</script>
{% endblock %}